%$Id$
\documentclass[a4paper,12pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{pslatex}
\usepackage{eurosym}
\usepackage{amssymb}
\usepackage{latexsym}
\usepackage[dvips]{graphicx}
\usepackage{delarray}
\usepackage{amsmath}
%\usepackage{bbm}
%\usepackage{bbold}
%\usepackage{accents}
\usepackage{subfigure}
\usepackage{multirow}
\usepackage{fancyhdr}
%\usepackage{tocbibind}
%\usepackage{bibtex}
\usepackage{wrapfig}
\usepackage{color}
\usepackage{hyperref}
%\usepackage{fmtcount}
\usepackage{parskip}
\frenchspacing

\graphicspath{{./fig/}{./png/}}

\setlength{\hoffset}{-1in}
\setlength{\textwidth}{7.5in}
\setlength{\voffset}{-0.5in}
\setlength{\textheight}{9.5in}

\title{Pencil Code: Quick Start guide}

\author{Illa R. Losada, Michiel Lambrechts, Elizabeth Cole, Philippe Bourdin}


\begin{document}
\maketitle

\tableofcontents

\newpage


\section{Download the Pencil Code}
The Pencil Code is an open source code written mainly in \verb|Fortran| and available under GPL.
General information can be found at our official homepage:

\url{http://pencil-code.nordita.org/}.

The latest version of the code can be downloaded with \verb|svn|. In the
directory where you want to put the code, type:
\begin{verbatim}
svn checkout http://pencil-code.googlecode.com/svn/trunk/ pencil-code
\end{verbatim}

The downloaded \verb|pencil-code| directory contains several sub-directories
\begin{enumerate}
  \item \verb|doc|: a very important directory containing the pencil-code
    \verb|manual.tex|. The pdf of the latest version of the manual is created
    simply by typing \verb|make| in the \verb|pencil-code/doc| directory. For
    example, the code structure can be further explored in Section 4 of the
    manual.
  \item \verb|samples|: contains many sample problems
  \item \verb|config|: has all the configuration files
  \item \dots
\end{enumerate}


\section{Configure the shell}

For a quick start, you need to load some environment variable into your shell.
First, you enter to the freshly downloaded directory:

\begin{verbatim}
  cd pencil-code
\end{verbatim}

Depending on which shell you use, you can do that by a simple command:

\begin{verbatim}
  . sourceme.sh
\end{verbatim}

that will work for \verb|bash| and all \verb|sh|-compatible shells, while this command:

\begin{verbatim}
  source sourceme.csh
\end{verbatim}

is for \verb|tcsh| and any \verb|csh|-compatible shell.


\section{Fortran}

A \verb|Fortran| and a \verb|C| compiler are needed to compile the code.
Both compilers should belong to the same distribution package and version (e.g. GNU GCC 4.8.3, 64 bit Linux).

\subsection{Fortran on a mac machine}
For Mac, you first need to install \verb|Xcode| from the \verb|AppleDeveloper|
site \url{http://developer.apple.com/}. This requires you to first register as a
member. An easy to install \verb|gfortran| can be found at \newline
\url{http://gcc.gnu.org/wiki/GFortranBinaries}. Just download it and it comes
with an installer. It installs in the directory \verb|/usr/local/gfortran| with
a symbolic link in \verb|/usr/local/bin/gfortran|. It might be necessary to add
the following line in the \verb|.cshrc|-file in the home folder:
\begin{verbatim} 
  setenv PATH /usr/local/bin:\$PATH 
\end{verbatim}


\section{Try a sample}

Go to a folder that contains one of the many available samples, e.g.:

\begin{verbatim}
  cd samples/1d-tests/jeans-x
\end{verbatim}

You may also start with a fresh directory and copy over the files from one of the samples.

\subsection{Setting up...}

One command sets up all needed symbolic links to the original Pencil Code directory:

\begin{verbatim}
  pc_setupsrc
\end{verbatim}

\subsection{Makefile}

Two basic configuration files define a simulation setup: \verb|src/Makefile.local| contains a list of modules that are being used, and \verb|src/cparam.local| defines the grid size and the number of processors to be used.
Take a quick look at these files...


\subsubsection{Single-processor}
An example using the module for only one processor would look like:
\begin{verbatim}
MPICOMM=nompicomm
\end{verbatim}

For most modules there is also a \verb|no|-variant which switches that functionality off.

In \verb|src/cparam.local| the number of processors needs to be set to \verb|1| accordingly:
\begin{verbatim}
integer, parameter :: ncpus=1,nprocx=1,nprocy=1,nprocz=ncpus/(nprocx*nprocy)
integer, parameter :: nxgrid=128,nygrid=1,nzgrid=128
\end{verbatim}

\subsubsection{Multi-processor}
If you like to use MPI for multi-processors simulations, be sure that you have a MPI library installed and change \verb|src/Makefile.local| to use MPI:
\begin{verbatim}
MPICOMM=mpicomm
\end{verbatim}

Change the \verb|ncpus| setting in \verb|src/cparam.local|.
Think about how you want to distribute the volume on the processors --- usually, you should have 128 grid points in the x-direction to take advantage of the SIMD processor unit.
For compilation, you have to use a configuration file that includes the \verb|_MPI| suffix, see below.

\subsection{Compiling...}

In order to compile the code, you can use a pre-defined configuration file corresponding to your compiler package.
E.g. the default compilers are \verb|gfortran| together with \verb|gcc| and the code is being built with default options by issuing the command:

\begin{verbatim}
  pc_build
\end{verbatim}

\subsubsection{Using a different compiler (optional)}

If you prefer to use a different compiler package (e.g. using \verb|ifort| or \verb|MPI|), you may try:

\begin{verbatim}
  pc_build -f compilers/Intel
  pc_build -f compilers/GNU-GCC_MPI
\end{verbatim}

More pre-defined configurations are found in the directory \verb|pencil-code/config/compilers/*.conf|.

\subsubsection{Chaning compiler options (optional)}

Of course you can also create a configuration file in any subdirectory of \verb|pencil-code/config/hosts/|.
By default, \verb|pc_build| looks for a config file that is based on your \verb|host-ID|, which you may see with the command:
\begin{verbatim}
  pc_build -i
\end{verbatim}
You may add your modified configuration with the filename \verb|host-ID.conf|, where you can change compiler options according to the Pencil Code manual.

\subsection{Running...}

The initial conditions are set in \verb|start.in| and the parameters for the main simulation run can be found in \verb|run.in|.
In \verb|print.in| you can choose which physical quantities are written to the file \verb|data/time_series.dat|.

It is time to run the code with --- be sure you have an empty \verb|data| directory:
\begin{verbatim}
  mkdir data
  pc_run
\end{verbatim}

Welcome to the world of Pencil Code! Visualizing the output can be done with \verb|IDL| or \verb|Python|, see below.

\subsection{IDL visualization (optional)}
% The goal of this section is to demonstrate the general work flow with a very
% simple example.

\subsubsection{GUI-based visualization}
The most simple approach to visualize a cartesian grid setup is to run the Pencil Code GUI and to select the files and physical quantities you want to see:
\begin{verbatim}
IDL> .r pc_gui
\end{verbatim}
If you miss some physical quantities, you might want to extend the two IDL routines \verb|pc_get_quantity| and \verb|pc_check_quantities|. Anything implemented there will be available in the GUI, too.

\subsubsection{Command-line based and scripting}
Several \verb|idl|-procedures have been written
(you can find them in \verb|pencil-code/idl| ) to facilitate inspecting the data
(which can be found in raw format in \verb|jeans-x/data| directory).  For
example, let us inspect the time series data
\begin{verbatim}
IDL> pc_read_ts, obj=ts
\end{verbatim}
The structure \verb|ts| contains several variables that can be inspected by
\begin{verbatim}
IDL> print, tag_names(ts)
IT T UMAX RHOMAX
\end{verbatim}
The diagnostic \verb|UMAX|, the maximal velocity, is available since it was set
in \verb|jeans-x/print.in| (more on diagnostic output can be found in section
$5.4$ in the manual).  We can now plot the evolution of the maximal velocity in
time
\begin{verbatim}
IDL> plot, ts.t, alog(ts.umax)
\end{verbatim}
after the initial perturbation we inserted in \verb|start.in|.
% TODO Include screen shot

The complete state of the simulation, a snapshot, is saved (as
\verb|jeans-x/data/proc0/VAR$\dots|@, every \verb|dsnap|
time units
(see \verb|jeans-x/run.in|). These states can be inspected, for example
\begin{verbatim}
IDL> pc_read_var, obj=ff, ivar=1, /trimall
\end{verbatim}
Similarly \verb|tag_names| will provide us with the available variables, 
\begin{verbatim}
IDL> print, tag_names(ff)
T X Y Z DX DY DZ UU LNRHO POTSELF
\end{verbatim}
so the logarithm of the density in the simulated domain can be inspected by
\begin{verbatim}
IDL> plot, ff.lnrho
\end{verbatim}
% TODO Include screen shot


\subsection{Setting up Python for data processing (optional)}
\subsubsection{Python modules requirements}
The basic needed modules are: numpy and matplotlib.
\begin{itemize}
  \item numpy: all array definitions and operations.
  \item matplotlib: plotting.
\end{itemize}

Other really useful modules are: ipython and scipy.

\begin{itemize}
  \item ipython: enhanced python interpreter.
  \item scipy: science functions and utilities.
\end{itemize}


\subsubsection{Installation}
Untar the \texttt{tar.gz} file or go to the directory and simple type as root or sudoed:
\begin{verbatim}
python setup.py install
\end{verbatim}
For a user installation (no root permission):
\begin{verbatim}
python setup.py install --user
\end{verbatim}

\subsubsection{Using the Pencil module}
Import the module:
\begin{verbatim}
import pencil as pc
\end{verbatim}
Some useful functions:
\begin{center}
\begin{tabular}{|l|l|}\hline
pc.read\_ts & Read ``time\_series.dat'' file. Parameters are added as members of the class. \\\hline
pc.read\_slices & read 2D slice binary files and return two arrays: one of (nslices,vsize,hsize) and other of time\\\hline
pc.animate\_interactive &  Assemble a 2D animation from a 3D array. \\\hline
%× & ×\\\hline
%× & ×\\\hline
%× & ×\\\hline
\end{tabular}
\end{center}


\section{Another example: helically forced turbulence}

\input{example2}


\end{document}
