%%%%%%%%%%%%%%%%%%%%%%            -*-LaTeX-*-
%%%   manual.tex   %%%
%%%%%%%%%%%%%%%%%%%%%%
%%
%%  Date:   06-Mar-2002
%%  Author: wd (Wolfgang.Dobler@kis.uni-freiburg.de)
%%  Description: 
% 
\ifx\pdfoutput\undefined        % not running pdflatex
  \documentclass[12pt,twoside,notitlepage,a4paper]{article}
\else                           % running pdflatex
  \documentclass[pdftex,12pt,twoside,notitlepage,a4paper]{article}
\fi

\usepackage[bookmarks=false]{hyperref}
%\usepackage{german,a4}
%\usepackage[german,british]{babel}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{newcent,helvet}
\renewcommand{\ttdefault}{cmtt}

\usepackage{makeidx}

\usepackage[it,footnotesize]{caption2}
\setlength{\abovecaptionskip}{5pt} % Space before caption
\setlength{\belowcaptionskip}{5pt} % Space after caption

\usepackage[bf,sf,small,nonindentfirst]{titlesec}
\newcommand{\sectionbreak}{\clearpage}
%\titleformat{\subsubsection}{\normalfontitshape}{\thesubsubsection}{.5em}{}
%\titlespacing{\subsubsection}{0pt}{*1}{*-1}
\usepackage{fancyhdr}
\usepackage{fancybox}
\setcounter{tocdepth}{6} % Older versions of fancybox very annoyingly (and
                         % unnecessarily) resets this and make table of
                         % contents disappear

\usepackage{booktabs}
\usepackage{longtable}

\usepackage{alltt}

\usepackage{graphicx}
\usepackage{parskip,a4,vmargin}
\setpapersize{A4}
\setmargrb{20mm}{15mm}{20mm}{15mm}

\frenchspacing
\sloppy

\makeindex


%%% Page headings
\pagestyle{fancy}
\renewcommand{\sectionmark}[1]{% Don't upcase the section title
  \markright{\thesection.\ #1}}
\fancyhead{}                    % clear header
\fancyhead[LE,RO]{\thepage}
\fancyhead[CE]{\textsc{The MHD code}}
\fancyhead[CO]{\rightmark}
%
\fancyfoot{}

% ---------------------------------------------------------------------- %

%%% Macros

%% Bold face \tt prompts (only works within `alltt' or \tt environment)
\newcommand{\prompt}[1]{{\ttfamily\bfseries{}#1}}

%% Margin and inline notes and remarks
\newcommand\note[1]{\marginpar{\renewcommand{\baselinestretch}{0.8}
        \raggedright\scriptsize\usefont{OT1}{phv}{mc}{n} #1}}
\newcommand{\Note}[1]{\emph{[#1]}}


%% keys, names, paths, files, etc.
\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\kbd}[1]{\texttt{\textsl{#1}\/}}
\newcommand{\key}[1]{{\setlength{\fboxsep}{1pt}\ovalbox{\sf #1}}}
\newcommand{\samp}[1]{`\code{#1}'}
\newcommand{\var}[1]{\textsl{#1}\index{#1}\/}
\newcommand{\env}[1]{\code{#1}\index{#1}}
\newcommand{\file}[1]{`\texttt{#1}'}
\newcommand{\command}[1]{\code{#1}\index{#1}}
\newcommand{\cmd}[1]{\command{#1}}
\newcommand{\option}[1]{`\command{#1}'}
\newcommand{\dfn}[1]{\textsl{#1}\index{#1}\/}
%\newcommand{\cite}[1]{}
\newcommand{\acronym}[1]{\textsc{#1}\index{#1}}
%\newcommand{\url}[1]{}
\newcommand{\email}[1]{\code{#1}}

\newcommand{\name}[1]{\textsl{#1}\index{#1}\/}
\newcommand{\Path}[1]{\file{#1}}

%
\newcommand{\bsT}{{\fontencoding{T1}\selectfont{\symbol{92}}}}
\newcommand{\bcks}{{\symbol{92}}}
\newcommand{\bs}{\bcks}       % Save us creation of a couple of fonts

%% Maths operators
% \newcommand{\arcosh} {\mathop{\rm arcosh}\nolimits}
% \newcommand{\arcoth} {\mathop{\rm arcoth}\nolimits}
% \newcommand{\sgn}    {\mathop{\rm sgn}\nolimits}
\newcommand{\grad}    {\mathop{\rm grad}\nolimits}
\newcommand{\Div}     {\mathop{\rm div}\nolimits}
\newcommand{\curl}    {\mathop{\rm curl}\nolimits}
\newcommand{\rot}     {\curl}
\newcommand{\Laplace} {\mathop{\Delta}\nolimits}
\newcommand{\erfc}    {\mathop{\rm erfc}\nolimits}
\newcommand{\erf}     {\mathop{\rm erf}\nolimits}

\newcommand{\vekt}[1] {\mathbf{#1}}
\newcommand{\const}   {\mbox{\rm const}}

%% Maths variables
\newcommand{\Av}            {\vekt{A}}
% \newcommand{\av}            {\vekt{a}}

\newcommand{\Bv}            {\vekt{B}}
% \newcommand{\bv}            {\vekt{b}}

\newcommand{\Cool}          {{\cal C}}
\newcommand{\cs}            {c_{\rm s}}
\newcommand{\csnull}        {c_{{\rm s},0}}

% \newcommand{\Ev}            {\vekt{E}}
% \newcommand{\ev}            {\vekt{e}}
% \newcommand{\ex}            {\ev_{x}}
% \newcommand{\ey}            {\ev_{y}}
% \newcommand{\ez}            {\ev_{z}}

% \newcommand{\Fv}            {\vekt{F}}

\newcommand{\gv}            {\vekt{g}}

\newcommand{\Heat}          {{\cal H}}

\newcommand{\jv}            {\vekt{j}}

% \newcommand{\nullvekt}      {\vekt{0}}

\newcommand{\Ra}            {\mathrm{Ra}}
\newcommand{\Reynolds}      {\mathrm{Re}}
\newcommand{\Rm}            {\mathrm{Rm}}

\newcommand{\uv}            {\vekt{u}}

% \newcommand{\Vol}           {{\cal V}}
\newcommand{\vA}            {v_{\rm A}}

\newcommand{\xv}            {\vekt{x}}

% \newcommand{\zerovect}      {\nullvekt}

% ---------------------------------------------------------------------- %

\title{{\sffamily\bfseries Installing and Using the MHD code}}
%\subtitle{A very preliminary manual}
\author{Axel Brandenburg \& Wolfgang Dobler}

% ====================================================================== %

\begin{document}
\pagestyle{empty}

%\maketitle

\begin{titlepage}
  \begin{center}

  \large

  \vspace*{3cm}

  {\Large\sffamily\bfseries Installing and Using the MHD code}

  \vspace{0.5cm}

  {\sffamily A very preliminary manual}

  \vspace{1.5cm}

  {Axel Brandenburg \& Wolfgang Dobler}


  \vspace{2cm}

  \emph{\today}


\end{center}

\end{titlepage}


\newpage
\mbox{}
\vfill

Copyright \copyright{} 2001,2002 Axel Brandenburg \& Wolfgang Dobler 
\bigskip

Permission is granted to make and distribute verbatim copies of
this manual provided the copyright notice and this permission notice
are preserved on all copies.

Permission is granted to copy and distribute modified versions
of this manual under the conditions for verbatim copying,
provided that the entire resulting derived work is distributed under the
terms of a permission notice identical to this one.


\clearpage
\pagestyle{plain}
\pagenumbering{roman}

\tableofcontents
\clearpage
\pagestyle{fancy}
\pagenumbering{arabic}


% ====================================================================== %

\section{Obtaining the Code}

To obtain the MHD code, you should use \name{CVS} (concurrent version
system, see \url{http://fill.this.in}).
You proceed as follows:

\begin{enumerate}

\item Get a \name{CVS} client from \url{http://fill.this.in} and install it

\item Get the password for anonymous \name{CVS} access to the MHD code

\item Set your environment variable \env{CVSROOT} (you probably want to
  put this into your \file{.cshrc} or \file{.profile} setup files):
  \begin{alltt}
  \prompt{csh> } setenv CVSROOT \bs
        :pserver:anonymous@norserv.nordita.dk:/home/brandenb/CVS \
  \end{alltt}
  (all in one line, without the backslash) or
  \begin{alltt}
  \prompt{sh> } CVSROOT=:pserver:anonymous@norserv.nordita.dk:/home/brandenb/CVS
  \prompt{sh> } export CVSROOT \
  \end{alltt}

\item Log in:
  \begin{alltt}
  \prompt{unix> } cvs login
  cvs pasword: ........ \
\end{alltt}

\item Go to wherever you want the code:
  \begin{alltt}
  \prompt{unix> } cd \file{somewhere} \
  \end{alltt}

\item Check the code out:
  \begin{alltt}
  \prompt{unix> } cvs checkout -d mhd f90/pencil_modular \
  \end{alltt} 
  This creates a subdirectory \file{mhd} of your current directory
  \file{somewhere} and populates it with the MHD code's subdirectories.

\end{enumerate}


% ====================================================================== %

\section{Getting Started}

To get yourself started, you should run the comvection example which is
provided as the default configuration of the code.


% ====================================================================== %

\section{Code structure}

% ---------------------------------------------------------------------- %

\subsection{Directory tree}


% ---------------------------------------------------------------------- %

\subsection{Basic concepts}


\subsubsection{Data access in pencils}


\subsubsection{Modules}


\subsubsection{Localisation (adapt-mkfile)}



% ====================================================================== %

\section{The Equations}

The equations solved by the MHD code are basically the standard
compressible MHD equations. However, the modular structure allows to
implement different versions of the MHD equations, as well as to switch
some of the equations off.

% ---------------------------------------------------------------------- %

\subsection{Continuity equation}

\begin{equation}
  \frac{D\ln\varrho}{Dt}
  = - \Div\uv \; .
\end{equation}

Here $\varrho$ denotes density, $\uv$ the fluid velocity, $t$ is time and
$D/Dt \equiv \partial/\partial t + \uv\cdot\grad$ is the convective
derivative.

% ---------------------------------------------------------------------- %

\subsection{Equation of motion}

\begin{equation}
  \frac{D\uv}{Dt}
   =  -\cs^2\grad\biggl(\frac{s}{c_p} + \ln\varrho\biggr)
      - \grad\Phi
      + \frac{\jv\times\Bv}{\varrho}
      + \nu \left( \Laplace\uv + \frac{1}{3}\grad\Div\uv \right) \; .
\end{equation}
Here, $\cs^2 = \gamma p/\varrho$ is the (squared) sound speed,
$\gamma=c_p/c_v$ the ratio of specific heats of \emph{adiabatic index},
$\Phi$ is the gravity potential, $\jv$ the electric current density, $\Bv$
the magnetic flux density, and $\nu$ is kinematic viscosity.
Note that the viscous term used here is only correct if the dynamical
viscosity $\mu \equiv \varrho\nu = \const$ everywhere.


% ---------------------------------------------------------------------- %
\subsection{Induction equation}

\begin{equation}
  \frac{\partial\Av}{\partial t}
  = \uv\times\Bv + \eta\mu_0\jv \; .
\end{equation}

Here $\Av$ is the magnetic vector potential, $\Bv = \curl\Av$ the magnetic
flux density, $\eta = 1/(\mu_0\sigma)$ is the magnetic diffusivity
($\sigma$ denoting the electrical conductivity), and $\mu_0$ the
magnetic vacuum permeability.


% ---------------------------------------------------------------------- %

\subsection{Entropy equation}

The current thermodynamics module \file{entropy} formulates the thermal
part of the physics in terms of \emph{entropy} $s$, rather than thermal
energy $e$, which you may be more familiar with.
Thus the two fundamental thermodynamical variables are $\ln\varrho$
and $s$.
The reason for this choice of variables is that entropy is the natural
physical variable for (at least) convection processes: the sign of the
entropy gradient determines convective (in)stability, the
\emph{Rayleigh number} is proportional to the entropy gradient, etc.

\begin{equation}
  \varrho T\frac{Ds}{Dt}
   =  \Heat - \Cool
      + \Div(\lambda\grad T)
      + \mu_0 \jv^2
      + 2\varrho\nu {\sf S}^2 \; .
\end{equation}

Here, $T$ is temperature, $c_p$ the specific heat at constant pressure,
$\Heat$ and $\Cool$ are explicit heating and cooling terms,
$\lambda$ is the thermal conductivity, and
\begin{equation}
  {\sf S}_{ik} = \frac{\partial_i u_k + \partial_k u_i}{2}
                 -\frac{1}{3} \delta_{ik}\Div\uv
\end{equation}
is the shear tensor.

    
% ====================================================================== %

\section{Boundary conditions}

    
% ====================================================================== %

\section{Using the Code}
\label{Input-params}

Here's how to use the code \ldots

% ---------------------------------------------------------------------- %
\subsection{Start parameters}
Here is a list of parameters that are set in \file{start.in}

Any variable referred to as a \dfn{flag} can be set to any nonzero value
to switch the corresponding feature on.

Not all parameters are used for a given scenario.

% ---------------------------------------------------------------------- %
\begin{longtable}{lp{0.6\textwidth}}
%\begin{tabular}{lp{0.6\textwidth}}
\toprule
  \multicolumn{1}{c}{\emph{Variable}}
               & \multicolumn{1}{c}{\emph{Meaning}} \\
\midrule
  \var{ip}     & (anti-)verbosity level: \code{ip=1} produces lots of
                 diagnostic output, \code{ip=14} virtually none. \\
  \var{[x-z]0},
  \var{L[x-z]},
  \var{iper[x-z]},
               & determine the geometry of the box.
                 If \code{iperx=0} (box \emph{not\/} periodic in $x$), $x$
                 ranges from $x_0$ to $x_0+L_x$; if \code{iperx=1}
                 (periodic box in $x$), the rightmost point is
                 $x_0+L_x-\delta x$. In all cases, three ghost zones will
                 be added. \\
  \var{z1}, \var{z2}, \var{ztop}
               & specific to the solar convection case.
                 The stable layer is $z_0 < z < z_1$, the unstable layer
                 $z_1 < z < z_2$, and the top (isothermal) layer is
                 $z_2 < z < z_{\rm top}$
                 \Note{How is this related to $L_z$??} \\
  \var{hcond[0-2]}, \var{whcond}
               & specific to the solar convection case: heat conductivities
                 $\lambda$ in the individual layers. \var{hcond0} is the
                 value $\lambda_{\rm unst}$ in the unstable layer,
                 \var{hcond1} is the ratio
                 $\lambda_{\rm stab}/\lambda_{\rm unst}$ for the stable
                 layer, and \var{hcond2} is the ratio 
                 $\lambda_{\rm top}/\lambda_{\rm unst}$ for the top layer.
                 The function $\lambda(z)$ is not discontinuous, as the
                 transition between the different values is smoothed over
                 the width \var{whcond}. \\
  \var{mpoly[0-2]}, \var{isothtop}
               & specific to the solar convection case: polytropic indices
                 of unstable (\var{mpoly0}), stable (\var{mpoly1}) and top
                 layer (\var{mpoly2}).
                 If the flag \var{isothtop} is set, the
                 top layer is initialised to be isothermal, otherwise
                 thermal (plus hydrostatic) equilibrium is assumed for all
                 three layers, which results in a piecewise polytropic
                 stratification. \\
  \var{ampl}   & ??? \\
  \var{init}   & ??? \\
  \var{urand}  & amplitude of initial random velocity fluctuations \\
  \var{gamma}  & adiabatic index of the gas (typically $\gamma=5/3$ in
                 astrophysical applications \\
  \var{cs0}, \var{rho0}
               & reference values of sound speed $\cs$ and density
                 $\varrho$. In the convection case, these are the values of
                 $\cs$ and $\varrho$ at $z=z_{\rm top}$. \\
  \var{gravz}  & vertical gravity $g_z$; normally $<0$. \\
  \var{grads0} & [Not used for convection reference case] initial entropy
                 gradient. \\
\bottomrule
%\end{tabular}
\end{longtable}
% ---------------------------------------------------------------------- %

% ---------------------------------------------------------------------- %
\subsection{Run parameters}
\label{Run-params}

Here is a list of parameters that are set in \file{run.in}.

Note that formatted \name{Fortran} input allows for parameters to be
skipped (indicated by possible whitespace, followed by a comma), which
causes the corresponding variable to retain the value it had before the
\cmd{read} command was called.
In most cases, this default value will be the one set in \file{start.in}.

Any variable referred to as a \dfn{flag} can be set to any nonzero value
to switch the corresponding feature on.

Not all parameters are used for a given scenario.


% ---------------------------------------------------------------------- %
\begin{longtable}{lp{0.6\textwidth}}
\toprule
  \multicolumn{1}{c}{\emph{Variable}}
               & \multicolumn{1}{c}{\emph{Meaning}} \\
\midrule
  \var{nt}     & number of time steps to carry out. \\
  \var{it1}    & write monitoring output every \var{it1} time steps.\\
  \var{dt}     & time step $\delta t$ if positive,
                 $\delta t/\delta t_{\rm Courant}$ if negative. A typical
                 value is \code{dt=-0.4}. \\
  \var{isave}  & update snapshot file \file{var.dat} every \var{isave}
                 time steps. \\
  \var{iorder} & order of time step. Set \code{iorder=1} for Euler
                 stepping, \code{iorder=3} for the 3rd-order Runge-Kutta
                 (2$N$) scheme. \\
  \var{dsnap}  & save full snapshots \file{VAR$N$} every \var{dsnap} time
                 units. \\
  \var{dvid}   & write two-dimensional sections for generation of videos
                 every \var{dsnap} time units. \\
  \var{dforce} & force every \var{dforce} time units [???]. \\
  \var{dtmin}  & abort if time step $\delta t < \delta t_{\rm min}$. \\
  \var{tinit}  & ??? \\
  \var{tdamp}  & damp velocities in the initial time interval
                 $0 < t < t_{\rm damp}$. \\
  \var{dampu}  & strength of initial damping of velocity. \\
  \var{dampuext}, \var{rdamp}, \var{wdamp}
               & permanently damp velocities at $|\xv| > r_{\rm damp}$
                 with strength \var{dampuext}, with a smooth transition
                 between damped and undamped of radial width \var{wdamp}. \\
  \var{ip}     & (anti-)verbosity level: \code{ip=1} produces lots of
                 diagnostic output, \code{ip=14} virtually none. \\
  \var{i[x-z]} & monitor values of some variables in point with indices
                 $(i_x,i_y,i_z)$. \\
  \var{cs}, \var{rho}
               & reference values of sound speed $\cs$ and density
                 $\varrho$. In the convection case, these are the values of
                 $\cs$ and $\varrho$ at $z=z_{\rm top}$. \\
  \var{ivisc}  & switch for viscosity term
                 \Note{which value gives which term?} \\
  \var{cdtv}   & weight of diffusive/viscous relative to advective time
                 step for determining the Courant step
                 \begin{equation}
                   \delta t_{\rm Cou}
                   = \min\left( \frac{\delta x_{\rm min}}
                                     {U_{\rm max}} ,
                                c_{\delta t_v}
                                \frac{\delta x_{\rm min}^2}
                                     {D_{\rm max}}
                         \right) \; ,
                 \end{equation}
                 where
                 $\delta x_{\rm min} \equiv \min(\delta x, \delta y, \delta z)$;
                 $U_{\rm max} \equiv \max\left(|\uv|
                                     + \sqrt{\cs^2{+}\vA^2}\right)$,
                 $\cs$ and $\vA$ denoting sound speed and Alfv\'en speed,
                 respectively;
                 and $D_{\rm max} = \max(\nu,\chi,\eta)$, where
                 $\nu$ denotes kinematic viscosity,
                 $\chi = \lambda/(c_p\varrho)$ thermal diffusivity and
                 $\eta$ the magnetic diffusivity.
                 \\
  \var{hcond[0-2]}, \var{whcond}
               & heat conductivities, see Sec~\ref{Input-params}; leave
                 these empty unless you want to override the settings from
                 \file{start.in}. \\
  \var{cdiffrho}
               & ??? \\
  \var{gravz}  & vertical gravity, see Sec~\ref{Input-params}; leave
                 this empty unless you want to override the setting from
                 \file{start.in}. \\
  \var{cheat}, \var{wheat}
               & heating term: add total amount \var{cheat} of heat per
                 time unit in zone near bottom of width \var{wheat}.
                 You probably rather want to use \var{Fheat} (see below). \\
  \var{cool}, \var{wcool}
               & cooling term: cool top layer of width \var{wcool} to
                 reference temperature (given by ${\cs}_0$) by cooling term
                 of strength \var{cool}. \\
  \var{Fheat}  & heat flux through bottom boundary. \\
  \var{iforce}, \var{force}, \var{relhel}
               & on-off flag, strength and kinetic helicity of forcing
                 terms. \\
  \var{bc[x-z]}
               & boundary conditions. Set these to a sequence of letters 
                 like `p,p,p,p,p,p,p,p' for periodic boundaries, or
                 `s,s,a,a2,c1:c2,s,s,a' for non-periodic ones.
                 Each entry (between commas) corresponds to one of the
                 variables, normally these are $u_x$, $u_y$, $u_z$,
                 $\ln\varrho$, $s/c_p$, $A_x$, $A_x$ and $A_x$, in this
                 order.
                 \begin{description}
                 \item[\option{p}] indicates periodicity
                 \item[\option{a}] indicates antisymmetry w.\,r.\,t.~the
                   boundary, i.\,e.~vanishing value
                 \item[\option{s}] indicates symmetry w.\,r.\,t.~the
                   boundary, i.\,e.~vanishing first derivative
                 \item[\option{a2}] indicates antisymmetry w.\,r.\,t.~the
                   arbitrary value on the boundary, i.\,e.~vanishing
                   second derivative
                 \item[\option{c1}] is a special boundary condition for
                   $\ln\varrho$ and $s$, which ensures constant heat flux
                   through the boundary
                 \item[\option{c2}] is a special boundary condition for
                   $\ln\varrho$ and $s$, which ensures constant
                   temperature at the boundary 
                 \end{description}
                 The special syntax $a$:$b$ (e.\,g.~`\code{c1:c2}') means: use
                 boundary condition $a$ at the left/lower boundary, but
                 $b$ at the right/upper one. 
                 \\
  \var{form1}  & format for monitoring output. typically something like
                 \code{'(i8,f11.5,1p,50(e10.3," "))'} for printing number
                 of time step, time, and then a lot of different
                 quantities. Make sure you allow for sufficiently many
                 quantities here (you can always use a large multiplier to
                 be on the safe side). \\
\bottomrule
\end{longtable}
% ---------------------------------------------------------------------- %


% ====================================================================== %

\section{Experimenting with the \LaTeX{} macros}


\bs{}code:    \code{call remove\_file()}

\bs{}kbd:     \kbd{M-x comment-region}

\bs{}key:     \key{F1}

\bs{}samp:    \samp{a}, \samp{e}, \samp{i}, \samp{o}, \samp{u}

\bs{}var:     \var{ivisc}

\bs{}env:     \env{CVSROOT}

\bs{}file:    \file{~/tmp/var.dat}

\bs{}command: \command{rm -f *}

\bs{}option:  \option{-l}, \option{--long-listing}

\bs{}dfn:     A \dfn{definition} is a specification sufficiently obfuscated
           to be miunderstood 

\bs{}cite:    See \cite{Abramowitz & Stegun}

\bs{}acronym: \acronym{MNRAS}

\bs{}url:     \url{http://www.nowhere.net/second_page.html}

\bs{}email:   \email{nobody@nowhere.nil}




% ====================================================================== %

\printindex

\end{document}

% End of file manual.tex
