#!/bin/sh
#
#  Author: Tony Mee.
#
#  Usage:
#    In $PENCIL_HOME/src do 'mkdep *.f90 > Makefile.depend'
#
#  TODO: currently mkdep does not detect dependencies on fftpack.o or on gsl.
#
dollar='$'

#script='
#
#    s/\bSELFGRAVITY\b/\$(SELFGRAVITY)\$(PC_META_TYPE).o/i;
#    s/\bMESSAGES\b/messages\$(PC_META_TYPE).o/i;
#    s/\bMPICOMM\b/\$(MPICOMM_FIX)\$(PC_META_TYPE).o/i;
#    s/\bGLOBAL\b/\$(GLOBAL)\$(PC_META_TYPE).o/i;
#    s/\bIO\b/\$(IO)\$(PC_META_TYPE).o/i;
#    s/\bPOWER_SPECTRUM\b/\$(POWER)\$(PC_META_TYPE).o/i;
#    s/\bPARTICLES\b/\$(PARTICLES)\$(PC_META_TYPE).o/i;
#    s/\bPARTICLES_SUB\b/\$(PARTICLES_SUB)\$(PC_META_TYPE).o/i;
#    s/\bPARTICLES_MAIN\b/\$(PARTICLES_MAIN)\$(PC_META_TYPE).o/i;
#    s/\bPARTICLES_RADIUS\b/\$(PARTICLES_RADIUS)\$(PC_META_TYPE).o/i;
#    s/\bPARTICLES_NUMBER\b/\$(PARTICLES_NUMBER)\$(PC_META_TYPE).o/i;
#    s/\bPARTICLES_SELFGRAVITY\b/\$(PARTICLES_SELFGRAVITY)\$(PC_META_TYPE).o/i;
#    s/\bHYDRO\b/\$(HYDRO)\$(PC_META_TYPE).o/i;
#    s/\bVISCOSITY\b/\$(VISCOSITY)\$(PC_META_TYPE).o/i;
#    s/\bDENSITY\b/\$(DENSITY)\$(PC_META_TYPE).o/i;
#    s/\bENTROPY\b/\$(ENTROPY)\$(PC_META_TYPE).o/i;
#    s/\bMAGNETIC\b/\$(MAGNETIC)\$(PC_META_TYPE).o/i;
#    s/\bRADIATION\b/\$(RADIATION)\$(PC_META_TYPE).o/i;
#    s/\bPSCALAR\b/\$(PSCALAR)\$(PC_META_TYPE).o/i;
#    s/\bDUSTVELOCITY\b/\$(DUSTVELOCITY)\$(PC_META_TYPE).o/i;
#    s/\bDUSTDENSITY\b/\$(DUSTDENSITY)\$(PC_META_TYPE).o/i;
#    s/\bINTERSTELLAR\b/\$(INTERSTELLAR)\$(PC_META_TYPE).o/i;
#    s/\bCOSMICRAY\b/\$(COSMICRAY)\$(PC_META_TYPE).o/i;
#    s/\bCOSMICRAYFLUX\b/\$(COSMICRAYFLUX)\$(PC_META_TYPE).o/i;
#    s/\bSTRUCT_FUNC\b/\$(STRUCT_FUNC)\$(PC_META_TYPE).o/i;
#    s/\bINITCOND_SPEC\b/\$(INITCOND_SPEC)\$(PC_META_TYPE).o/i;
#    s/\bGRAVITY\b/\$(GRAVITY)\$(PC_META_TYPE).o/i;
#    s/\bEQUATIONOFSTATE\b/\$(EOS)\$(PC_META_TYPE).o/i;
#    s/\bFORCING\b/\$(FORCING)\$(PC_META_TYPE).o/i;
#    s/\bSHEAR\b/\$(SHEAR)\$(PC_META_TYPE).o/i;
#    s/\bTIMEAVG\b/\$(TIMEAVG)\$(PC_META_TYPE).o/i;
#    s/\bSPECIAL\b/\$(SPECIAL)\$(PC_META_TYPE).o/i;
#    s/\bTESTFIELD\b/\$(TESTFIELD)\$(PC_META_TYPE).o/i;
#    s/\bSHOCK\b/\$(SHOCK)\$(PC_META_TYPE).o/i;
#    s/\bCHIRAL\b/\$(CHIRAL)\$(PC_META_TYPE).o/i;
#    s/\bGRID\b/\$(GRID)\$(PC_META_TYPE).o/i;
#    s/\bFOURIER\b/\$(FOURIER)\$(PC_META_TYPE).o/i;
#    s/\bGHOSTFOLD\b/ghostfold_\$(MPICOMM)\$(PC_META_TYPE).o/i;
#    s/\bBORDERPROFILES\b/\$(BORDER_PROF)\$(PC_META_TYPE).o/i;
#
#    s/\bPARTICLES_CDATA\b/\particles_cdata\$(PC_META_TYPE).o/i;
#    s/\bCDATA\b/cdata\$(PC_META_TYPE).o/i; 
#    s/\bPERSIST\b/persist\$(PC_META_TYPE).o/i; 
#    s/\bCPARAM\b/cparam\$(PC_META_TYPE).o/i; 
#    s/\bBOUNDCOND\b/boundcond\$(PC_META_TYPE).o/i;
#    s/\bFILTER\b/filter\$(PC_META_TYPE).o/i;
#    s/\bINITCOND\b/initcond\$(PC_META_TYPE).o/i;
#    s/\bTIMESTEP\b/timestep\$(PC_META_TYPE).o/i;
#    s/\bWSNAPS\b/wsnaps\$(PC_META_TYPE).o/i;
#    s/\bSUB\b/sub\$(PC_META_TYPE).o/i;
#    s/\bEQU\b/equ\$(PC_META_TYPE).o/i;
#    s/\bPRINT\b/prints\$(PC_META_TYPE).o/i;
#    s/\bREGISTER\b/register\$(PC_META_TYPE).o/i;
#    s/\bPARAM_IO\b/param_io\$(PC_META_TYPE).o/i;
#    s/\bDERIV\b/deriv\$(PC_META_TYPE).o/i;
#    s/\bSLICES\b/slices\$(PC_META_TYPE).o/i;
#    s/\bGENERAL\b/general\$(PC_META_TYPE).o/i;
#    s/\bPRINT\b/prints\$(PC_META_TYPE).o/i;
#    s/\bSNAPSHOT\b/snapshot\$(PC_META_TYPE).o/i;
#    s/\bFARRAYMANAGER\b/farray\$(PC_META_TYPE).o/i;
#    s/\bSHAREDVARIABLES\b/shared_variables\$(PC_META_TYPE).o/i;
#'

script='

    s/\bBORDERPROFILES\b/\$(BORDER_PROF).o/i;
    s/\bCHIRAL\b/\$(CHIRAL).o/i;
    s/\bCOSMICRAY\b/\$(COSMICRAY).o/i;
    s/\bCOSMICRAYFLUX\b/\$(COSMICRAYFLUX).o/i;
    s/\bDENSITY\b/\$(DENSITY).o/i;
    s/\bDUSTVELOCITY\b/\$(DUSTVELOCITY).o/i;
    s/\bDUSTDENSITY\b/\$(DUSTDENSITY).o/i;
    s/\bENTROPY\b/\$(ENTROPY).o/i;
    s/\bEQUATIONOFSTATE\b/\$(EOS).o/i;
    s/\bFORCING\b/\$(FORCING).o/i;
    s/\bFOURIER\b/\$(FOURIER).o/i;
    s/\bGLOBAL\b/\$(GLOBAL).o/i;
    s/\bGRAVITY\b/\$(GRAVITY).o/i;
    s/\bGRID\b/\$(GRID).o/i;
    s/\bHYDRO\b/\$(HYDRO).o/i;
    s/\bINITCOND_SPEC\b/\$(INITCOND_SPEC).o/i;
    s/\bINTERSTELLAR\b/\$(INTERSTELLAR).o/i;
    s/\bHYPERVISC_STRICT\b/\$(HYPERVISC_STRICT).o/i;
    s/\bHYPERRESI_STRICT\b/\$(HYPERRESI_STRICT).o/i;
    s/\bIO\b/\$(IO).o/i;
    s/\bMAGNETIC\b/\$(MAGNETIC).o/i;
    s/\bMESSAGES\b/messages.o/i;
    s/\bMPICOMM\b/\$(MPICOMM_FIX).o/i;
    s/\bNEUTRALDENSITY\b/\$(NEUTRALDENSITY).o/i;
    s/\bNEUTRALVELOCITY\b/\$(NEUTRALVELOCITY).o/i;
    s/\bPOWER_SPECTRUM\b/\$(POWER).o/i;
    s/\bPARTICLES\b/\$(PARTICLES).o/i;
    s/\bPARTICLES_SUB\b/\$(PARTICLES_SUB).o/i;
    s/\bPARTICLES_MAIN\b/\$(PARTICLES_MAIN).o/i;
    s/\bPARTICLES_RADIUS\b/\$(PARTICLES_RADIUS).o/i;
    s/\bPARTICLES_NUMBER\b/\$(PARTICLES_NUMBER).o/i;
    s/\bPARTICLES_SELFGRAVITY\b/\$(PARTICLES_SELFGRAVITY).o/i;
    s/\bPARTICLES_NBODY\b/\$(PARTICLES_NBODY).o/i;
    s/\bPOISSON\b/\$(POISSON).o/i;
    s/\bPSCALAR\b/\$(PSCALAR).o/i;
    s/\bRADIATION\b/\$(RADIATION).o/i;
    s/\bSELFGRAVITY\b/\$(SELFGRAVITY).o/i;
    s/\bSHEAR\b/\$(SHEAR).o/i;
    s/\bSHOCK\b/\$(SHOCK).o/i;
    s/\bSPECIAL\b/\$(SPECIAL).o/i;
    s/\bSTRUCT_FUNC\b/\$(STRUCT_FUNC).o/i;
    s/\bTESTFIELD\b/\$(TESTFIELD).o/i;
    s/\bTIMEAVG\b/\$(TIMEAVG).o/i;
    s/\bVISCOSITY\b/\$(VISCOSITY).o/i;

    s/\bBOUNDCOND\b/boundcond.o/i;
    s/\bCDATA\b/cdata.o/i; 
    s/\bCPARAM\b/cparam.o/i; 
    s/\bDERIV\b/deriv.o/i;
    s/\bEQU\b/equ.o/i;
    s/\bFARRAYMANAGER\b/farray.o/i;
    s/\bFILTER\b/filter.o/i;
    s/\bGENERAL\b/general.o/i;
    s/\bGHOSTFOLD\b/ghostfold_\$(MPICOMM).o/i;
    s/\bINITCOND\b/initcond.o/i;
    s/\bPARAM_IO\b/param_io.o/i;
    s/\bPARTICLES_CDATA\b/\particles_cdata.o/i;
    s/\bPERSIST\b/persist.o/i; 
    s/\bPRINT\b/prints.o/i;
    s/\bREGISTER\b/register.o/i;
    s/\bSHAREDVARIABLES\b/shared_variables.o/i;
    s/\bSLICES\b/slices.o/i;
    s/\bSNAPSHOT\b/snapshot.o/i;
    s/\bSUB\b/sub.o/i;
    s/\bTIMESTEP\b/timestep.o/i;
    s/\bWSNAPS\b/wsnaps.o/i;
'

while [ "$1" ]
do
  file="$1"
  if [ -e "$file" ]; then
    if [ "${file%.c}" != "$file" ]; then
      echo "${file%.c}.o: $file" 
    else
      used=`perl -ne 'print "$1\n" if m/^\s*use\s*([\w\d]*)/ ' $file | tr '[:lower:]' '[:upper:]' | sort | uniq `
      depends=`echo $used | perl -npe "$script"`
      includes=`perl -ne "print \"${dollar}1 \" if m/^\s*include\s*\\'([\S]*\\.(inc|local))\\'/ ;" $file `

      echo "${file%.f90}.o: $file $includes $depends" 
    fi
  fi
  shift
done
