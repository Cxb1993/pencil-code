\documentclass[a4paper,12pt]{article}
\usepackage[utf8]{inputenc}
%\usepackage[spanish]{babel}
\usepackage{pslatex} %Para el pdf sea más mono.
\usepackage{eurosym}
\usepackage{amssymb}
\usepackage{latexsym}
\usepackage[dvips]{graphicx}
\usepackage{delarray}
\usepackage{amsmath}
%\usepackage{bbm}
%\usepackage{bbold}
%\usepackage{accents}
\usepackage{subfigure}
\usepackage{multirow}
\usepackage{fancyhdr}
%\usepackage{tocbibind} % Para que incluya la bibliografia en el indice
%\usepackage{bibtex}
\usepackage{wrapfig}
\usepackage{color}
\usepackage{hyperref}
%\usepackage{fmtcount}
\frenchspacing

\graphicspath{{./fig/}{./png/}}

\setlength{\hoffset}{-1in}
\setlength{\textwidth}{7.5in}
\setlength{\voffset}{-1.2in}
\setlength{\textheight}{10.0in}

\title{Pencil-code: quick reference guide.}
%\dedicatory{pa mi}


\author{Illa Rivero Losada}
\date{}

\begin{document}
\maketitle

\tableofcontents

\newpage

\section{Download the Pencil Code}
The Pencil Code is an open source code. General information can be found at
\begin{verbatim}
http://www.nordita.org/pencil-code/
\end{verbatim}

You need \verb|svn| to download the latest version 
\begin{verbatim}
svn checkout https://pencil-code.googlecode.com/svn/trunk/ pencil-code
--username NAME
\end{verbatim}

where you replace NAME by your gmail name, and the password is the
one generated by pencil-code.googlecode.com ($\rightarrow$profile
$\rightarrow$settings). 

An alternative is
\begin{verbatim}
wget http://pencil-code.googlecode.com/files/pencil-code-r18525.tar.gz
\end{verbatim}

The downloaded \verb|pencil-code| directory contains several sub-directories
\begin{enumerate}
  \item \verb|samples| which contains many sample problems
  \item \dots
\end{enumerate}

\section{Configure shell.}

I only made it work properly using cshell. It didn't run properly with bash.

Under the tcsh shell, put in your \$HOME/.cshrc file the following lines:
\begin{verbatim}

#
#  path for pencil code
#
if (! $?PENCIL_HOME) setenv PENCIL_HOME $HOME/pencil-code
if (-r $PENCIL_HOME/sourceme.csh) then
  set _sourceme_quiet; source $PENCIL_HOME/sourceme.csh; unset _sourceme_quiet
endif
\end{verbatim}

Note: If you want to change your default \$SHELL to tcsh, type

\begin{verbatim}
  chsh
  /bin/tcsh
\end{verbatim}

The first command prompts you for your normal unix password.

If you are under the bash shell, put in your \$HOME/.bashrc file the following
lines:
\begin{verbatim}
#
#  path for pencil code
#
if [ -z $PENCIL_HOME ]; then  export PENCIL_HOME=$HOME/pencil-code; fi
if [ -e $PENCIL_HOME/sourceme.sh ]; then
  set _sourceme_quiet; source $PENCIL_HOME/sourceme.sh; unset _sourceme_quiet
fi
\end{verbatim}

 Also add the following useful alias:

With tcsh: \texttt{alias pc 'cd \$PENCIL\_HOME'}
With bash: \texttt{alias pc='cd \$PENCIL\_HOME'}

such that you will directly move to the Pencil Code directory wherever you are
by typing 'pc'.

Source your updated \$HOME/.cshrc or \$HOME/.bashrc file by typing:

With tcsh: \texttt{source .cshrc}
With bash: \texttt{source .bashrc}

\section{Configure makefile.}

Get host-id:
\begin{verbatim}
pc_build --debug
\end{verbatim}
Create a new config file in:
\texttt{config/hosts/illa/host-veto-GNU\_Linux-Fedora.conf}

My config file:
\begin{verbatim}
# Linux.conf
#
# Default settings for Linux systems
#
# $Id: GNU_Linux.conf 12923 2010-01-11 15:24:28Z sven.bingert $

%section Makefile
# %include compilers/gfortran
 %include compilers/ifort
 %include compilers/mpif90
 %include compilers/gcc

FC=mpif90 
FFLAGS= -O3  
CC=mpicc 
CFLAGS=-O3 -DFUNDERSC=1 
LD_MPI= 
FFLAGS_DOUBLE=-r8 
%endsection Makefile

%section runtime
mpiexec=/usr/pkg/intel/2011.8.273/composer_xe_2011_sp1.8.273/mpirt/bin/intel64/m
pirun
%endsection runtime
# End of file
\end{verbatim}



\section{Useful commands.}
\begin{center}
\begin{tabular}{|l|l|}\hline
pc & move to the PC directory\\\hline
cd samples/conv-slab & move to the sample 'conv-slab' which is in a 'samples'
directory\\\hline
pc\_setupsrc & initialize the local 'src' directory, copy necessary files,
etc...\\\hline
make & 	compile the code\\\hline
mkdir data & create the data directory where all the outputs will be written
\\\hline
start.csh & compute the initial setup at time t=0 \\\hline
run.csh & launch the main code that advances the equations in time\\\hline
\end{tabular}
\end{center}

\section{Configure the run}
The structure of the Pencil code consists of different modules, containing
different physics that you may or may not need for your problem. 

\subsection{Makefile}

\begin{verbatim}
pc_setupsrc
\end{verbatim}
This sets up the linking to the root \verb|src| directory and makes a
\verb|data| directory that will contain the data produced by your simulation.

Basic configuration files for the make:
\begin{verbatim}
src/Makefile.local
src/cparam.local
\end{verbatim}

The structure of the Pencil code consists of different modules, containing
different physics that you may or may not need for your problem. These are set
in \verb|Makefile.local|. 

Example of a file without mpi:
\begin{verbatim}
###                             -*-Makefile-*-
### Makefile for modular pencil code -- local part
### Included by `Makefile'
###

MPICOMM=nompicomm
#MPICOMM=mpicomm
GRAVITY=gravity_simple
EOS=eos_idealgas
FORCING=noforcing
ENTROPY=noentropy
MAGNETIC=magnetic
MAGNETIC_MEANFIELD=magnetic/meanfield
DENSITY=density
HYDRO=hydro
\end{verbatim}

The \texttt{src/cparam.local} file set the local settings concerning grid size
and number of CPUs. My file (no mpi):
\begin{verbatim}
!  -*-f90-*-  (for Emacs)    vim:set filetype=fortran:  (for vim)
!
!  cparam.local
!
!  Local settings concerning grid size and number of CPUs.
!  This file is included by cparam.f90
!
integer, parameter :: ncpus=1,nprocx=1,nprocy=1,nprocz=ncpus/(nprocx*nprocy)
integer, parameter :: nxgrid=128,nygrid=1,nzgrid=128
!
\end{verbatim}

\subsection{Run configuration files}
Three basic files: print.in, run.in and start.in.


\section{Running the code}

In order to use the code, a compilation in each of the working directories is
needed. Basically there are two ways of compiling and running the code.
The only way of using the Makefile config file created before is using the new
way:

The standard way:
\begin{enumerate}
  \item \verb|pc_build| compile the code
  \item \verb|pc_run| run the code
    \begin{enumerate}
      \item \verb|pc_run start| can be run before \verb|pc_run|, to construct
        the initial condition.
    \end{enumerate}
\end{enumerate}

The old way of doing it was:
\begin{verbatim}
make
./start.csh
./run.csh
\end{verbatim}
But one usually need to specify some options by hand in the make command. In my
case, to use mpi:
\begin{verbatim}
make FC=mpif90
\end{verbatim}

\section{Setting up python.}
\subsection{Python modules requirements.}
The basic needed modules are: numpy and matplotlib.
\begin{itemize}
 \item numpy: all array definitions and operations.
  \item matplotlib: plotting.
\end{itemize}

Other really useful modules are: ipython and scipy.

\begin{itemize}
 \item ipython: enhanced python interpreter.
  \item scipy: science functions and utilities.
\end{itemize}


\subsection{Installation}
Untar the \texttt{tar.gz} file or go to the directory and simple type as root or sudoed:
\begin{verbatim}
python setup.py install
\end{verbatim}
For a user installation (no root permision):
\begin{verbatim}
python setup.py install --user
\end{verbatim}

\subsection{Using the module.}
Import the module:
\begin{verbatim}
import pencil as pc
\end{verbatim}
Some useful functions:
\begin{center}
\begin{tabular}{|l|l|}\hline
pc.read\_ts & Read ``time\_series.dat'' file. Parameters are added as members of the class. \\\hline
pc.read\_slices & read 2D slice binary files and return two arrays: one of (nslices,vsize,hsize) and other of time\\\hline
pc.animate\_interactive &  Assemble a 2D animation from a 3D array. \\\hline
%× & ×\\\hline
%× & ×\\\hline
%× & ×\\\hline
\end{tabular}
\end{center}

\section{Run a sample: an example}
\end{document}
