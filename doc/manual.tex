%%%%%%%%%%%%%%%%%%%%%%            -*-LaTeX-*-
%%%   manual.tex   %%%
%%%%%%%%%%%%%%%%%%%%%%
%%
%%  Date:   06-Mar-2002
%%  Author: wd (Wolfgang.Dobler@kis.uni-freiburg.de)
%%  Description:
%     User manual for the MHD code 
%   Process with:
%     latex manual
%     makeindex manual
%     latex manual

\ifx\pdfoutput\undefined        % not running pdflatex
  \documentclass[12pt,twoside,notitlepage,a4paper]{article}
\else                           % running pdflatex
  \documentclass[pdftex,12pt,twoside,notitlepage,a4paper]{article}
\fi

%\usepackage{url} %(do we not need this; but it's not working anyway)
\usepackage[bookmarks=false]{hyperref}
%\usepackage{german,a4}
%\usepackage[german,british]{babel}
\usepackage[latin1]{inputenc}
%\usepackage[T1]{fontenc}
%\usepackage{ae}                 % To get good PDF with the T1 encoding
\usepackage{newcent,helvet}
\renewcommand{\ttdefault}{cmtt} % Courier is too broad
\usepackage{amsmath}

\usepackage{makeidx}

\usepackage[it,footnotesize]{caption2}
\setlength{\abovecaptionskip}{5pt} % Space before caption
\setlength{\belowcaptionskip}{5pt} % Space after caption

\usepackage[bf,sf,small,nonindentfirst]{titlesec}
\newcommand{\sectionbreak}{\clearpage}
%\titleformat{\subsubsection}{\normalfontitshape}{\thesubsubsection}{.5em}{}
%\titlespacing{\subsubsection}{0pt}{*1}{*-1}
\usepackage{fancyhdr}
\usepackage{fancybox}
\setcounter{tocdepth}{6} % Older versions of fancybox very annoyingly (and
                         % unnecessarily) resets this and make table of
                         % contents disappear

\usepackage{booktabs}
\usepackage{longtable}

\usepackage{fancyvrb}
\usepackage{alltt}

\usepackage{graphicx}
\usepackage{parskip,a4,vmargin}
%\setpapersize{A4}  %AB: what if somebody prints it in Santa Barbara?
%\setmargrb{20mm}{15mm}{20mm}{15mm}
\setmargrb{20mm}{25mm}{20mm}{15mm}  %AB: just trying to adjust it for here.

\frenchspacing
\sloppy

\makeindex


%%% Page headings
\pagestyle{fancy}
\renewcommand{\sectionmark}[1]{% Don't upcase the section title
  \markright{\thesection.\ #1}}
\fancyhead{}                    % clear header
\fancyhead[LE,RO]{\thepage}
\fancyhead[CE]{\textsc{The MHD code}}
\fancyhead[CO]{\rightmark}
%
\fancyfoot{}

% ---------------------------------------------------------------------- %

%%% Macros

%% Bold face \tt prompts (only works within `alltt' or \tt environment)
\newcommand{\prompt}[1]{{\ttfamily\bfseries{}#1}}

%% Margin and inline notes and remarks
\newcommand\note[1]{\marginpar{\renewcommand{\baselinestretch}{0.8}
        \raggedright\scriptsize\usefont{OT1}{phv}{mc}{n} #1}}
\newcommand{\Note}[1]{\emph{[#1]}}


%% keys, names, paths, files, etc.
\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\kbd}[1]{\texttt{\textsl{#1}\/}}
\newcommand{\key}[1]{{\setlength{\fboxsep}{1pt}\ovalbox{\sf #1}}}
\newcommand{\samp}[1]{`\code{#1}'}
\newcommand{\var}[1]{\textsl{#1}\index{#1@\emph{#1}}\/}
\newcommand{\env}[1]{\code{#1}\index{#1@\emph{#1}}}
\newcommand{\file}[1]{`\texttt{#1}'}
\newcommand{\command}[1]{\code{#1}\index{#1}}
\newcommand{\cmd}[1]{\command{#1}}
\newcommand{\option}[1]{`\code{#1}'\index{#1@\emph{`#1'} option}}
\newcommand{\dfn}[1]{\textsl{#1}\index{#1}\/}
%\newcommand{\cite}[1]{}
\newcommand{\acronym}[1]{\textsc{#1}\index{#1}}
%\newcommand{\url}[1]{}
\newcommand{\email}[1]{\code{#1}}

\newcommand{\name}[1]{\textsl{#1}\index{#1}\/}
\newcommand{\Path}[1]{\file{#1}}

%
\newcommand{\bsT}{{\fontencoding{T1}\selectfont{\symbol{92}}}}
\newcommand{\bcks}{{\symbol{92}}}
\newcommand{\bs}{\bcks}       % Save us creation of a couple of fonts

%% Maths operators
% \newcommand{\arcosh} {\mathop{\rm arcosh}\nolimits}
% \newcommand{\arcoth} {\mathop{\rm arcoth}\nolimits}
\newcommand{\atanh} {\mathop{\rm atanh}\nolimits}
% \newcommand{\sgn}    {\mathop{\rm sgn}\nolimits}
\newcommand{\grad}    {\mathop{\rm grad}\nolimits}
\newcommand{\Div}     {\mathop{\rm div}\nolimits}
\newcommand{\curl}    {\mathop{\rm curl}\nolimits}
\newcommand{\rot}     {\curl}
\newcommand{\Laplace} {\mathop{\Delta}\nolimits}
\newcommand{\erfc}    {\mathop{\rm erfc}\nolimits}
\newcommand{\erf}     {\mathop{\rm erf}\nolimits}

\newcommand{\vekt}[1] {\mathbf{#1}}
\newcommand{\const}   {\mbox{\rm const}}

%% Maths variables
\newcommand{\Av}            {\vekt{A}}
% \newcommand{\av}            {\vekt{a}}

\newcommand{\Bv}            {\vekt{B}}
% \newcommand{\bv}            {\vekt{b}}

\newcommand{\Cool}          {{\cal C}}
\newcommand{\cs}            {c_{\rm s}}
\newcommand{\csnull}        {c_{{\rm s},0}}

% \newcommand{\Ev}            {\vekt{E}}
% \newcommand{\ev}            {\vekt{e}}
% \newcommand{\ex}            {\ev_{x}}
% \newcommand{\ey}            {\ev_{y}}
% \newcommand{\ez}            {\ev_{z}}

% \newcommand{\Fv}            {\vekt{F}}

\newcommand{\gv}            {\vekt{g}}

\newcommand{\Heat}          {{\cal H}}
\newcommand{\Heavi}         {\theta}

\newcommand{\jv}            {\vekt{j}}

% \newcommand{\nullvekt}      {\vekt{0}}

\newcommand{\Ra}            {\mathrm{Ra}}
\newcommand{\Reynolds}      {\mathrm{Re}}
\newcommand{\Rm}            {\mathrm{Rm}}

\newcommand{\uv}            {\vekt{u}}

% \newcommand{\Vol}           {{\cal V}}
\newcommand{\vA}            {v_{\rm A}}

\newcommand{\xv}            {\vekt{x}}

% \newcommand{\zerovect}      {\nullvekt}

\newcommand{\uu}{\mbox{\boldmath $u$} {}}
\newcommand{\oo}{\mbox{\boldmath $\omega$} {}}
\newcommand{\bra}[1]{\langle #1\rangle}

% ---------------------------------------------------------------------- %

\title{{\sffamily\bfseries Installing and Using the High-Order MHD MPI code}}
%\subtitle{A very preliminary manual}
\author{Wolfgang Dobler \& Axel Brandenburg}
\date{\today,~ $ $Revision: 1.28 $ $}

% ====================================================================== %

\begin{document}
\pagestyle{empty}

%\maketitle

\begin{titlepage}
  \begin{center}

  \large

  \vspace*{3cm}

  {\Large\sffamily\bfseries PENCIL--MPI: A High-Order MPI code for MHD Turbulence}

  \vspace{0.5cm}

  {\sffamily Documentation and Results of Test Problems}

  \vspace{1.5cm}

  {Wolfgang Dobler \& Axel Brandenburg}


  \vspace{2cm}

  \emph{\today,~ $ $Revision: 1.28 $ $}


\end{center}

\end{titlepage}


\newpage
\mbox{}
\vfill

Copyright \copyright{} 2001,2002 Wolfgang Dobler \& Axel Brandenburg
\bigskip

Permission is granted to make and distribute verbatim copies of
this manual provided the copyright notice and this permission notice
are preserved on all copies.

Permission is granted to copy and distribute modified versions
of this manual under the conditions for verbatim copying,
provided that the entire resulting derived work is distributed under the
terms of a permission notice identical to this one.


\clearpage
\pagestyle{plain}
\pagenumbering{roman}

\section*{Foreword}

This code was originally developed at the Turbulence Summer School of the
Helmholtz Institute in Potsdam (2001).
Often people asked us whether our code is publicly available.
Although in many fields of research codes are publicly available
(e.g.\ some SPH and PPM codes), this does not generally seem to be
the case for higher order meshpoint or spectral codes.
That's why we decided to make it a bit more user friendly (than it was before)
and to put it on a public cvs repository.

The code is primarily designed to deal with weakly compressible turbulent
flows: that's why we use high-order first and second derivatives.
In order for the code to be easily parallelizable we use explicit
(as opposed to compact) finite differences.
Typical scientific targets include driven MHD turbulence in a periodic box,
convection in a slab with non-periodic upper and lower boundaries,
a convective star embedded in a fully nonperiodic box, accretion disc turbulence in
the sheering sheet approximation, etc.

We use the magnetic vector potential to ensure that the field
is always divergence-free. At the same time, having the magnetic
vector potential readily available is a tremendous advantage if
one wants to monitor the magnetic helicity, for example.
This code is therefore particularly well suited for all kind of
dynamo problems.

The code is non-conservative. Thus, conserved quantities should only be
conserved up to the discretization error of the scheme (not the machine accuracy).
There is no guarantee that a conservative code is more accurate with
respect to quantities that are not explicitly conserved, such as entropy.
Magnetic helicity is another important example of a quantity that is to
our knowledge not guaranteed to be conserved by ordinary flux conserving
schemes.

We don't have any immediate plans to implement adaptive mesh refinement
into the code. The main reason is that this would cause a major technical
complication. Moreover, turbulence is generically space-filling, so any
local refinement to smaller scales may not be useful. On the other hand,
turbulence may well be confined to certain regions in space, so one
could indeed gain by solving the outer regions with fewer points.
So we'll still keep that in mind.

In order to be cache-efficient and to allow the free use of temporary
variables without using up lots of memory, we solve the equations along
pencils in the $x$ direction. Ghost zones are used to implement boundary
conditions on physical and processor boundaries. The domain can be tiled
evenly in the $y$ and $z$ directions. MPI calls are used to communicate
between processors. For testing purposes a dummy version can be invoked
to run on just one processor (e.g.\ on a laptop or when \var{mpi}
is not available).

The various physics is invoked by linking the corresponding modules in the
Makefile. The main reason for this procedure is to have a convenient way
of stripping off extra ballast from the code, so it compiles faster and
uses less memory. It is also a convenient way of changing the physics
without using messy switches.

The parameter input file (\var{run.in}) is read whenever there exists the
file \file{RELOAD} in the run directory. This allows one
to change parameters on the fly. This can be useful if one
wants to stop the code in a graceful way at an earlier time,
if one wants to change the length of the time step,
the viscosity or other diffusion parameters,
or (in forced calculations) the sound speed. Obviously, in
some cases changing certain parameters on the fly could be totally crazy,
but it's up to the user to decide.
One can also change, on the fly, the format of some output diagnostics
and one can invoke new output diagnostics that might have been too time
consuming to calculate during the early relaxation phase. All this can
be done during the run, so one does not run the risk of losing ones
position in the queue.

We will be happy to include user-supplied changes and updates to the code
in future releases, so please get in touch with us.

\vspace{5mm}
%\noindent
\url{Wolfgang.Dobler@kis.uni-freiburg.de}\hfill Freiburg\\
\url{Axel.Brandenburg@nordita.dk}\hfill Copenhagen

\tableofcontents
\clearpage
\pagestyle{fancy}
\pagenumbering{arabic}


% ====================================================================== %

\section{Obtaining the Code}

To obtain the MHD code, you should use \name{CVS} (concurrent version
system, see \url{http://www.cvshome.org/}).
You proceed as follows:

\begin{enumerate}

\item Get a \name{CVS} client from \url{http://www.cvshome.org/} and
  install it (on your laptop and any other machine you want to run on).
  Alternatively, just copy the executable from a binary compatible
  machine.

\item Get the password for anonymous \name{CVS} access to the MHD code
\footnote{Wolfgang, we should make this automatically. Ideally, a new user
should be able to register on our web site and get a password automatically.
This needs then to be automatically put into the cvs passwd file.}

\item Set your environment variable \env{CVSROOT} (you probably want to
  put this into your \file{.cshrc} or \file{.profile} setup files):
  \begin{alltt}
  \prompt{csh> } setenv CVSROOT :pserver:anonymous@norserv.nordita.dk:/home/brandenb/CVS \
  \end{alltt}
  or (if you are running bash)
  \begin{alltt}
  \prompt{sh> } CVSROOT=:pserver:anonymous@norserv.nordita.dk:/home/brandenb/CVS
  \prompt{sh> } export CVSROOT \
  \end{alltt}

\item Log in:
  \begin{alltt}
  \prompt{unix> } cvs login
  cvs password: ........ \
\end{alltt}
(you only need to do this once; your cvs password is being saved in
a \file{.cvspass} file in your home directory).

\item Go to wherever you want the code:
  \begin{alltt}
  \prompt{unix> } cd \file{somewhere} \
  \end{alltt}

\item Check the code out:
  \begin{alltt}
  \prompt{unix> } cvs checkout -d mhd f90/pencil_modular \
  \end{alltt} 
  This creates a subdirectory \file{mhd} of your current directory
  \file{somewhere} and populates it with the MHD code's subdirectories.

\end{enumerate}


% ====================================================================== %

\section{Getting Started}

To get yourself started, you should run one of several examples which are
provided in one of the runs/sample subdirectory.

It is absolutely mandatory to monitor exactly what one is doing.
IDL is a very useful tool to inspect the data in a very flexible fashion.
(For details about the use of idl, see Sect.~\ref{S_IDLroutines}.)

\subsection{A first test}

Before explaining details of the code, we want to make sure it runs ok.
We want to have a simple example (periodic, isothermal, non-forced)
where the physics is already nontrivial.

\subsubsection{Interlocked flux rings}

\prompt{unix> } cd f90/pencil\_modular\\
\prompt{unix> } source source\_me \quad\#(to put f90/pencil\_modular/bin into your path)\\
\prompt{unix> } cd runs/sample/rings\\
\prompt{unix> } lnsrc \quad\#(make sure your ../../../bin is in your path!)\\
\prompt{unix> } cd src\\
\prompt{unix> } make\\
\prompt{unix> } cd ..\\
\prompt{unix> } mkdir tmp \quad\#(or link some data disc to tmp)\\
\prompt{unix> } start.csh\\
\prompt{unix> } run.csh\\

EXPLAIN: isotrop1, plan to set-up vortex rings as initial condition,
without magnetic fields etc.

\subsection{Other test problems}

1-D sound waves and shock tube tests, interlocked pair of flux rings, stably stratified atmosphere.

% ====================================================================== %

\section{Code structure}

% ---------------------------------------------------------------------- %

\subsection{Directory tree}

Under \file{f90/pencil\_modular}, there are currently the following
files and directories:
\begin{verbatim}
brandenb@nl3:/home/brandenb/f90/pencil_modular> ls -csF
total 48
   4 doc/     4 dx/       4 idl/     4 TODO     4 source_me     4 README
   4 CVS/     4 bugs/     4 src/     4 bin/     4 runs/         4 dependencies.dot
\end{verbatim}

The code is contained in \file{src/}, but in order to keep things tidy we compile
it separately for each run underneath the corresponding run directories, which
are all included in \file{runs/}.

General purpose auxiliary routines for \var{idl} (which is commercial) or
\var{dx} (data explorer with is freeware) are in the \file{idl} and \file{dx}
directives, respectively.

For each run, we tend to save the \file{*.in} and \file{src/*.local}
files under \var{cvs}. This allows everybody to reproduce a particular
run. When the files are changed with time, the history is also saved
under \var{cvs}. In order to keep the run directory tidy, we put
in \file{runs} different problem {\it classes}, e.g.\
\begin{verbatim}
brandenb@nl3:/home/brandenb/f90/pencil_modular> ls -csF
total 40
   4 gravz/         4 forced/     4 OLD/           4 README        4 old/
   4 buoy_tube/     4 CVS/        4 kinematic/     4 1d-tests/     4 rings/
\end{verbatim}

The directory \file{forced/} contains some forced turbulence runs (both magnetic
and nonmagnetic). \file{gravz/} contains runs with vertical gravity, \file{rings/}
contains decaying mhd problems (interlocked flux rings as initial condition, for
example), and \file{kinematic/} contains kinematic dynamo problems where the
hydrodynamics is turned off entirely.

In all these cases the input files are usually kept at a minimum, so most of the
quantities are already initialized by default values. If you want to run a particular
problem, the best will be to start by modifying a particular example which is closest
to yours.

% ----------------------------------------------------------------------------- %

\subsection{Basic concepts}


\subsubsection{Data access in pencils}
\index{pencil design}

\subsubsection{Modules}
\index{modules}

Each run directory has a \file{src/Makefile.local} file which tells you
whether or not entropy, magnetic fields, hydrodynamics, density, forcing,
or gravity are invoked. Many possible combinations have already been tested
and examples are all checked in, but you may come up with interesting
combinations which were never tested and may not yet work. We hope that
the necessary modifications don't affect the other routines too much and
that we can document them in future releases. Please let us know!

\subsubsection{Localization (adapt-mkfile)}



% ====================================================================== %

\section{The Equations}

The equations solved by the MHD code are basically the standard
compressible MHD equations. However, the modular structure allows
some variations of the MHD equations, as well as to switch
some of the equations off (nomagnetic, noentropy).

% ---------------------------------------------------------------------- %

\subsection{Continuity equation}

\begin{equation}
  \frac{D\ln\varrho}{Dt}
  = - \Div\uv \; .
\end{equation}

Here $\varrho$ denotes density, $\uv$ the fluid velocity, $t$ is time and
$D/Dt \equiv \partial/\partial t + \uv\cdot\grad$ is the convective
derivative.

% ---------------------------------------------------------------------- %

\subsection{Equation of motion}

\begin{equation}
  \frac{D\uv}{Dt}
   =  -\cs^2\grad\biggl(\frac{s}{c_p} + \ln\varrho\biggr)
      - \grad\Phi
      + \frac{\jv\times\Bv}{\varrho}
      + \nu \left( \Laplace\uv + \frac{1}{3}\grad\Div\uv \right) \; .
\end{equation}
Here, $\cs^2 = \gamma p/\varrho$ is the squared sound speed,
$\gamma=c_p/c_v$ the ratio of specific heats of \emph{adiabatic index},
$\Phi$ is the gravity potential, $\jv$ the electric current density, $\Bv$
the magnetic flux density, and $\nu$ is kinematic viscosity.
Note that the viscous term used here is only correct if the dynamical
viscosity $\mu \equiv \varrho\nu = \const$ everywhere.


% ---------------------------------------------------------------------- %
\subsection{Induction equation}

\begin{equation}
  \frac{\partial\Av}{\partial t}
  = \uv\times\Bv - \eta\mu_0\jv \; .
\end{equation}

Here $\Av$ is the magnetic vector potential\index{vector potential},
$\Bv = \curl\Av$ the magnetic
flux density, $\eta = 1/(\mu_0\sigma)$ is the magnetic diffusivity
($\sigma$ denoting the electrical conductivity), and $\mu_0$ the
magnetic vacuum permeability.


% ---------------------------------------------------------------------- %

\subsection{Entropy equation}
\index{entropy}

The current thermodynamics module \file{entropy} formulates the thermal
part of the physics in terms of \emph{entropy} $s$, rather than thermal
energy $e$, which you may be more familiar with.
Thus the two fundamental thermodynamical variables are $\ln\varrho$
and $s$.
The reason for this choice of variables is that entropy is the natural
physical variable for (at least) convection processes: the sign of the
entropy gradient determines convective (in)stability, the
\emph{Rayleigh number} is proportional to the entropy gradient
of the associated hystrostatic reference solution, etc.

\begin{equation}
  \varrho T\frac{Ds}{Dt}
   =  \Heat - \Cool
      + \Div(\lambda\grad T)
      + \eta\mu_0 \jv^2
      + 2\varrho\nu {\sf S}^2 \; .
\end{equation}

Here, $T$ is temperature, $c_p$ the specific heat at constant pressure,
$\Heat$ and $\Cool$ are explicit heating and cooling terms,
$\lambda$ is the thermal conductivity, and
\begin{equation}
  {\sf S}_{ik} = \frac{\partial_i u_k + \partial_k u_i}{2}
                 -\frac{1}{3} \delta_{ik}\Div\uv
\end{equation}
is the traceless rate of strain tensor.

\bigskip

Note that by setting $\gamma=1$ and initially $s=0$, one obtains an
isothermal equation of state (albeit at some unnecessary expense of
memory).
Similarly, by switching of the evolution terms of entropy, one immediately
gets polytropic behavior (if $s$ was initially constant) or generalised
polytropic behavior
(where $s$ is not uniform, but $\partial s/\partial t = 0$).


% ====================================================================== %

\section{Boundary conditions}


% ====================================================================== %

\section{Using the Code}
\label{Input-params}

Here's how to use the code \ldots

% ---------------------------------------------------------------------- %
\subsection{I/O diagnostics}

The code allows various output diagnostics to be turned on and off
(even during the run!) by just changing the contents of the file
\file{print.in}. A simple example would be\\

\begin{verbatim}
t(f10.3)
u2m(1pe13.4)
oum
~
~
"print.in"
\end{verbatim}
\vspace{1em}

\noindent
which means that the output table will contain time \file{t} in the first
column with format \var{'(f10.3)'}, followed by the mean squared velocity,
$\bra{\uu^2}$, \file{u2m} in the second column with format \var{'(1pe13.4)'},
and the kinetic helicity, $\bra{\oo\cdot\uu}$,  \file{oum} in the last column
with the default format \var{'(1pe10.2)'}.

In the \file{zaver.in}, $z$-dependent (horizontal) averages are listed.
They are written in the file \file{tmp/zaverages.dat}. At the moment we
can also output in \file{print.in} the associated mean square value
of the horizontal field, but this requires that in \file{zaver.in} the
quantities \code{bxmz} and \code{bymz} are set.

% ---------------------------------------------------------------------- %
\subsection{Helper scripts}
\index{Perl}

% ---------------------------------------------------------------------- %
\subsection{RELOAD and STOP files}

The code periodically checks (exactly every \var{it} time steps)
for the existence of two files, \file{RELOAD}
and \file{STOP}, which can be used to trigger certain behavior.

\paragraph{Reloading run parameters}
In the run directory from where you started the code, create the file
\file{RELOAD} with
\begin{alltt}
  \prompt{unix> } touch RELOAD \
\end{alltt}
to force the code to re-read the runtime parameters from \file{run.in}.
This will happen the next time the code is writing monitoring output (the
frequency of this happening is controlled by the input parameter \var{it},
see \S\ref{start-params}).

\paragraph{Stopping the code}
In the run directory from where you started the code, create the file
\file{STOP} with
\begin{alltt}
  \prompt{unix> } touch STOP \
\end{alltt}
to stop the code in a controlled manner (it will write the latest
snapshot).
Again, the action will happen the next time the code is writing monitoring
output.


% ---------------------------------------------------------------------- %
\subsection{IDL routines}
\label{S_IDLroutines}

Basic sequence:
\begin{alltt}
  \prompt{unix> } idl
  \prompt{IDL> }  .run start
  \prompt{IDL> }  .run r
  \prompt{IDL> }  {\sf[specific commands]} \
\end{alltt}
You call \file{start.pro} once to initialize the fields and read in the
startup parameters from the code.
Each time you want to read in a new snapshot, you run \file{r.pro},
possibly after adjusting the IDL variable \var{file} to a specific snapshot
file; by default, the file \file{var.dat} in the data directory will be
read, which is overwritten with new data in regular intervals.

If the data are scattered over different processors and you want to
reassemble everything into one file, you say
\begin{alltt}
  \prompt{IDL> }  .r rall
\end{alltt}
Here, \file{.r} is a shorthand for \file{.run} which \file{idl} understands.
The procedure \file{rall} reads (and assembles) the data from all processors.
If one wants to look at just one processor, use the routine \file{r} instead.

If you need the magnetic field or the current density, you can calculate
it in idl by saying
\begin{alltt}
  \prompt{IDL> }  bb=curl(aa)
  \prompt{IDL> }  jj=curl2(aa)
\end{alltt}

By default the one is reading always the latest time corresponding to the file
\file{var.dat}. If you want to read any earlier snapshots, you say (for example)
\begin{alltt}
  \prompt{IDL> }  file='VAR2  ;(by the way, the second quote is not needed!)
  \prompt{IDL> }  .r rall
  \prompt{IDL> }  print,t
\end{alltt}
and it will get the data from all processors from that snapshot.

To discuss:
\begin{itemize}
\item availability of IDL (demo version; Pvwave; Ana)?
\item setup (include \file{../idl} and \file{../../idl} (?) in \var{!path})
\item how to get our IDL routines
\end{itemize}


% ---------------------------------------------------------------------- %
\subsection{Start parameters}
\label{start-params}

Here is a list of parameters that are set in \file{start.in}

Any variable referred to as a \dfn{flag} can be set to any nonzero value
to switch the corresponding feature on.

Not all parameters are used for a given scenario.


% ---------------------------------------------------------------------- %
\begin{longtable}{lp{0.6\textwidth}}
%\begin{tabular}{lp{0.6\textwidth}}
\toprule
  \multicolumn{1}{c}{\emph{Variable}}
               & \multicolumn{1}{c}{\emph{Meaning}} \\
\midrule
  \var{ip}     & (anti-)verbosity level: \code{ip=1} produces lots of
                 diagnostic output, \code{ip=14} virtually none. \\
  \var{[x-z]0},
  \var{L[x-z]},
  \var{iper[x-z]},
               & determine the geometry of the box.
                 If \code{iperx=0} (box \emph{not\/} periodic in $x$), $x$
                 ranges from $x_0$ to $x_0+L_x$; if \code{iperx=1}
                 (periodic box in $x$), the rightmost point is
                 $x_0+L_x-\delta x$. In all cases, three ghost zones will
                 be added. \\
  \var{z1}, \var{z2}, \var{ztop}
               & specific to the solar convection case.
                 The stable layer is $z_0 < z < z_1$, the unstable layer
                 $z_1 < z < z_2$, and the top (isothermal) layer is
                 $z_2 < z < z_{\rm top}$
                 \Note{How is this related to $L_z$??} \\
  \var{hcond[0-2]}, \var{whcond}
               & specific to the solar convection case: heat conductivities
                 $\lambda$ in the individual layers. \var{hcond0} is the
                 value $\lambda_{\rm unst}$ in the unstable layer,
                 \var{hcond1} is the ratio
                 $\lambda_{\rm stab}/\lambda_{\rm unst}$ for the stable
                 layer, and \var{hcond2} is the ratio 
                 $\lambda_{\rm top}/\lambda_{\rm unst}$ for the top layer.
                 The function $\lambda(z)$ is not discontinuous, as the
                 transition between the different values is smoothed over
                 the width \var{whcond}. \\
  \var{mpoly[0-2]}, \var{isothtop}
               & specific to the solar convection case: polytropic indices
                 of unstable (\var{mpoly0}), stable (\var{mpoly1}) and top
                 layer (\var{mpoly2}).
                 If the flag \var{isothtop} is set, the
                 top layer is initialized to be isothermal, otherwise
                 thermal (plus hydrostatic) equilibrium is assumed for all
                 three layers, which results in a piecewise polytropic
                 stratification. \\
  \var{ampl}   & ??? \\
  \var{init}   & ??? \\
  \var{urand}  & amplitude of initial random velocity fluctuations \\
  \var{gamma}  & adiabatic index of the gas (typically $\gamma=5/3$ in
                 astrophysical applications \\
  \var{cs0}, \var{rho0}
               & reference values of sound speed $\cs$ and density
                 $\varrho$. In the convection case, these are the values of
                 $\cs$ and $\varrho$ at $z=z_{\rm top}$. \\
  \var{gravz}  & vertical gravity $g_z$; normally $<0$. \\
  \var{grads0} & [Not used for convection reference case] initial entropy
                 gradient. \\
\bottomrule
%\end{tabular}
\end{longtable}
% ---------------------------------------------------------------------- %


% ---------------------------------------------------------------------- %
\subsection{Run parameters}
\label{Run-params}

Here is a list of parameters that are set in \file{run.in}.

Note that formatted \name{Fortran} input allows for parameters to be
skipped (indicated by possible whitespace, followed by a comma), which
causes the corresponding variable to retain the value it had before the
\cmd{read} command was called.
In most cases, this default value will be the one set in \file{start.in}.

Any variable referred to as a \dfn{flag} can be set to any nonzero value
to switch the corresponding feature on.

Not all parameters are used for a given scenario.


% ---------------------------------------------------------------------- %
\begin{longtable}{lp{0.6\textwidth}}
\toprule
  \multicolumn{1}{c}{\emph{Variable}}
               & \multicolumn{1}{c}{\emph{Meaning}} \\
\midrule
  \var{nt}     & number of time steps to carry out. \\
  \var{it1}    & write monitoring output every \var{it1} time steps.\\
  \var{dt}     & time step $\delta t$ (if set and different from zero).\\
  \var{cdt}    & CFL (or Courant) coefficient,
                 $\delta t/\delta t_{\rm Courant}$. A typical
                 value is \code{cdt=0.4}. Using less can be useful as a
                 temporary fix until the source of the problem is found.\\
  \var{cdtv}   & viscous time step; actual time step is given by
                 \begin{equation}
                   \delta t
                   = \min\left( c_{\delta t}\frac{\delta x_{\rm min}}
                                     {U_{\rm max}} ,
                                c_{\delta t_v}
                                \frac{\delta x_{\rm min}^2}
                                     {D_{\rm max}}
                         \right) \; ,
                 \end{equation}
                 where
                 $\delta x_{\rm min} \equiv \min(\delta x, \delta y, \delta z)$;
                 $U_{\rm max} \equiv \max\left(|\uv|
                                     + \sqrt{\cs^2{+}\vA^2}\right)$,
                 $\cs$ and $\vA$ denoting sound speed and Alfv\'en speed,
                 respectively;
                 and $D_{\rm max} = \max(\nu,\chi,\eta)$, where
                 $\nu$ denotes kinematic viscosity,
                 $\chi = \lambda/(c_p\varrho)$ thermal diffusivity and
                 $\eta$ the magnetic diffusivity.
                 \\
  \var{isave}  & update snapshot file \file{var.dat} every \var{isave}
                 time steps. \\
  \var{iorder} & order of time step. Set \code{iorder=1} for Euler
                 stepping, \code{iorder=3} for the 3rd-order Runge-Kutta
                 (2$N$) scheme. \code{iorder=1} is useful for debugging,
                 because one wants to know what happens after the first
                 or second step. \code{iorder=2} is also possible, but
                 not \code{iorder>3}.\\
  \var{dsnap}  & save full snapshots \file{VAR$N$} every \var{dsnap} time
                 units. \\
  \var{dvid}   & write two-dimensional sections for generation of videos
                 every \var{dsnap} time units. \\
  \var{dtmin}  & abort if time step $\delta t < \delta t_{\rm min}$. \\
  \var{tinit}  & ??? \\
  \var{tdamp}  & damp velocities in the initial time interval
                 $0 < t < t_{\rm damp}$. \\
  \var{dampu}  & strength of initial damping of velocity. \\
  \var{dampuext}, \var{rdamp}, \var{wdamp}
               & permanently damp velocities at $|\xv| > r_{\rm damp}$
                 with strength \var{dampuext}, with a smooth transition
                 between damped and undamped of radial width \var{wdamp}. \\
  \var{ip}     & (anti-)verbosity level: \code{ip=1} produces lots of
                 diagnostic output, \code{ip=14} virtually none. \\
  \var{i[x-z]} & monitor values of some variables in point with indices
                 $(i_x,i_y,i_z)$. \\
  \var{cs}, \var{rho}
               & reference values of sound speed $\cs$ and density
                 $\varrho$. In the convection case, these are the values of
                 $\cs$ and $\varrho$ at $z=z_{\rm top}$. \\
  \var{ivisc}  & switch for viscosity term
                 \Note{which value gives which term?} \\
  \var{hcond[0-2]}, \var{whcond}
               & heat conductivities, see Sec~\ref{Input-params}; leave
                 these empty unless you want to override the settings from
                 \file{start.in}. \\
  \var{cdiffrho}
               & ??? \\
  \var{gravz}  & vertical gravity, see Sec~\ref{Input-params}; leave
                 this empty unless you want to override the setting from
                 \file{start.in}. \\
  \var{cheat}, \var{wheat}
               & heating term: add total amount \var{cheat} of heat per
                 time unit in zone near bottom of width \var{wheat}.
                 You probably rather want to use \var{Fheat} (see below). \\
  \var{cool}, \var{wcool}
               & cooling term: cool top layer of width \var{wcool} to
                 reference temperature (given by ${\cs}_0$) by cooling term
                 of strength \var{cool}. \\
  \var{Fheat}  & heat flux through bottom boundary. \\
  \var{iforce}, \var{force}, \var{relhel}
               & on-off flag, strength and kinetic helicity of forcing
                 terms. \\
  \var{bc[x-z]}
               & boundary conditions. Set these to a sequence of letters 
                 like `p,p,p,p,p,p,p,p' for periodic boundaries, or
                 `s,s,a,a2,c1:c2,s,s,a' for non-periodic ones.
                 Each entry (between commas) corresponds to one of the
                 variables, normally these are $u_x$, $u_y$, $u_z$,
                 $\ln\varrho$, $s/c_p$, $A_x$, $A_x$ and $A_x$, in this
                 order.
                 \begin{description}
                 \item[\option{p}] indicates periodicity
                 \item[\option{a}] indicates antisymmetry w.\,r.\,t.~the
                   boundary, i.\,e.~vanishing value
                 \item[\option{s}] indicates symmetry w.\,r.\,t.~the
                   boundary, i.\,e.~vanishing first derivative
                 \item[\option{a2}] indicates antisymmetry w.\,r.\,t.~the
                   arbitrary value on the boundary, i.\,e.~vanishing
                   second derivative
                 \item[\option{c1}] is a special boundary condition for
                   $\ln\varrho$ and $s$, which ensures constant heat flux
                   through the boundary
                 \item[\option{c2}] is a special boundary condition for
                   $\ln\varrho$ and $s$, which ensures constant
                   temperature at the boundary 
                 \end{description}
                 The special syntax $a$:$b$ (e.\,g.~`\code{c1:c2}') means: use
                 boundary condition $a$ at the left/lower boundary, but
                 $b$ at the right/upper one. 
                 \\
  \var{form1}  & format for monitoring output. typically something like
                 \code{'(i8,f11.5,1p,50(e10.3," "))'} for printing number
                 of time step, time, and then a lot of different
                 quantities. Make sure you allow for sufficiently many
                 quantities here (you can always use a large multiplier to
                 be on the safe side). \\
\bottomrule
\end{longtable}


% ---------------------------------------------------------------------- %
\subsection{Output files}

\begin{itemize}
\item \file{tmp/n.dat}, file{output diagnostics, depends on what is put in print.in}
\item \file{tsnap.dat}, \file{tvid.dat}
\item \file{tmp/dim.dat}
\item \file{tmp/param.dat} \file{tmp/param2.dat}
\item \file{tmp/proc\emph{X}/var.dat} --- detailed format
\item \file{tmp/proc\emph{X}/VAR\emph{N}} --- same format as
      \file{tmp/proc\emph{X}/var.dat}
\item \file{tmp/proc\emph{X}/seed.dat} --- seed field for forcing
      procedure: must be the same for all processors, because globally
      coherent waves of given wavenumber are used
\item \file{tmp/density.pro}, \file{tmp/hydro.pro}, \file{tmp/entropy.pro},
      \file{tmp/magnetic.pro} --- can be used as include file in \var{idl}
      and contains the column in which certain variables appear in the
      diagnostics file (\file{n.dat}). It also contains the positions of
      variables in the \file{VAR} files. These positions depend on whether
      \var{entropy} or \var{noentropy}, etc, are invoked.
\end{itemize}


% ====================================================================== %

\section{Some specific initial conditions}

\subsection{Random magnetic fields: \var{initaa=0}}

The $\Av$-vector is set to a random variable with gaussian statistics
at all meshpoints and for all three components. The power spectrum of
$\Av$ increases then quadratically with wavenumber $k$ (without cutoff)
and the powerspectrum of $\Bv$ increases like $k^4$.

\subsection{Beltrami fields: \var{initaa=1}}

\begin{equation}
%\Av=\pmatrix{\cos z\cr\sin z\cr0}
\Av=(\cos z,\;\sin z,\;0)
\label{Betrami}
\end{equation}

% ---------------------------------------------------------------------- %
\subsection{Magnetic flux rings}

This initial condition sets up two interlocked thin magnetic tori
(i.\,e.~thin, torus-shaped magnetic flux tubes).
One torus of radius $R$ lying in the plane $z=0$ can be described in
cylindrical coordinates by the
vector potential
\begin{equation} \label{Av-flux-ring-cyl}
  \Av = 
  \Phi_{\rm m}
  \begin{pmatrix}
    0\\ 0\\ -\Heavi(r{-}R) \delta(z)
  \end{pmatrix} \; ,
\end{equation}
resulting in a magnetic field
\begin{equation}
  \Bv = 
  \Phi_{\rm m}
  \begin{pmatrix}
    0\\ \delta(r{-}R) \delta(z)\\ 0
  \end{pmatrix} \; .
\end{equation}
Here $\Phi_{\rm m}$ is the magnetic flux through the tube,
$\Heavi(x)$ denotes the Heaviside function, and
\begin{equation} \label{Heavi-Dirac}
 \delta(x) = \Heavi'(x)
\end{equation}
is Dirac's delta function.

Any smoothed versions of $\Heavi(x)$ and $\delta(x)$ will do, as long as
the consistency condition (\ref{Heavi-Dirac}) is satisfied.
E.\,g.~the pairs
\begin{equation}
  \delta_\varepsilon(x)
  = \frac{1}{\sqrt{2\pi\varepsilon^2}} e^{-\frac{x^2}{2\varepsilon^2}} \; ,
  \quad
  \Heavi_\varepsilon(x)
  = \frac{1}{2} \left( 1 + \erf\frac{x}{\sqrt{2}\varepsilon} \right)
\end{equation}
or
\begin{equation}
  \delta_\varepsilon(x)
  = \frac{1}{2\varepsilon}\frac{1}{\cosh^2\frac{x}{\varepsilon}} \; ,
  \quad
  \Heavi_\varepsilon(x)
  = \frac{1}{2} \left( 1 + \tanh\frac{x}{\varepsilon} \right)
\end{equation}
are quite popular.

In Cartesian coordinates, the vector potential (\ref{Av-flux-ring-cyl})
takes the form
\begin{equation} \label{Av-flux-ring-cart}
  \Av =
  \Phi_{\rm m}
  \begin{pmatrix}
    0\\ 0\\ -\Heavi \left( \sqrt{x^2{+}y^2}{-}R \right) \delta(z)
  \end{pmatrix} \; .
\end{equation}


% ====================================================================== %

\section{How to put new things into the code}

In some cases, the best will be
to write a new module that takes care of everything.
In many cases it will not be enough to just replace (in the Makefile)
an already existing module. Instead, it will often be necessary to
add new things into several other routines. In order to come back
to other cases (needed for regular tests of the code and for future
releases) it is important to supply also a corresponding dummy routine,
whose name will start with `no'.

\subsection{Adding new output diagnostics}

With the implementation of new physics and the development of new procedures
in the code it will become necessary to monitor new diagnostic quantities that
have not yet been implemented in the code. Here is what needs to be done.

The best will be to follow an example, e.g.\ \var{jbm}. Here only the
module Magnetic is being affected; say \file{grep jbm *.f90}. A corresponding
integer label with the name \var{i\_jbm} is defined (and initialized to zero).
Depending on whether this is the mean or a maximum value of the quantity
\var{jb}, which is calculated in a suitable place in the code, we use the
label \var{i\_jbm} in connection with the subroutine \code{sum\_mn\_name} or
\code{max\_mn\_name}. Here we use
\begin{verbatim}
        if (i_jbm/=0) call sum_mn_name(jb,i_jbm)
\end{verbatim}
In \file{register.f90} we \code{call rprint\_magnetic} where 
\begin{verbatim}
        call parse_name(iname,cname(iname),cform(iname),'jbm',i_jbm)
\end{verbatim}
has to be added to the list of names that are to be recognized from the
\file{print.in} file.

\subsection{Outputting new horizontal averages}

Currently, only the horizontally $xy$-averaged $x$ and $y$ components
of the magnetic field can be outputted. This is determined by the existence
and contents of the file \file{zaver.in}.
\footnote{May want to rename it to \file{xy\_aver.in}; what do you think?}
New such variables can be added by using the existing averaging
procedures as examples.

\subsection{Adding new evolution equations}

Example: passive scalar.

% ====================================================================== %

\section{Timings}

\begin{table}[htb]\caption{
Here we give the wall clock time per mesh point (excluding the ghost zones)
and per full 3-stage time step.
}\vspace{12pt}\centerline{\begin{tabular}{lccccccc}
proc(s)& machine            &  $\mu$s/pt/step & resol.\ & what & Size & when/who \\
\hline
1     & 500MHz linux (nl3)&  19  &  $64^3$ & kinematic    & 10 Mb  & (20-may-02/AB)\\
1     & 500MHz linux (nl3)&  30  &  $64^3$ & magn/noentro & 20 Mb  & (20-may-02/AB)\\
1     & 924MHz linux (nq1)&  10  &  $64^3$ & magn/noentro &        & (30-may-02/AB)\\
1     & Origin3000 (ukaff)& 9.2  &  $64^3$ & magn/noentro &        & (20-may-02/AB)\\
1     & Compaq (mhd)      & 7.8  &  $64^3$ & magn/noentro &        & (20-may-02/AB)\\
4     & linux nq0-3       & 6.8  & $256^3$ & magn/noentro & 294 Mb & (10-jun-02/AB)\\
4     & Compaq (mhd)      & 2.76 &  $64^3$ & magn/noentro &        & (30-may-02/AB)\\
8     & Origin3000 (ukaff)& 1.24 &  $64^3$ & magn/noentro &        & (20-may-02/AB)\\
16    & Origin3000 (ukaff)& 0.61 & $128^3$ & magn/noentro &?8.8 Gb & (22-may-02/AB)\\
16    & Origin3000 (ukaff)& 0.64 & $256^3$ & magn/noentro &        & (20-may-02/AB)\\
32    & Origin3000 (ukaff)& 0.34 & $256^3$ & magn/noentro &        & (20-may-02/AB)\\
32    & Origin3000 (ukaff)& 0.32 & $512^3$ & magn/noentro &        & (20-may-02/AB)\\
64    & Origin3000 (ukaff)& 0.17 & $512^3$ & magn/noentro &        & (21-may-02/AB)\\
\label{Ttimescale}\end{tabular}}\end{table}

Below we quote the wall clock time per mesh point (including the ghost zones)
and per full 3-stage time step.

Linux 500 MHz: 22 $\mu$s/pt/step in reference implementation (21-Mar-02/AB)
%CVS:  run.f90               version 1.18          of 2002/03/05 17:43:13 
%CVS:  register.f90          version 1.15          of 2002/03/08 15:43:19 
%CVS:  entropy.f90           version 1.33          of 2002/03/09 20:18:55 
%CVS:  magnetic.f90          version 1.6           of 2002/01/30 16:56:30 
%CVS:  grav_z.f90            version 1.5           of 2002/01/23 19:56:13 

Memory usage: 7.3 MB for $32\times32\times64$ MHD simulation.
%7288 with 32x32x64 (single processor, linux)
%print,38*38*71.*8.*2.*4./1e6



% ====================================================================== %

\section{Frequently Asked Questions}

\begin{description}

\item[Compilation stops with the cryptic error message]{\bfseries \ 
    
    \begin{Verbatim}
f95  -O3 -u -c .f90.f90
Error : Could not open sourcefile .f90.f90
compilation aborted for .f90.f90 (code 1)
make[1]: *** [.f90.o] Error 1
    \end{Verbatim}
  
    What is the problem?}
  \medskip


  One of the variables for the \file{makefile} has not been set, so
  \cmd{make} expands it to the empty string.
  Most probably you forgot to specify a module in
  \file{src/Makefile.local}. One possibility is that you have upgraded
  from an older version of the code that did not have some of the modules
  the new version has.
  
  Compare your \file{src/Makefile.local} to one of the examples that
  work.


\end{description}


% ====================================================================== %

\section{Experimenting with the \LaTeX{} macros}


\bs{}code:    \code{call remove\_file()}

\bs{}kbd:     \kbd{M-x comment-region}

\bs{}key:     \key{F1}

\bs{}samp:    \samp{a}, \samp{e}, \samp{i}, \samp{o}, \samp{u}

\bs{}var:     \var{ivisc}

\bs{}env:     \env{CVSROOT}

\bs{}file:    \file{~/tmp/var.dat}

\bs{}command: \command{rm -f *}

\bs{}option:  \option{-l}, \option{--long-listing}

\bs{}dfn:     A \dfn{definition} is a specification sufficiently obfuscated
          to be misunderstood 

\bs{}cite:    See \cite{Abramowitz & Stegun}

\bs{}acronym: \acronym{MNRAS}

\bs{}url:     \url{http://www.nowhere.net/second_page.html}

\bs{}email:   \email{nobody@nowhere.nil}




% ====================================================================== %

\printindex
\

\vfill\bigskip\noindent{\footnotesize\it
$ $Id: manual.tex,v 1.28 2002-06-13 07:24:06 brandenb Exp $ $}


\end{document}

% End of file manual.tex
