#!/bin/sh
#                      pc_setupsrc
#                     -------------
# Description:
#   Link files into a local src directory
#   Also link script files from the bin directory ==> should be renamed
#
# CVS:
#   $Id: pc_setupsrc,v 1.8 2006-02-28 01:42:31 dobler Exp $
#
# Usage:
#   setup-src [options] [src-dir]
# Options:
#   --pencil-home <dir>   Specify the root path of the Pencil Code directory

IAM=$0

link_scripts()
{
  echo "Linking job submission/execution scripts."
  for script in $scripts
  do
    if [ -e $bindir/$script ]; then
      [ -h ./$script ] && rm -f $script
      [ ! -e ./$script ] && ln -s $bindir/$script .
    else
      echo "No such file: $bindir/$script"
    fi 
  done
}

link_root_makefile()
{
  ## Make a link to a root Makefile to allow make from the run directory
  [ -h Makefile ] && rm -f Makefile 
  [ ! -e Makefile ] && ln -s $srcdir/Makefile.parent Makefile 
  echo Linked root Makefile.
}

make_src_dir()
{
  ## src subdirectory
  if [ ! -d $src ]; then
    echo "No src directory found: creating new one (`pwd`/src)."
    mkdir $src
  fi
}
#

link_src_files()
{
  #
  #  LINK all *.f90, *.f, and the Makefile to local src directory
  #
  echo "Linking files in '$src'."
  old_dir="`pwd`"
  cd $src
  n=0
  for file in $srcdir/*.f90 $srcdir/*.f $srcdir/*.c \
              $srcdir/Makefile.src $srcdir/Makefile.depend \
              $srcdir/.cvsignore $srcdir/*.h $srcdir/scripts \
              $srcdir/shock_profiles $srcdir/special
  do
    if [ -e $file ]; then
      if [ ! -e "`basename $file`" ]; then
        ln -s $file .
      else
        if [ -h "`basename $file`" ]; then
          rm -f "`basename $file`"
          ln -s $file .
        else
          n="`expr $n + 1`"
          existf="$existf`basename $file` "
        fi
      fi
    else
      echo "No such file: $file"
    fi
  done
  cd $old_dir
}

copy_local_files()
{
  #
  #  COPY all *.local files into local src directory
  #
  echo "Creating .local files in $src (if necessary)."
  old_dir="`pwd`"
  cd $src
  n=0
  for file in $srcdir/*.local
  do
    if [ -e $file ]; then
      if [ ! -e "`basename $file`" ]; then
	# Warn user about copying *.local, as these should normally come
	# with each run directory: 
	echo "Copying default file $file to src/ -- are you sure this is OK?"
        cp $file .
      else
        # echo "`basename $file` already exists"
        n="`expr $n + 1`"
        existf="$existf`basename $file` "
      fi
    else
      echo "No such file: $file"
    fi
  done
  cd $old_dir
}


print_status()
{
  [ $n -eq 1 ] &&  echo "$existf already existed in $src"
  [ $n -gt 1 ] && echo "$n files already existed in $src"
}

remove_broken_links()
{
  ## Remove any broken links...
  find . $src -type l | perl -lne 'unlink $_ if (-l && ! -e)'
}

prepare_for_compile()
{
  #
  #  Generate Makefile
  #
  echo "Rebuilding Makefile from Makefile.src."
  old_dir="`pwd`"
  cd $src
  rm -f Makefile			# for old run directories
  $srcdir/scripts/adapt-mkfile Makefile.src Makefile
  rm -f makefile			# for old run directories
  cd $old_dir
}

scripts="start.csh start_run.csh run.csh getconf.csh"
pencil_home_path=$PENCIL_HOME
src="`pwd`/src"

while [ $# -gt 0 ]
do
  case $1 in
  -h)
    . $pencil_home_path/lib/sh/functions.sh
    usage_from_header $IAM
    exit 1
  ;;
  -?)
    . $pencil_home_path/lib/sh/functions.sh
    usage_from_header $IAM
    exit 1
  ;;
  --help)
    . $pencil_home_path/lib/sh/functions.sh
    usage_from_header $IAM
    exit 1
  ;;
  --pencil-home)
    pencil_home_path=$2
    shift
  ;;
  --)
    shift
    break
  ;;
  *)
    if [ $specified_src ]; then
      echo UNRECOGNISED PARAMETER
      usage_from_header $IAM
      exit 1
    fi
    src=$1
  ;;
  esac

  shift
done 

. $pencil_home_path/lib/sh/functions.sh

if [ ! "$pencil_home_path" ]; then
  echo " You need to provide the path to the Pencil Code, either via the"
  echo " --pencil-home option or you need to set PENCIL_HOME; "
  echo " consider sourcing sourceme.{,c}sh"
  exit 1
fi

bindir=$pencil_home_path/bin
srcdir=$pencil_home_path/src

echo "Files will be linked to the root code directory '$pencil_home_path'."

remove_broken_links
link_scripts
link_root_makefile
make_src_dir
link_src_files
#copy_local_files
print_status
prepare_for_compile

