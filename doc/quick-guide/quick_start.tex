%$Id$
\documentclass[a4paper,12pt]{article}
\usepackage[utf8]{inputenc}
%\usepackage[spanish]{babel}
\usepackage{pslatex} %Para el pdf sea más mono.
\usepackage{eurosym}
\usepackage{amssymb}
\usepackage{latexsym}
\usepackage[dvips]{graphicx}
\usepackage{delarray}
\usepackage{amsmath}
%\usepackage{bbm}
%\usepackage{bbold}
%\usepackage{accents}
\usepackage{subfigure}
\usepackage{multirow}
\usepackage{fancyhdr}
%\usepackage{tocbibind} % Para que incluya la bibliografia en el indice
%\usepackage{bibtex}
\usepackage{wrapfig}
\usepackage{color}
\usepackage{hyperref}
%\usepackage{fmtcount}
\usepackage{parskip}
\frenchspacing

\graphicspath{{./fig/}{./png/}}

\setlength{\hoffset}{-1in}
\setlength{\textwidth}{7.5in}
\setlength{\voffset}{-1.2in}
\setlength{\textheight}{10.0in}

\title{Pencil-code: quick reference guide.}
%\dedicatory{pa mi}


\author{Illa R. Losada}
\date{}

\begin{document}
\maketitle

\tableofcontents

\newpage

\section{Download the Pencil Code}
The Pencil Code is an open source code. General information can be found at

\url{http://www.nordita.org/pencil-code/}.


You need \verb|svn| to download the latest version 
\begin{verbatim}
svn checkout https://pencil-code.googlecode.com/svn/trunk/ pencil-code
--username NAME
\end{verbatim}

where you replace NAME by your gmail name, and the password is the
one generated by pencil-code.googlecode.com ($\rightarrow$profile
$\rightarrow$settings). 

An alternative for a non-up-to-date version of the pencil-code is
\url{
wget http://pencil-code.googlecode.com/files/pencil-code-r18525.tar.gz
}

The downloaded \verb|pencil-code| directory contains several sub-directories
\begin{enumerate}
  \item \verb|samples|:  many sample problems
  \item \verb|config|: all the configuration files.
  \item \verb|doc| a very important directory containing the pencil-code
    \verb|manual.tex|
  \item \dots
\end{enumerate}
For example, the code structure can be further explored in Section 4 of the
manual.

\section{Configure the shell}

<<<<<<< .mine
I the \verb|tcsh| shell, put in your \$HOME/.cshrc file the following lines:
=======
It is recommend to use cshell instead of bash.

Under the tcsh shell, put in your \$HOME/.cshrc file the following lines:
>>>>>>> .r19030
\begin{verbatim}

#
#  path for pencil code
#
if (! $?PENCIL_HOME) setenv PENCIL_HOME $HOME/pencil-code
if (-r $PENCIL_HOME/sourceme.csh) then
  set _sourceme_quiet; source $PENCIL_HOME/sourceme.csh; unset _sourceme_quiet
endif
\end{verbatim}

Note: If you want to change your default \$SHELL to tcsh, type

\begin{verbatim}
  chsh
  /bin/tcsh
\end{verbatim}

The first command prompts you for your normal unix password.

If you are under the bash shell, put in your \$HOME/.bashrc file the following
lines:
\begin{verbatim}
#
#  path for pencil code
#
if [ -z $PENCIL_HOME ]; then  export PENCIL_HOME=$HOME/pencil-code; fi
if [ -e $PENCIL_HOME/sourceme.sh ]; then
  set _sourceme_quiet; source $PENCIL_HOME/sourceme.sh; unset _sourceme_quiet
fi
\end{verbatim}

Also add the following useful alias:

With tcsh: \texttt{alias pc 'cd \$PENCIL\_HOME'}
With bash: \texttt{alias pc='cd \$PENCIL\_HOME'}

such that you will directly move to the Pencil Code directory wherever you are
by typing 'pc'.

Source your updated \$HOME/.cshrc or \$HOME/.bashrc file by typing:

With tcsh: \texttt{source .cshrc}
With bash: \texttt{source .bashrc}

\section{Configure makefile.}

In order to run the code a proper configuration file is needed. This file should contain all the information related with the compilers and their special options.

The configuration files should be located in the \verb|config| directory and should have a special name related with the host-id. This id is easyly obtained by:  
\begin{verbatim}
pc_build --debug
\end{verbatim}
And now create a new config file in:
\texttt{config/hosts/illa/HOST-ID.conf}

The next step is customize this file, for example:
\begin{verbatim}
# Linux.conf
#
# Default settings for Linux systems
#
# $Id$

%section Makefile
# %include compilers/gfortran
 %include compilers/ifort
 %include compilers/mpif90
 %include compilers/gcc

FC=mpif90 
FFLAGS= -O3  
CC=mpicc 
CFLAGS=-O3 -DFUNDERSC=1 
LD_MPI= 
FFLAGS_DOUBLE=-r8 
%endsection Makefile

%section runtime
mpiexec=/usr/pkg/intel/2011.8.273/composer_xe_2011_sp1.8.273/mpirt/bin/intel64/m
pirun
%endsection runtime
# End of file
\end{verbatim}



\section{Useful commands.}
\begin{center}
\begin{tabular}{|l|l|}\hline
pc & move to the PC directory\\\hline
cd samples/conv-slab & move to the sample 'conv-slab' which is in a 'samples'
directory\\\hline
pc\_setupsrc & initialize the local 'src' directory, copy necessary files,
etc...\\\hline
make & 	compile the code\\\hline
mkdir data & create the data directory where all the outputs will be written
\\\hline
start.csh & compute the initial setup at time t=0 \\\hline
run.csh & launch the main code that advances the equations in time\\\hline
\end{tabular}
\end{center}

\section{Configure the run}
The structure of the Pencil code consists of different modules, containing
different physics that you may or may not need for your problem. 

\subsection{Makefile}

\begin{verbatim}
pc_setupsrc
\end{verbatim}
This sets up the linking to the root \verb|src| directory and makes a
\verb|data| directory that will contain the data produced by your simulation.

Basic configuration files for the make:
\begin{verbatim}
src/Makefile.local
src/cparam.local
\end{verbatim}

The structure of the Pencil code consists of different modules, containing
different physics that you may or may not need for your problem. These are set
in \verb|Makefile.local|. 

Example of a file without mpi:
\begin{verbatim}
###                             -*-Makefile-*-
### Makefile for modular pencil code -- local part
### Included by `Makefile'
###

MPICOMM=nompicomm
#MPICOMM=mpicomm
GRAVITY=gravity_simple
EOS=eos_idealgas
FORCING=noforcing
ENTROPY=noentropy
MAGNETIC=magnetic
MAGNETIC_MEANFIELD=magnetic/meanfield
DENSITY=density
HYDRO=hydro
\end{verbatim}

The \texttt{src/cparam.local} file set the local settings concerning grid size
and number of CPUs. My file (no mpi):
\begin{verbatim}
!  -*-f90-*-  (for Emacs)    vim:set filetype=fortran:  (for vim)
!
!  cparam.local
!
!  Local settings concerning grid size and number of CPUs.
!  This file is included by cparam.f90
!
integer, parameter :: ncpus=1,nprocx=1,nprocy=1,nprocz=ncpus/(nprocx*nprocy)
integer, parameter :: nxgrid=128,nygrid=1,nzgrid=128
!
\end{verbatim}

\subsection{Run configuration files}

There are three basic configuration files where all the physics and outputs are specify: print.in, run.in and start.in.
\begin{itemize}
 \item \verb|print.in|: write here all the input magnitudes you need.
  \item \verb|run.in|: parameters values, number of timesteps,...
  \item \verb|start.in|: Initialisation parameters
\end{itemize}



%\section{Running the code}
%
%In order to use the code, a compilation in each of the working directories is
%needed. Basically there are two ways of compiling and running the code.
%The only way of using the Makefile config file created before is using the new
%way:
%
%The standard way:
%\begin{enumerate}
%  \item \verb|pc_build| compile the code
%  \item \verb|pc_run| run the code
%    \begin{enumerate}
%      \item \verb|pc_run start| can be run before \verb|pc_run|, to construct
%        the initial condition.
%    \end{enumerate}
%\end{enumerate}

%The old way of doing it was:
%\begin{verbatim}
%make
%./start.csh
%./run.csh
%\end{verbatim}
%But one usually need to specify some options by hand in the make command. In my
%case, to use mpi:
%\begin{verbatim}
%make FC=mpif90
%\end{verbatim}
    
\section{Setting up python.}
\subsection{Python modules requirements.}
The basic needed modules are: numpy and matplotlib.
\begin{itemize}
 \item numpy: all array definitions and operations.
  \item matplotlib: plotting.
\end{itemize}

Other really useful modules are: ipython and scipy.

\begin{itemize}
 \item ipython: enhanced python interpreter.
  \item scipy: science functions and utilities.
\end{itemize}


\subsection{Installation}
Untar the \texttt{tar.gz} file or go to the directory and simple type as root or sudoed:
\begin{verbatim}
python setup.py install
\end{verbatim}
For a user installation (no root permision):
\begin{verbatim}
python setup.py install --user
\end{verbatim}

\subsection{Using the module.}
Import the module:
\begin{verbatim}
import pencil as pc
\end{verbatim}
Some useful functions:
\begin{center}
\begin{tabular}{|l|l|}\hline
pc.read\_ts & Read ``time\_series.dat'' file. Parameters are added as members of the class. \\\hline
pc.read\_slices & read 2D slice binary files and return two arrays: one of (nslices,vsize,hsize) and other of time\\\hline
pc.animate\_interactive &  Assemble a 2D animation from a 3D array. \\\hline
%× & ×\\\hline
%× & ×\\\hline
%× & ×\\\hline
\end{tabular}
\end{center}

\section{Run a sample: an example}
% TODO Searching in the pencil code
% 1D Jeans sample?
% Please feel free to change this sample if it is not to your liking. 

Construct a folder in which you would like to run the sample
\begin{verbatim}
 > mkdir sample_test_jeans
\end{verbatim}

Now we copy the sample from the pencil code directory
\begin{verbatim}
 > pc_newrun ~/pencil-code/samples/1d-tests/jeans-x jeans-x
\end{verbatim}

The \verb|pc_setupsrc| command sets up the linking to the root \verb|src|
directory and makes a
\verb|data| directory that will contain the data produced by your simulation.
\begin{verbatim}
 /jeans-x> pc_setupsrc
\end{verbatim}

You can inspect the included modules in
\begin{verbatim}
 /jeans-x> vi src/Makefile.local 
\end{verbatim}
where I used the \verb|vi| text editor. The grid size can be inspected in 
\begin{verbatim}
 /jeans-x> vi src/cparam.local 
\end{verbatim}

The code is compiled by
\begin{verbatim}
 /jeans-x> pc_build
\end{verbatim}
and this may take some time.

The initial conditions are set in
\begin{verbatim}
 /jeans-x> vi start.in
\end{verbatim}

and parameters necessary to run the code in time can be found in
\begin{verbatim}
 /jeans-x> vi run.in
\end{verbatim}

Time to run the code. 
\begin{verbatim}
 /jeans-x> pc_run
\end{verbatim}

Visualizing the output can be either done with \verb|idl| or \verb|python|.

\subsection{IDL visualisation}
% The goal of this section is to demonstrate the general workflow with a very
% simple example.

Start \verb|idl| from the command line. Several \verb|idl| have been written (you can find them in
\verb|pencil-code/idl| ) to facilitate inspecting the data (which can be found
in raw format in \verb|jeans-x/data| directory).  For example, let us inspect
the time series data.
\begin{verbatim}
IDL> pc_read_ts, obj=ts
\end{verbatim}
The object \verb|ts| contains several variables, which can be inspected
\begin{verbatim}
IDL> print, tag_names(ts.t)
IT T UMAX RHOMAX
\end{verbatim}
In fact, the maximal density is available because it was set in
\verb|jeans-x/print.in| which contains the so-called diagnostic output
(for more, see manual section 5.4). 
We can plot the exponential growth rate of the mode we excited
\begin{verbatim}
IDL> plot, ts.t, alog(ts.umax)
\end{verbatim}
Here we plotted the evolution of the maximal velocity as a function of physical
time $t$.

% TODO Insert a screen shot of the IDL window

Another sample is illustrated in the manual in section 3.1.6.

\end{document}
