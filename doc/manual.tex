%%%%%%%%%%%%%%%%%%%%%%            -*-LaTeX-*-
%%%   manual.tex   %%%
%%%%%%%%%%%%%%%%%%%%%%
%%
%%  Date:   06-Mar-2002
%%  Author: wd (Wolfgang.Dobler@kis.uni-freiburg.de)
%%  CVS: $Id: manual.tex,v 1.44 2002-07-10 15:57:39 dobler Exp $
%%  Description:
%     User manual for the MHD code 
%   Process with:
%     latex manual; makeindex manual; latex manual

\ifx\pdfoutput\undefined        % not running pdflatex
  \documentclass[12pt,twoside,notitlepage,a4paper]{article}
\else                           % running pdflatex
  \documentclass[pdftex,12pt,twoside,notitlepage,a4paper]{article}
\fi

%\usepackage{url} %(do we not need this; but it's not working anyway)
\usepackage[bookmarks=false]{hyperref}
%\usepackage{german,a4}
%\usepackage[german,british]{babel}
\usepackage[latin1]{inputenc}
%\usepackage[T1]{fontenc}
%\usepackage{ae}                 % To get good PDF with the T1 encoding
\usepackage{newcent,helvet}
\renewcommand{\ttdefault}{cmtt} % Courier is too broad
\usepackage{amsmath}

\usepackage{makeidx}

\usepackage[it,footnotesize]{caption2}
\setlength{\abovecaptionskip}{5pt} % Space before caption
\setlength{\belowcaptionskip}{5pt} % Space after caption

\usepackage[bf,sf,small,nonindentfirst]{titlesec}
\newcommand{\sectionbreak}{\clearpage}
%\titleformat{\subsubsection}{\normalfontitshape}{\thesubsubsection}{.5em}{}
%\titlespacing{\subsubsection}{0pt}{*1}{*-1}
\usepackage{fancyhdr}
\usepackage{fancybox}
\setcounter{tocdepth}{6} % Older versions of fancybox very annoyingly (and
                         % unnecessarily) resets this and make table of
                         % contents disappear

\usepackage{expdlist}
\usepackage{booktabs}
\usepackage{longtable}

\usepackage{fancyvrb}
%\DefineShortVerb{\|}
\usepackage{alltt}
\usepackage{underscore}

\usepackage{graphicx}
\graphicspath{{figs/}}

\usepackage{parskip,a4,vmargin}
%\setpapersize{A4}  %AB: what if somebody prints it in Santa Barbara?
%\setmargrb{20mm}{15mm}{20mm}{15mm}
\setmargrb{20mm}{25mm}{20mm}{15mm}  %AB: just trying to adjust it for here.

\frenchspacing
\sloppy

\makeindex


%%% Page headings
\pagestyle{fancy}
\renewcommand{\sectionmark}[1]{% Don't upcase the section title
  \markright{\thesection.\ #1}}
\fancyhead{}                    % clear header
\fancyhead[LE,RO]{\thepage}
\fancyhead[CE]{\textsc{The MHD code}}
\fancyhead[CO]{\rightmark}
%
\fancyfoot{}

% ---------------------------------------------------------------------- %

%%% Macros

%% Bold face \tt prompts (only works within `alltt' or \tt environment)
\newcommand{\prompt}[1]{{\ttfamily\bfseries{}#1}}

%% Margin and inline notes and remarks
\newcommand\note[1]{\marginpar{\renewcommand{\baselinestretch}{0.8}
        \raggedright\scriptsize\usefont{OT1}{phv}{mc}{n} #1}}
\newcommand{\Note}[1]{\emph{[#1]}}


%% keys, names, paths, files, etc.
\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\kbd}[1]{\texttt{\textsl{#1}\/}}
\newcommand{\key}[1]{{\setlength{\fboxsep}{1pt}\ovalbox{\sf #1}}}
\newcommand{\samp}[1]{`\code{#1}'}
\newcommand{\var}[1]{\textsl{#1}\index{#1@\emph{#1}}\/}
\newcommand{\env}[1]{\code{#1}\index{#1@\emph{#1}}}
\newcommand{\file}[1]{`\texttt{#1}'}
\newcommand{\command}[1]{\code{#1}\index{#1}}
\newcommand{\cmd}[1]{\command{#1}}
\newcommand{\option}[1]{`\code{#1}'\index{#1@\emph{`#1'} option}}
\newcommand{\dfn}[1]{\textsl{#1}\index{#1}\/}
%\newcommand{\cite}[1]{}
\newcommand{\acronym}[1]{\textsc{#1}\index{#1}}
%\newcommand{\url}[1]{}
\newcommand{\email}[1]{\code{#1}}

\newcommand{\name}[1]{\textsl{#1}\index{#1}\/}
\newcommand{\Path}[1]{\file{#1}}

%
\newcommand{\bsT}{{\fontencoding{T1}\selectfont{\symbol{92}}}}
\newcommand{\bcks}{\texttt{\symbol{92}}}
\newcommand{\bs}{\bcks}       % Save us creation of a couple of fonts

%% Maths operators
% \newcommand{\arcosh} {\mathop{\rm arcosh}\nolimits}
% \newcommand{\arcoth} {\mathop{\rm arcoth}\nolimits}
\newcommand{\atanh} {\mathop{\rm atanh}\nolimits}
% \newcommand{\sgn}    {\mathop{\rm sgn}\nolimits}
\newcommand{\grad}    {\mathop{\rm grad}\nolimits}
\newcommand{\Div}     {\mathop{\rm div}\nolimits}
\newcommand{\curl}    {\mathop{\rm curl}\nolimits}
\newcommand{\rot}     {\curl}
\newcommand{\Laplace} {\mathop{\Delta}\nolimits}
\newcommand{\erfc}    {\mathop{\rm erfc}\nolimits}
\newcommand{\erf}     {\mathop{\rm erf}\nolimits}

\newcommand{\vekt}[1] {\mathbf{#1}}
\newcommand{\const}   {\mbox{\rm const}}

%% Maths variables
\newcommand{\Av}            {\vekt{A}}
% \newcommand{\av}            {\vekt{a}}

\newcommand{\Bv}            {\vekt{B}}
% \newcommand{\bv}            {\vekt{b}}

\newcommand{\Cool}          {{\cal C}}
\newcommand{\cs}            {c_{\rm s}}
\newcommand{\csnull}        {c_{{\rm s},0}}

% \newcommand{\Ev}            {\vekt{E}}
% \newcommand{\ev}            {\vekt{e}}
% \newcommand{\ex}            {\ev_{x}}
% \newcommand{\ey}            {\ev_{y}}
% \newcommand{\ez}            {\ev_{z}}

% \newcommand{\Fv}            {\vekt{F}}

\newcommand{\gv}            {\vekt{g}}

\newcommand{\Heat}          {{\cal H}}
\newcommand{\Heavi}         {\theta}

\newcommand{\jv}            {\vekt{j}}

% \newcommand{\nullvekt}      {\vekt{0}}

\newcommand{\Ra}            {\mathrm{Ra}}
\newcommand{\Reynolds}      {\mathrm{Re}}
\newcommand{\Rm}            {\mathrm{Rm}}

\newcommand{\uv}            {\vekt{u}}

% \newcommand{\Vol}           {{\cal V}}
\newcommand{\vA}            {v_{\rm A}}

\newcommand{\xv}            {\vekt{x}}

% \newcommand{\zerovect}      {\nullvekt}

%AB: I've added here some of my favorite macros
\newcommand{\bra}[1]{\langle #1\rangle}
\newcommand{\Eq}[1]{Eq.~(\ref{#1})}
\newcommand{\nab}{\mbox{\boldmath $\nabla$} {}}
\newcommand{\dd}{{\rm d} {}}

% ---------------------------------------------------------------------- %

\title{{\sffamily\bfseries Installing and Using the High-Order MHD MPI code}}
%\subtitle{A very preliminary manual}
\author{Wolfgang Dobler \& Axel Brandenburg}
\date{\today,~ $ $Revision: 1.44 $ $}

% ====================================================================== %

\begin{document}
\pagestyle{empty}

%\maketitle

\begin{titlepage}
  \begin{center}

  \large

  \vspace*{3cm}

  {\Large\sffamily\bfseries PENCIL--MPI: A High-Order MPI code for MHD Turbulence}

  \vspace{0.5cm}

  {\sffamily Documentation and Results of Test Problems}

  \vspace{1.5cm}

  {Wolfgang Dobler \& Axel Brandenburg}


  \vspace{2cm}

  \emph{\today,~ $ $Revision: 1.44 $ $}


\end{center}

\end{titlepage}


\newpage
\mbox{}
\vfill

Copyright \copyright{} 2001,2002 Wolfgang Dobler \& Axel Brandenburg
\bigskip

Permission is granted to make and distribute verbatim copies of
this manual provided the copyright notice and this permission notice
are preserved on all copies.

Permission is granted to copy and distribute modified versions
of this manual under the conditions for verbatim copying,
provided that the entire resulting derived work is distributed under the
terms of a permission notice identical to this one.


\clearpage
\pagestyle{plain}
\pagenumbering{roman}

\section*{Foreword}

This code was originally developed at the Turbulence Summer School of the
Helmholtz Institute in Potsdam (2001).
While some SPH and PPM codes for hydrodynamics and magnetohydrodynamics
are publicly available, this does not generally seem to be
the case for higher order finite-difference or spectral codes.
Having been approached by people interested in using our code, we have
decided to make it as flexible as possible and as user-friendly as seems
reasonable, and to put it onto a public \name{CVS} repository.
The code can certainly not be treated as a black box (no code can), and in
order to solve a new problem in an optimal way, you will need to find your
own set of parameters, in particular you may need to add or increase
artificial viscosity and diffusivities.

The code is primarily designed to deal with weakly compressible turbulent
flows, which is why we use high-order first and second derivatives.
To achieve good parallelization, we use explicit
(as opposed to compact) finite differences.
Typical scientific targets include driven MHD turbulence in a periodic box,
convection in a slab with non-periodic upper and lower boundaries,
a convective star embedded in a fully nonperiodic box, accretion disc
turbulence in the shearing sheet approximation, etc.

Magnetic fields are implemented in terms of the magnetic vector potential
to ensure that the field remains solenoidal (divergence-free).
At the same time, having the magnetic
vector potential readily available is a tremendous advantage if
one wants to monitor the magnetic helicity, for example.
The code is therefore particularly well suited for all kind of
dynamo problems.

The code is non-conservative; thus, conserved quantities should only be
conserved up to the discretization error of the scheme (not the machine
accuracy).
There is no guarantee that a conservative code is more accurate with
respect to quantities that are not explicitly conserved, such as entropy.
Another important quantity that is (to our knowledge) not strictly
conserved by ordinary flux conserving schemes is \name{magnetic helicity}.

There are currently no plans to implement adaptive mesh refinement
into the code, which would cause major technical complications.
Given that turbulence is generically space-filling, local refinement
to smaller scales would often not be very useful anyway.
On the other hand, in some geometries
turbulence may well be confined to certain regions in space, so one
could indeed gain by solving the outer regions with fewer points.

In order to be cache-efficient, we solve the equations along
\name{pencils} in the $x$ direction.
One very convenient side-effect is that auxiliary and derived variables
use very little memory, as they are only ever defined on one pencil.
The domain can be tiled evenly in the $y$ and $z$ directions.
On multiprocessor computers, the code uses \name{MPI}
(Message Passing Interface) calls to communicate between processors.
An easy switching mechanism allows the user to run the code on a machine
without MPI libraries (e.g.~a notebook computer).
Ghost zones are used to implement boundary conditions on physical and
processor boundaries.

The code achieves a high level of flexibility by encapsulating individual
physical processes and variables in individual \name{modules}, which can
be switched on or off in the file \file{Makefile.local} in the local
\file{src} directory.
In order to avoid excessive use of preprocessor directives, we were lead
to create one dummy module for each physics module.
For nonmagnetic hydrodynamics, e.g., one will use the module
\file{nomagnetic.f90}:
\begin{Verbatim}
  MAGNETIC=nomagnetic
\end{Verbatim}
while for MHD simulations, \file{magnetic.f90} will be used:
\begin{Verbatim}
  MAGNETIC=magnetic
\end{Verbatim}
Note that the term \name{module} as used here is not identical to Fortran
modules: both \file{magnetic.f90} and \file{nomagnetic.f90} define an F90
module named \emph{Magnetic} --- this is the basis of the switching
mechanism we are using.

Input parameters (in the files \file{start.in}, \file{run.in}) can be
changed without recompilation.
What is more, one can change the list of variables for monitoring
(diagnostic) output on the fly, and there are mechanisms for making the
code reload new parameters or exit gracefully.

The requirements for using the Pencil-MPI code are modest: you can use it
on any Unix system with a F90/F95 compiler. If you have \name{IDL} as
well, you will be able to visualize the results, but other tools such as
\name{DX} (OpenDX, data explorer) can also be used.

\bigskip

We will be happy to include user-supplied changes and updates to the code
in future releases and welcome any feedback.

\vspace{5mm}
%\noindent
\url{Wolfgang.Dobler@kis.uni-freiburg.de}\hfill Freiburg\\
\url{Axel.Brandenburg@nordita.dk}\hfill Copenhagen

\section*{Acknowledgements}

Many people have contributed in different ways to the development of this
code. We thank first of all {\AA}ke Nordlund (Copenhagen Observatory)
and Bob Stein (University of Michigan) who introduced us to the idea of
using high-order schemes in compressible flows and who taught us a lot
about simulations in general.

The shearing sheet approximation and the flux limited diffusion approximation
were implemented by Nils Haugen (University of Trondheim).

Vladimir Pariev (University of Rochester) contributed to the development
and testing of the potential field boundary condition.

\tableofcontents
\clearpage
\pagestyle{fancy}
\pagenumbering{arabic}


% ====================================================================== %

\section{System Requirements}

To use the code, you will need the following:

\begin{enumerate}

  \item Absolutely needed:
    \begin{itemize}
    \item F90 or F95 compiler
    \end{itemize}

\item Used heavily (if you don't have one of these, you will need to
  adjust many things manually):
  \begin{itemize}
  \item a \name{Unix}-type system with \name{make} and \name{csh}
  \item \name{Perl} (remember: if it doesn't run Perl, it's not a
    computer)
  \end{itemize}

\item The following are dispensable, but enhance functionality in one ore
  the other way:
  \begin{itemize}
  \item an \name{MPI} implementation (for parallelization on
    multiprocessor systems)
  \item a \name{C} compiler (for some debugging functionality)
  \item \name{DX} alias \name{OpenDX} or \name{data explorer} (for
    visualization of results)
  \item \name{IDL} (for visualization of results; the 7-minute demo
    license will do for many applications)
  \end{itemize}

\end{enumerate}

If you like the exotic and get the code running in a \name{Cygwin}
environment, please let us know.


% ====================================================================== %

\section{Obtaining the Code}

There are two ways to obtain and install the code: If you want to use a
stable release, you can download it as a tarball and unpack it.
If you prefer to use the latest version we are experimenting with,
this is provided for by anonymous CVS access.

% ---------------------------------------------------------------------- %

\subsection{Obtaining and unpacking the tarball}

\begin{enumerate}
\item Download the tarball from
  \path{http://www.nordita.dk/~brandenb/MHD-code/download/pencil_modular.tgz}
\item Put it into a convenient directory and unpack it:
  \begin{alltt}
  \prompt{unix> } mv pencil_modular.tgz somewhere/; cd somewhere
  \prompt{unix> } gunzip pencil_modular.tgz
  \prompt{unix> } tar xf pencil_modular.tar \
  \end{alltt}
\item {}[Optional:] Rename the directory \file{pencil_modular} to \file{mhd}
  if you want to be consistent with the notation used throughout this
  manual.
\end{enumerate}

% ---------------------------------------------------------------------- %

\subsection{Obtaining the code via anonymous CVS}

\begin{enumerate}

\item Get a \name{CVS} client from \url{http://www.cvshome.org/} and
  install it (on any machine where you want to run the code).
  Alternatively, just copy the executable from a binary compatible
  machine.

\item Get the password for anonymous \name{CVS} access to the MHD code
\footnote{Wolfgang, we should make this automatically. Ideally, a new user
should be able to register on our web site and get a password automatically.
This needs then to be automatically put into the CVS passwd file.}

\item Set your environment variable \env{CVSROOT} (you probably want to
  put this into your \file{.cshrc} or \file{.profile} setup files):
  \begin{alltt}
  \prompt{csh> } setenv CVSROOT \bs
          :pserver:anonymous@norserv.nordita.dk:/home/brandenb/CVS \
  \end{alltt}
  (all in one line) or (if you are running Bourne shell or bash)
  \begin{alltt}
  \prompt{sh> } CVSROOT=:pserver:anonymous@norserv.nordita.dk:/home/brandenb/CVS
  \prompt{sh> } export CVSROOT \
  \end{alltt}

\item Log in:
  \begin{alltt}
  \prompt{unix> } cvs login
  cvs password: ........ \
\end{alltt}
(you only need to do this once; your CVS password is saved in the file
\file{.cvspass} in your home directory)

\item Go to wherever you want the code:
  \begin{alltt}
  \prompt{unix> } cd \file{somewhere} \
  \end{alltt}
  and check the code out:
  \begin{alltt}
  \prompt{unix> } cvs checkout -d mhd f90/pencil_modular \
  \end{alltt} 
  This creates a subdirectory \file{somewhere/mhd} and populates it with
  the MHD code's subdirectories.

\end{enumerate}


% ---------------------------------------------------------------------- %

\subsection{Updating via CVS}

Independent from how you installed the code in the first place (tarball or
CVS), you can update your version via CVS.
If you have done nontrivial alterations to your version of the code, you
ought to be careful about upgrading: although CVS is the optimal tool for
distributed programming, conflicts are quite likely, since we are going to
touch many parts of the code while we develop it further.
Thus, despite the fact that we use CVS, you should probably back up your
changes before upgrading.

Here is the upgrading procedure:
\begin{enumerate}
\item Go to the top directory of the code:
  \begin{alltt}
  \prompt{unix> } cd \file{somewhere/mhd} \
  \end{alltt}
\item Run \cmd{cvs update}:
  \begin{alltt}
  \prompt{unix> } cvs -q update -dP \
  \end{alltt}
\item Fix any conflicts you encounter and make sure the examples are still
  working.
\end{enumerate}

% ---------------------------------------------------------------------- %

\subsection{Getting older versions}

You may find that the latest version produces errors. This is quite
possible if introduced changes to the code. It it therefore extremely
useful to get an older version where you know it should work correctly.

Here is what you have to do:
\begin{enumerate}
\item Go to the top directory of the code:
  \begin{alltt}
  \prompt{unix> } cd \file{somewhere/mhd} \
  \end{alltt}
\item Run \cmd{cvs update}:
  \begin{alltt}
  \prompt{unix> } cvs up -D "30 Jun 2000"\
  \end{alltt}
\end{enumerate}
(...if that's the version you want)


% ====================================================================== %

\section{Getting Started}

To get yourself started, you should run one of several examples which are
provided in one of the runs/sample subdirectories.

You will only be able to fully assess the numerical solutions if you
visualize them with \name{IDL}, \name{DX} or other tools (see
Sect.~\ref{S-IDLroutines}).

% ---------------------------------------------------------------------- %

\subsection{Setup}

\begin{itemize}
\item sourceme.x (where \var{x} stands for \var{csh} or \var{sh})
\item lnsrc (alias setup)
\item edit the Makefile (full description here or elsewhere?)
\end{itemize}
\vspace{7cm}

% ---------------------------------------------------------------------- %

\subsection{A first test}

Now we are ready to compile and run a simple example (periodic,
isothermal, non-forced MHD) where the physics is already nontrivial.


\subsubsection{Interlocked flux rings}

\begin{alltt}
  \prompt{unix> } cd somewhere/mhd
  \prompt{unix> } source sourceme.csh \quad\#(to put pencil/bin into your path)
  \prompt{unix> } cd runs/sample/rings
  \prompt{unix> } lnsrc \quad\#(from \file{../../../bin}, which by now should be in your path)
  \prompt{unix> } cd src
  \prompt{unix> } make
  \prompt{unix> } cd ..
  \prompt{unix> } mkdir tmp \quad\#(or link some data disc to tmp)
  \prompt{unix> } ./start.csh
  \prompt{unix> } ./run.csh
\end{alltt}

You should obtain \ldots

\vspace{5cm}

EXPLAIN: isotrop1, plan to set-up vortex rings as initial condition,
without magnetic fields etc.

% ---------------------------------------------------------------------- %

\subsection{Other test problems}

1-D sound waves and shock tube tests, interlocked pair of flux rings, stably stratified atmosphere.


% ====================================================================== %

\section{Code structure}

% ---------------------------------------------------------------------- %

\subsection{Directory tree}

 % ---------------------------------------------------------------------- %
\begin{figure}[hbtp]
  \centering
  \includegraphics%
    [width=0.9\textwidth,height=0.65\textheight,keepaspectratio]%
    {struct}
  \caption{The basic structure of the code}
  \label{Fig-Structure}
\end{figure}
% ---------------------------------------------------------------------- %

The overall directory structure of the code is shown in
Fig.~\ref{Fig-Structure}.
Under \file{pencil}, there are currently the following
files and directories:
\begin{verbatim}
  CVS/    bin/  bugs/         doc/
  dx/     idl/  runs/         src/
  README  TODO  sourceme.csh  sourceme.sh
\end{verbatim}

Almost all of the source code is contained in the directory \file{src/},
but in order to encapsulate individual applications, the code is compiled
separately for each run in a local \file{src} directory below the
individual run directory, like e.g.~\file{runs/gravz/vconv1/src}.

The directory \file{runs} contains individual run directories, grouped in
classes (like \file{spher} for spherical calculations, or \file{kinematic}
for kinematic dynamo simulations.
The current list of classes is
\begin{verbatim}
  gravz/      forced/     OLD/      old/
  buoy_tube/  kinematic/  1d-tests/ rings/
\end{verbatim}
The directory \file{forced/} contains some forced turbulence runs (both
magnetic and nonmagnetic). 
\file{gravz/} contains runs with vertical gravity, \file{rings/}
contains decaying MHD problems (interlocked flux rings as initial condition, for
example), and \file{kinematic/} contains kinematic dynamo problems where the
hydrodynamics is turned off entirely.
The file \file{runs/README} will always contain an up-to-date list and
short description of the individual classes.

The subdirectory \file{src} of each run directory contains a few local
configuration files (currently these are \file{Makefile.local} and
\file{cparam.local} and contains all the \file{.f90} and \file{.c} files,
together with the \file{Makefile} as links from the top \file{src}
directory.

General purpose visualization routines for \name{IDL} or \name{DX} are in the
\file{idl} and \file{dx} directories, respectively.

The directory \file{doc} contains this manual; \file{bin} a number of
utility scripts (\name{csh} and \name{Perl}).
The \file{CVS} directory is used (you guessed it) by \name{CVS}, and is
not normally directly accessed by the user.
\file{bugs}, finally is used by us for internal purposes.

\bigskip

The files \file{sourceme.csh} and \file{sourceme.sh} will set up some
environment variables --- in particular \var{PATH} --- and aliases/shell
functions for your convenience.
If you do not want to source one of these files, you need to make sure
your \name{IDL} path is set appropriately (provided you want to use
\name{IDL}, that is) and you will need to address the scripts from
\file{bin} with their explicit path name.


% ----------------------------------------------------------------------------- %

\subsection{Basic concepts}

\subsubsection{Data access in pencils}
\index{pencil design}

Unlike the CRAY computers that dominated supercomputing in the 80s and
early 90s, all modern computers have a cache that constitutes a significant
bottleneck for many codes. This is the case if large three-dimensional
arrays are constantly used within each time step. The advantage of this
way of coding is clearly the conceptual simplicity of the code. A more
cache-efficient way of coding is to calculate an entire time step (or
a corresponding substep in a three-stage $2N$ Runge-Kutta scheme) only
along a one-dimensional pencil of data within the box. On Linux and Irix
architectures, for example, this leads to a speed-up by 60\%. An additional
advantage is a drastic reduction in temporary storage that is needed for
auxiliary variables within each time step.


\subsubsection{The 2$N$-scheme}
\index{2N-scheme}

For the time stepping high-order schemes are necessary in order to reduce
the amplitude error of the scheme and to allow longer time steps. Usually
such schemes require large amounts of memory. However, there are the
memory-effective $2N$-schemes that require only two sets of variables
to be held in memory. Such schemes work for
arbitrarily high order, although not all Runge-Kutta schemes can be
written as $2N$-schemes \cite{2Nstorage,SH88}.
These schemes work iteratively according to the formula
\begin{equation}
w_i=\alpha_i w_{i-1}+\delta t\,F(t_{i-1},u_{i-1}),
\end{equation}
\begin{equation}
u_i=u_{i-1}+\beta_i w_i.
\label{iterform0}
\end{equation}
For a three-step scheme we have $i=1,...,3$.
In order to advance the variable $u$ from $u^{(n)}$ at time $t^{(n)}$
to $u^{(n+1)}$ at time $t^{(n+1)}=t^{(n)}+\delta h$ we set in \Eq{iterform0}
\begin{equation}
u_0=u^{(n)}\quad\mbox{and}\quad u^{(n+1)}=u_3,
\end{equation}
with $u_1$ and $u_2$ being intermediate steps. In order to be able to
calculate the first step, $i=1$, for which no $w_{i-1}\equiv w_0$ exists,
we have to require $\alpha_1=0$. Thus, we are left with 5 unknowns,
$\alpha_2$, $\alpha_3$, $\beta_1$, $\beta_2$, and $\beta_3$. Three
conditions follow from the fact that the scheme be third order, so we
have to have two more conditions. One possibility is to choose the
fractional times at which the right hand side is evaluated, for
example (0,~1/3,~2/3) or even (0,~1/2,~1). In the latter case the right hand
side is evaluated twice at the same time. It is therefore some sort of
predictor-corrector scheme. Yet another possibility is to require that
inhomogeneous equations of the form $\dot{u}=t^n$ with $n=1$ and 2 are
solved exactly.
The corresponding coefficients are listed in Table~\ref{T-2N-RK3} and compared
with those given by Williamson \cite{2Nstorage}. In practice all of them
are about equally good when it comes to real applications, although
we found the first one in Table~\ref{T-2N-RK3} (`symmetric') marginally better in some
simple test problems where an analytic solution was known.

\begin{table}[htb]\caption{
Possible coefficients for different $2N$-RK3 schemes.
}\vspace{12pt}\centerline{\begin{tabular}{lccccccc}
\hline
label & $\alpha_2$ & $\alpha_3$ & $\beta_1$ & $\beta_2$ & $\beta_3$ \\
\hline
symmetric           &  $-2/3$  &   $-1$   & 1/3 &  1  & 1/2 \\
predictor/corrector &  $-1/4$  &  $-4/3$  & 1/2 & 2/3 & 1/2 \\
inhomogeneous       & $-17/32$ & $-32/27$ & 1/4 & 8/9 & 3/4 \\
Williamson (1980)   &  $-5/9$  &$-153/128$& 1/3 &15/16& 8/15\\
\label{T-2N-RK3}\end{tabular}}\end{table}

\subsubsection{Modularity}
\index{modules}

Each run directory has a \file{src/Makefile.local} file in which you
choose certain \name{modules}\footnote{%
  We stress once more that we are not talking about F90 modules here,
  although there is some connection, as most of our modules define F90
  modules:
  For example each of the three modules \name{grav_z}, \name{grav_r} and
  \name{nograv} define a Fortran module \name{Gravity}.
}, which tell the code whether or not entropy, magnetic fields,
hydrodynamics, density, forcing, etc.~should be invoked.
For example, the settings for forced turbulent MHD simulations are
\begin{verbatim}
  HYDRO=hydro
  DENSITY=density
  ENTROPY=noentropy
  MAGNETIC=magnetic
  GRAVITY=nograv
  FORCING=forcing
  
  MPICOMM=nompicomm
  GLOBAL=noglobal
  IO=io_dist
\end{verbatim}
This file will be processed by \cmd{make} and the settings are thus
assignments of \name{make} variables.
Apart from the physics modules (equation of motion: yes, density
[pressure]: yes, entropy equation: no, magnetic fields: yes, gravity: no,
forcing: yes), a few technical modules can also be used or deactivated; in
the example above, these are \name{MPI} (switched off), additional global
variables (none) and input/output (there is currently only one module
available).
Table~\ref{Tab-modules} lists all currently available modules.

\begin{table}
  \centering
  \caption{%
    Switchable modules as of June 2002.
  }
  \label{Tab-modules}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    hydro.f90      & Hydrodynamics: add variable $\uv$ with equation of
                     motion; \\
    nohydro.f90    & no variable $\uv$: useful for kinematic dynamo runs. \\
    \midrule
    density.f90    & Add variable $\varrho$ with continuity equation \\
    nodensity.f90  & no variable $\varrho$: useful for Burgers' equation. \\
    \midrule
    entropy.f90    & Add variable $s$ with entropy equation (energy
                     equation); \\
    noentropy.f90  & no variable $s$: isothermal hydrodynamics. \\
    \midrule
    magnetic.f90   & Add variable $\Av$ (magnetic vector potential) with
                     induction equation; \\
    nomagnetic.f90 & no variable $\Av$: nonmagnetic hydrodynamics. \\
    \midrule
    \midrule
    forcing.f90    & Add a forcing function to rhs of equation of motion
                    (typically helical forcing) for forced turbulence
                    calculations; \\
    noforcing.f90  & no forcing. \\
    \midrule
    grav_z.f90     & Constant vertical gravity in equation of motion; \\
    grav_r.f90     & radially symmetric gravity; \\
    nograv.f90     & no gravity. \\
    \midrule
    \midrule
    global_rr.f90  & Radius \verb|rr| as an additional global variable; \\
    global_pot.f90 & radially symmetric gravity potential as additional
                     global variables; \\
    noglobal.f90   & no additional global variables. \\
    \midrule
    fft.f          & Singleton (1968) FFT routine: needed for magnetic
                     potential-field boundary condition; \\
    nofft.f90      & no FFT: no need to bother about compiler warnings if
                     you don't need this boundary condition. \\
    \midrule
    io_dist.f90    & Distributed input/output: each processor writes to
                     its own directory; currently there are no
                     alternatives. \\
    \midrule
    mpicomm.f90    & Use \name{MPI} for communication on multiprocessor
                     machines; \\
    nompicomm.f90  & no parallelization: convenient for testing and
                     smaller production runs on desktop or notebook
                     computers. \\
    \midrule
    debug_c.c      & Use I/O routines that allow to write auxiliary
                     variables to a file (nontrivial in a pencil code);
                     requires C compiler to be set up correctly and maybe
                     requires appropriate compiler flags
                     (\code{-DFUNDERSCORE}) for correctly interfacing C
                     with Fortran (and may still not work); \\
    nodebug.f90    & don't use these debugging routines, avoiding any
                     C-Fortran interoperability problems. \\
    \bottomrule
  \end{tabular}
\end{table}
% ---------------------------------------------------------------------- %


Note that most of these \name{make} variables \emph{must} be set, but they
will normally obtain reasonable default values in \file{Makefile}.
It is by using this switching mechanism through \cmd{make} that we achieve
high flexibility without resorting to excessive amounts of cryptic
preprocessor directives.
 
Many possible combinations of modules have already been tested
and examples are part of the distribution, but you may be interested in a
combination which were never tested and which may not yet work, since the
modules are not fully orthogonal.
In all such cases, we depend on your feedback for fixing the problems
and documenting the changes for others.


% ---------------------------------------------------------------------- %

\subsection{Localization (adapt-mkfile)}


% ---------------------------------------------------------------------- %

\subsection{Visualization}


\subsubsection{IDL routines}
\label{S-IDLroutines}

Basic sequence:
\begin{alltt}
  \prompt{unix> } idl
  \prompt{IDL> }  .run start
  \prompt{IDL> }  .run r
  \prompt{IDL> }  {\sf[specific commands]} \
\end{alltt}
You call \file{start.pro} once to initialize the fields and read in the
startup parameters from the code.
Each time you want to read in a new snapshot, you run \file{r.pro},
possibly after adjusting the IDL variable \var{file} to a specific snapshot
file; by default, the file \file{var.dat} in the data directory will be
read, which is overwritten with new data in regular intervals.

If the data are scattered over different processors and you want to
reassemble everything into one file, you say
\begin{alltt}
  \prompt{IDL> }  .r rall
\end{alltt}
Here, \cmd{.r} is a shorthand for \cmd{.run}.
The procedure \file{rall.pro} reads (and assembles) the data from all
processors.
If you want to look at just one processor, use \file{r.pro} instead.

If you need the magnetic field or the current density, you can calculate
them in IDL by saying
\begin{alltt}
  \prompt{IDL> }  bb=curl(aa)
  \prompt{IDL> }  jj=curl2(aa)
\end{alltt}

By default one is reading always the latest time corresponding to the file
\file{var.dat}; if you want to read any earlier snapshots, you say (for
example)
\begin{alltt}
  \prompt{IDL> }  file='VAR2'
  \prompt{IDL> }  .r rall
  \prompt{IDL> }  print,t
\end{alltt}
and it will get the data from all processors from that snapshot.

To discuss:
\begin{itemize}
\item availability of IDL (demo version; Pvwave; Ana)?
\item setup (include \file{../idl} and \file{../../idl} (?) in \var{!path})
\item how to get our IDL routines
\end{itemize}



% ---------------------------------------------------------------------- %

\subsection{Files}

\subsubsection{start.in, run.in}

\subsubsection{param.nml, param2.nml; param[2].pro}


% ---------------------------------------------------------------------- %

\subsection{I/O diagnostics}


% ====================================================================== %

\section{Using the Code}
\label{Input-params}

Here's how to use the code \ldots

% ---------------------------------------------------------------------- %

\subsection{I/O diagnostics}

Every \verb|n1| time steps (\verb|n1| is a runtime parameter, see
\S\ref{Run-params}), the code writes monitoring output to \name{stdout}
and, parallel to this, to the file \file{tmp/n.dat}.
The variables that appear in this listing and the output format are
defined in the file \file{print.in} and can be changed without touching
the code (even while the code is running).
A simple example of \file{print.in} may look like this:
\begin{verbatim}
  t(f10.3)
  u2m(1pe13.4)
  oum
\end{verbatim}
which means that the output table will contain time \var{t} in the first
column with format \verb|(f10.3)|, followed by the mean squared velocity,
\var{u2m} (i.e.~$\left<\uv^2\right>$) in the second column with format
\verb|(1pe13.4)|, and the kinetic helicity \var{oum}
(that is $\left<\vec{\omega}\cdot\uv\right>$) in the last column with the
default format \verb|(1pe10.2)|.

In the file \file{zaver.in}, $z$-dependent (horizontal) averages are listed.
They are written in the file \file{tmp/zaverages.dat}. At the moment we
can also output in \file{print.in} the associated mean square value
of the horizontal field, but this requires that in \file{zaver.in} the
quantities \code{bxmz} and \code{bymz} are set.

% ---------------------------------------------------------------------- %

\subsection{Helper scripts}
\index{Scripts}

\begin{description}
  \item[adapt-mkfile]
  \item[lnsrc]
  \item[new]
  \item[nl2idl]
  \item[timestr]
  \item[x]
\end{description}

\vspace{5cm}

% ---------------------------------------------------------------------- %

\subsection{RELOAD and STOP files}

The code periodically checks (exactly every \var{it} time steps)
for the existence of two files, \file{RELOAD}
and \file{STOP}, which can be used to trigger certain behavior.

\paragraph{Reloading run parameters}
In the directory where you started the code, create the file
\file{RELOAD} with
\begin{alltt}
  \prompt{unix> } touch RELOAD \
\end{alltt}
to force the code to re-read the runtime parameters from \file{run.in}.
This will happen the next time the code is writing monitoring output (the
frequency of this happening is controlled by the input parameter \var{it},
see \S\ref{start-params}).

\paragraph{Stopping the code}
In the directory where you started the code, create the file
\file{STOP} with
\begin{alltt}
  \prompt{unix> } touch STOP \
\end{alltt}
to stop the code in a controlled manner (it will write the latest
snapshot).
Again, the action will happen the next time the code is writing monitoring
output.


% ---------------------------------------------------------------------- %


\subsection{Start parameters}
\label{start-params}

All input parameters in \file{start.in} (and \file{run.in}) occur in
namelists.
This allows arbitrary order of the parameters (\emph{within} the given
namelist; the namelists need to appear in the correct order), as well as
inserted Fortran comments and whitespace for readability.
One namelist (\name{init_pars}) contains general parameters for
initialization and is always read in.
All other namelists are specific to individual modules and will only
be read if the corresponding module is used.

The syntax of a namelist (in an input file like \file{start.in}) is
\begin{verbatim}
  &init_pars
    ip=5, Lxyz=2,4,2
  /
\end{verbatim}
--- in this example, we read just two variables (all other variables in
the namelist retain their previous value): \var{ip}, which is set to $5$,
and \var{Lxyz}, which is a vector of length three and is set to $(2,4,5)$.

While all parameters from the namelists can be set, in most cases
reasonable default values are preset.
Thus, the typical file \file{start.in} will only contain a minimum set of
variables or (if you are \emph{very} minimalistic) none at all.
If you want to run a particular problem, the best will be to start by
modifying a particular example which is closest to yours.

The following table lists all (at the time of writing, June 2002)
namelists with their corresponding start parameters and their default
values (in brackets).
Any variable referred to as a \dfn{flag} can be set to any nonzero value
to switch the corresponding feature on.
Not all parameters are used for a given scenario.
This lit can in many cases only give an idea of the corresponding initial
state; to get more insight, you should have a look at the code.


% ---------------------------------------------------------------------- %
\begin{longtable}{lp{0.6\textwidth}}
%\begin{tabular}{lp{0.6\textwidth}}
\toprule
  \multicolumn{1}{c}{\emph{Variable (default value)}}
               & \multicolumn{1}{c}{\emph{Meaning}} \\
\midrule
  \multicolumn{2}{c}{Namelist \name{init_pars}}\\
\midrule
  \var{cvsid}  & the \name{CVS} identification string, which allows you to
                 keep track of the version of \file{start.in}.\\
  \var{ip}     & (anti-)verbosity level: \code{ip=1} produces lots of
                 diagnostic output, \code{ip=14} virtually none. \\
  \var{xyz0},
  \var{Lxyz},
  \var{lperi}  & determine the geometry of the box. All three are vectors
                 of the form ($x$-comp., $y$-comp., $z$-comp.); \var{xyz0}
                 describes the left (lower) corner of the box, \var{Lxyz}
                 the box size.
                 \var{lperi} specifies whether a direction is considered
                 periodic (in which case the last point is omitted) or not.
                 In all cases, three ghost zones will be added. \\
  \var{lwrite_ic}
               & ??? \\
  \var{lnowrite}
               & ??? \\
%
\midrule
  \multicolumn{2}{c}{Namelist \name{hydro_init_pars}} \\
\midrule
  \var{inituu} & initialization of velocity. Currently valid choices are
                 `zero' ($\uv=0$), 
                 `random-normal' (random, normally-distributed $u_x$), 
                 `sound=wave' (sound wave in $x$ direction), 
                 `shock-tube' (polytropic standing shock). \\
  \var{ampluu} & amplitude for some types of initial velocities. \\
  \var{widthuu}& width for some types of initial velocities. \\
  \var{urand}  & additional random perturbation of $\uv$. If
                 \verb|urand>0|, the perturbation is additive,
                 $u_i \mapsto u_i + u_{\rm rand}{\cal U}_{[0.5,0.5]}$;
                 if \verb|urand<0|, it is multiplicative,
                 $u_i \mapsto u_i \times u_{\rm rand}{\cal U}_{[0.5,0.5]}$;
                 in both cases, ${\cal U}_{[0.5,0.5]}$ is a uniformly
                 distributed random variable on the interval $[-0.5,0.5]$.\\
  \var{uu_left},
  \var{uu_right}
               & needed for \code{inituu='shock-tube'}.\\
%
\midrule
  \multicolumn{2}{c}{Namelist \name{density_init_pars}} \\
\midrule
  \var{initlnrho}
               & initialization of density. Currently valid choices are
                 `zero' ($\ln\varrho=0$),
                 `hydrostatic-z' (hydrostatic vertical stratification),
                 `hydrostatic-z-2' (hydrostatic vertical stratification
                                    for isentropic atmosphere),
                 `rho-jump' (density jump of width \var{widthlnrho}),
                 `piecew-poly' (piecewise polytropic vertical
                               stratification for solar convection),
                 `polytropic' (polytropic vertical stratification),
                 `sound-wave' (sound wave),
                 `shock-tube' (polytropic standing shock).\\
  \var{gamma}  & adiabatic index $\gamma=c_p/c_v$. \\
  \var{cs0,rho0}
               & reference values of sound speed and density,
                 i.\,e.~values at height \name{zref}. \\
  \var{ampllnrho},
  \var{widthlnrho}
               & amplitude and width for some types of initial densities. \\
  \var{rho_left},
  \var{rho_right}
               & needed for \code{initlnrho='shock-tube'}. \\
  \var{cs2bot},
  \var{cs2top} & sound speed at bottom and top. Needed for some types of
                 stratification. \\ 
%
\midrule
  \multicolumn{2}{c}{Namelist \name{grav_init_pars}} \\
\midrule
%
\midrule
  \multicolumn{2}{c}{Namelist \name{entropy_init_pars}} \\
\midrule
%
\midrule
  \multicolumn{2}{c}{Namelist \name{magnetic_init_pars}} \\
\midrule





\midrule
  \multicolumn{2}{c}{[Old stuff:]} \\
\midrule



  \var{z1}, \var{z2}, \var{ztop}
               & specific to the solar convection case.
                 The stable layer is $z_0 < z < z_1$, the unstable layer
                 $z_1 < z < z_2$, and the top (isothermal) layer is
                 $z_2 < z < z_{\rm top}$
                 \Note{How is this related to $L_z$??} \\
  \var{hcond[0-2]}, \var{whcond}
               & specific to the solar convection case: heat conductivities
                 $\lambda$ in the individual layers. \var{hcond0} is the
                 value $\lambda_{\rm unst}$ in the unstable layer,
                 \var{hcond1} is the ratio
                 $\lambda_{\rm stab}/\lambda_{\rm unst}$ for the stable
                 layer, and \var{hcond2} is the ratio 
                 $\lambda_{\rm top}/\lambda_{\rm unst}$ for the top layer.
                 The function $\lambda(z)$ is not discontinuous, as the
                 transition between the different values is smoothed over
                 the width \var{whcond}. \\
  \var{mpoly[0-2]}, \var{isothtop}
               & specific to the solar convection case: polytropic indices
                 of unstable (\var{mpoly0}), stable (\var{mpoly1}) and top
                 layer (\var{mpoly2}).
                 If the flag \var{isothtop} is set, the
                 top layer is initialized to be isothermal, otherwise
                 thermal (plus hydrostatic) equilibrium is assumed for all
                 three layers, which results in a piecewise polytropic
                 stratification. \\
  \var{ampl}   & ??? \\
  \var{init}   & ??? \\
  \var{urand}  & amplitude of initial random velocity fluctuations \\
  \var{gamma}  & adiabatic index of the gas (typically $\gamma=5/3$ in
                 astrophysical applications \\
  \var{cs0}, \var{rho0}
               & reference values of sound speed $\cs$ and density
                 $\varrho$. In the convection case, these are the values of
                 $\cs$ and $\varrho$ at $z=z_{\rm top}$. \\
  \var{gravz}  & vertical gravity $g_z$; normally $<0$. \\
  \var{grads0} & [Not used for convection reference case] initial entropy
                 gradient. \\
\bottomrule
%\end{tabular}
\end{longtable}
% ---------------------------------------------------------------------- %


% ---------------------------------------------------------------------- %

\subsection{Run parameters}
\label{Run-params}

Here is a list of parameters that are set in \file{run.in}.

Note that formatted \name{Fortran} input allows for parameters to be
skipped (indicated by possible whitespace, followed by a comma), which
causes the corresponding variable to retain the value it had before the
\cmd{read} command was called.
In most cases, this default value will be the one set in \file{start.in}.

Any variable referred to as a \dfn{flag} can be set to any nonzero value
to switch the corresponding feature on.

Not all parameters are used for a given scenario.


% ---------------------------------------------------------------------- %
\begin{longtable}{lp{0.6\textwidth}}
\toprule
  \multicolumn{1}{c}{\emph{Variable}}
               & \multicolumn{1}{c}{\emph{Meaning}} \\
\midrule
  \var{nt}     & number of time steps to carry out. \\
  \var{it1}    & write monitoring output every \var{it1} time steps.\\
  \var{dt}     & time step $\delta t$ (if set and different from zero).\\
  \var{cdt}    & CFL (or Courant) coefficient,
                 $\delta t/\delta t_{\rm Courant}$. A typical
                 value is \code{cdt=0.4}. Using less can be useful as a
                 temporary fix until the source of the problem is found.\\
  \var{cdtv}   & viscous time step; actual time step is given by
                 \begin{equation}
                   \delta t
                   = \min\left( c_{\delta t}\frac{\delta x_{\rm min}}
                                     {U_{\rm max}} ,
                                c_{\delta t_v}
                                \frac{\delta x_{\rm min}^2}
                                     {D_{\rm max}}
                         \right) \; ,
                 \end{equation}
                 where
                 $\delta x_{\rm min} \equiv \min(\delta x, \delta y, \delta z)$;
                 $U_{\rm max} \equiv \max\left(|\uv|
                                     + \sqrt{\cs^2{+}\vA^2}\right)$,
                 $\cs$ and $\vA$ denoting sound speed and Alfv\'en speed,
                 respectively;
                 and $D_{\rm max} = \max(\nu,\chi,\eta)$, where
                 $\nu$ denotes kinematic viscosity,
                 $\chi = \lambda/(c_p\varrho)$ thermal diffusivity and
                 $\eta$ the magnetic diffusivity.
                 \\
  \var{isave}  & update snapshot file \file{var.dat} every \var{isave}
                 time steps. \\
  \var{iorder} & order of time step. Set \code{iorder=1} for Euler
                 stepping, \code{iorder=3} for the 3rd-order Runge-Kutta
                 (2$N$) scheme. \code{iorder=1} is useful for debugging,
                 because one wants to know what happens after the first
                 or second step. \code{iorder=2} is also possible, but
                 not \code{iorder>3}.\\
  \var{dsnap}  & save full snapshots \file{VAR$N$} every \var{dsnap} time
                 units. \\
  \var{dvid}   & write two-dimensional sections for generation of videos
                 every \var{dsnap} time units. \\
  \var{dtmin}  & abort if time step $\delta t < \delta t_{\rm min}$. \\
  \var{tinit}  & ??? \\
  \var{tdamp}  & damp velocities in the initial time interval
                 $0 < t < t_{\rm damp}$. \\
  \var{dampu}  & strength of initial damping of velocity. \\
  \var{dampuext}, \var{rdamp}, \var{wdamp}
               & permanently damp velocities at $|\xv| > r_{\rm damp}$
                 with strength \var{dampuext}, with a smooth transition
                 between damped and undamped of radial width \var{wdamp}. \\
  \var{ip}     & (anti-)verbosity level: \code{ip=1} produces lots of
                 diagnostic output, \code{ip=14} virtually none. \\
  \var{i[x-z]} & monitor values of some variables in point with indices
                 $(i_x,i_y,i_z)$. \\
  \var{cs}, \var{rho}
               & reference values of sound speed $\cs$ and density
                 $\varrho$. In the convection case, these are the values of
                 $\cs$ and $\varrho$ at $z=z_{\rm top}$. \\
  \var{ivisc}  & switch for viscosity term
                 \Note{which value gives which term?} \\
  \var{hcond[0-2]}, \var{whcond}
               & heat conductivities, see Sec~\ref{Input-params}; leave
                 these empty unless you want to override the settings from
                 \file{start.in}. \\
  \var{cdiffrho}
               & ??? \\
  \var{gravz}  & vertical gravity, see Sec~\ref{Input-params}; leave
                 this empty unless you want to override the setting from
                 \file{start.in}. \\
  \var{cheat}, \var{wheat}
               & heating term: add total amount \var{cheat} of heat per
                 time unit in zone near bottom of width \var{wheat}.
                 You probably rather want to use \var{Fheat} (see below). \\
  \var{cool}, \var{wcool}
               & cooling term: cool top layer of width \var{wcool} to
                 reference temperature (given by ${\cs}_0$) by cooling term
                 of strength \var{cool}. \\
  \var{Fheat}  & heat flux through bottom boundary. \\
  \var{iforce}, \var{force}, \var{relhel}
               & on-off flag, strength and kinetic helicity of forcing
                 terms. \\
  \var{bc[x-z]}
               & boundary conditions. Set these to a sequence of letters 
                 like `p,p,p,p,p,p,p,p' for periodic boundaries, or
                 `s,s,a,a2,c1:c2,s,s,a' for non-periodic ones.
                 Each entry (between commas) corresponds to one of the
                 variables, normally these are $u_x$, $u_y$, $u_z$,
                 $\ln\varrho$, $s/c_p$, $A_x$, $A_x$ and $A_x$, in this
                 order.
                 \begin{description}
                 \item[\option{p}] indicates periodicity
                 \item[\option{a}] indicates antisymmetry w.\,r.\,t.~the
                   boundary, i.\,e.~vanishing value
                 \item[\option{s}] indicates symmetry w.\,r.\,t.~the
                   boundary, i.\,e.~vanishing first derivative
                 \item[\option{a2}] indicates antisymmetry w.\,r.\,t.~the
                   arbitrary value on the boundary, i.\,e.~vanishing
                   second derivative
                 \item[\option{c1}] is a special boundary condition for
                   $\ln\varrho$ and $s$, which ensures constant heat flux
                   through the boundary
                 \item[\option{c2}] is a special boundary condition for
                   $\ln\varrho$ and $s$, which ensures constant
                   temperature at the boundary 
                 \end{description}
                 The special syntax $a$:$b$ (e.\,g.~`\code{c1:c2}') means: use
                 boundary condition $a$ at the left/lower boundary, but
                 $b$ at the right/upper one. 
                 \\
  \var{form1}  & format for monitoring output. typically something like
                 \code{'(i8,f11.5,1p,50(e10.3," "))'} for printing number
                 of time step, time, and then a lot of different
                 quantities. Make sure you allow for sufficiently many
                 quantities here (you can always use a large multiplier to
                 be on the safe side). \\
\bottomrule
\end{longtable}


% ---------------------------------------------------------------------- %

\subsection{Output files}

\begin{itemize}
\item \file{tmp/n.dat}, file{output diagnostics, depends on what is put in print.in}
\item \file{tsnap.dat}, \file{tvid.dat}
\item \file{tmp/dim.dat}
\item \file{tmp/param.dat} \file{tmp/param2.dat}
\item \file{tmp/proc\emph{X}/var.dat} --- detailed format
\item \file{tmp/proc\emph{X}/VAR\emph{N}} --- same format as
      \file{tmp/proc\emph{X}/var.dat}
\item \file{tmp/proc\emph{X}/seed.dat} --- seed field for forcing
      procedure: must be the same for all processors, because globally
      coherent waves of given wavenumber are used
\item \file{tmp/density.pro}, \file{tmp/hydro.pro}, \file{tmp/entropy.pro},
      \file{tmp/magnetic.pro} --- can be used as include file in \name{IDL}
      and contains the column in which certain variables appear in the
      diagnostics file (\file{n.dat}). It also contains the positions of
      variables in the \file{VAR} files. These positions depend on whether
      \var{entropy} or \var{noentropy}, etc, are invoked.
\item \file{tmp/param.nml}
\end{itemize}


% ====================================================================== %

\section{The Equations}

The equations solved by the MHD code are basically the standard
compressible MHD equations. However, the modular structure allows
some variations of the MHD equations, as well as to switch
some of the equations off (nomagnetic, noentropy).

% ---------------------------------------------------------------------- %

\subsection{Continuity equation}

\begin{equation}
  \frac{D\ln\varrho}{Dt}
  = - \Div\uv \; .
\end{equation}

Here $\varrho$ denotes density, $\uv$ the fluid velocity, $t$ is time and
$D/Dt \equiv \partial/\partial t + \uv\cdot\grad$ is the convective
derivative.

% ---------------------------------------------------------------------- %

\subsection{Equation of motion}

\begin{equation}
  \frac{D\uv}{Dt}
   =  -\cs^2\grad\biggl(\frac{s}{c_p} + \ln\varrho\biggr)
      - \grad\Phi
      + \frac{\jv\times\Bv}{\varrho}
      + \nu \left( \Laplace\uv + \frac{1}{3}\grad\Div\uv \right) \; .
\end{equation}
Here, $\cs^2 = \gamma p/\varrho$ is the squared sound speed,
$\gamma=c_p/c_v$ the ratio of specific heats of \emph{adiabatic index},
$\Phi$ is the gravity potential, $\jv$ the electric current density, $\Bv$
the magnetic flux density, and $\nu$ is kinematic viscosity.
Note that the viscous term used here is only correct if the dynamical
viscosity $\mu \equiv \varrho\nu = \const$ everywhere.


% ---------------------------------------------------------------------- %
\subsection{Induction equation}

\begin{equation}
  \frac{\partial\Av}{\partial t}
  = \uv\times\Bv - \eta\mu_0\jv \; .
\end{equation}

Here $\Av$ is the magnetic vector potential\index{vector potential},
$\Bv = \curl\Av$ the magnetic
flux density, $\eta = 1/(\mu_0\sigma)$ is the magnetic diffusivity
($\sigma$ denoting the electrical conductivity), and $\mu_0$ the
magnetic vacuum permeability.


% ---------------------------------------------------------------------- %

\subsection{Entropy equation}
\index{entropy}

The current thermodynamics module \file{entropy} formulates the thermal
part of the physics in terms of \emph{entropy} $s$, rather than thermal
energy $e$, which you may be more familiar with.
Thus the two fundamental thermodynamical variables are $\ln\varrho$
and $s$.
The reason for this choice of variables is that entropy is the natural
physical variable for (at least) convection processes: the sign of the
entropy gradient determines convective (in)stability, the
\emph{Rayleigh number} is proportional to the entropy gradient
of the associated hystrostatic reference solution, etc.
The equation solved is
\begin{equation}
  \varrho T\frac{Ds}{Dt}
   =  \Heat - \Cool
      + \Div(\lambda\grad T)
      + \eta\mu_0 \jv^2
      + 2\varrho\nu {\sf S}^2 \; .
\end{equation}

Here, $T$ is temperature, $c_p$ the specific heat at constant pressure,
$\Heat$ and $\Cool$ are explicit heating and cooling terms,
$\lambda$ is the thermal conductivity, and
\begin{equation}
  {\sf S}_{ik} = \frac{\partial_i u_k + \partial_k u_i}{2}
                 -\frac{1}{3} \delta_{ik}\Div\uv
\end{equation}
is the traceless rate of strain tensor.

\bigskip

Note that by setting $\gamma=1$ and initially $s=0$, one obtains an
isothermal equation of state (albeit at some unnecessary expense of
memory).
Similarly, by switching off the evolution terms of entropy, one immediately
gets polytropic behavior (if $s$ was initially constant) or generalized
polytropic behavior
(where $s$ is not uniform, but $\partial s/\partial t = 0$).

A better way to achieve isothermality is to use the \name{noentropy}
module.


% ====================================================================== %

\section{Boundary conditions}

\begin{description}
\item[a]
\item[s]
\item[a2]
\item[c1]
\item[c2]
\end{description}

% ====================================================================== %

\section{Adapting the code}

In some cases, the best will be
to write a new module that takes care of everything.
In many cases it will not be enough to just replace (in the Makefile)
an already existing module. Instead, it will often be necessary to
add new things into several other routines. In order to come back
to other cases (needed for regular tests of the code and for future
releases) it is important to supply also a corresponding dummy routine,
whose name will start with `no'.

% ---------------------------------------------------------------------- %

\subsection{Adding new output diagnostics}

With the implementation of new physics and the development of new procedures
in the code it will become necessary to monitor new diagnostic quantities that
have not yet been implemented in the code. Here is what needs to be done.

The best will be to follow an example, e.g.\ \var{jbm}. Here only the
module Magnetic is being affected; say \file{grep jbm *.f90}. A corresponding
integer label with the name \var{i\_jbm} is defined (and initialized to zero).
Depending on whether this is the mean or a maximum value of the quantity
\var{jb}, which is calculated in a suitable place in the code, we use the
label \var{i\_jbm} in connection with the subroutine \code{sum\_mn\_name} or
\code{max\_mn\_name}. Here we use
\begin{verbatim}
        if (i_jbm/=0) call sum_mn_name(jb,i_jbm)
\end{verbatim}
In \file{register.f90} we \code{call rprint\_magnetic} where 
\begin{verbatim}
        call parse_name(iname,cname(iname),cform(iname),'jbm',i_jbm)
\end{verbatim}
has to be added to the list of names that are to be recognized from the
\file{print.in} file.

% ---------------------------------------------------------------------- %

\subsection{Outputting new horizontal averages}

Currently, only the horizontally $xy$-averaged $x$ and $y$ components
of the magnetic field can be outputted. This is determined by the existence
and contents of the file \file{zaver.in}.
\footnote{May want to rename it to \file{xy\_aver.in}; what do you think?}
New such variables can be added by using the existing averaging
procedures as examples.

% ---------------------------------------------------------------------- %

\subsection{Adding new evolution equations}

Example: passive scalar.

% ====================================================================== %

\section{Timings}

\begin{table}[htb]
  \begin{center}
    \caption{
      Wall clock time per mesh point (excluding the ghost zones)
      and per full 3-stage time step.
      The Compaq (mhd) machine has 4 processors per node, so the memory
      consumption is given per node.
      For example, a $256^3$ MHD run without entropy evolution requires 241 Mb
      per node. So the size per processor is 241/4 Mb = 60 Mb.
      }
    \label{Ttimescale}
    \begin{small}
      \begin{tabular}{rllrlrl}
proc(s)& machine          &  $\displaystyle\frac{{\mu\rm s}}{\rm pt\;\;step}
                             \rule[-2.8ex]{0pt}{5pt}$
                                 & resol.\ & what         & Size/proc
                                                                   & when/who \\
\hline
 1    & 500MHz linux (nl3)&  19  &  $64^3$ & kinematic    &  10 Mb & (20-may-02/AB)\\
 1    & 500MHz linux (nl3)&  30  &  $64^3$ & magn/noentro &  20 Mb & (20-may-02/AB)\\
 1    & 924MHz linux (nq1)&  10  &  $64^3$ & magn/noentro &        & (30-may-02/AB)\\
 1    & Origin3000 (ukaff)& 9.2  &  $64^3$ & magn/noentro &        & (20-may-02/AB)\\
 1    & Compaq (mhd)      & 7.8  &  $64^3$ & magn/noentro &        & (20-may-02/AB)\\
 1    & Linux (Kabul)     & 4.4  & $128^3$ & magn/noentro & 130 Mb & (20-jun-02/WD)\\
 2    & Linux (Kabul)     & 2.5  & $128^3$ & magn/noentro &  80 Mb & (20-jun-02/WD)\\
 4    & Linux nq0-3       & 6.8  & $256^3$ & magn/noentro & 294 Mb & (10-jun-02/AB)\\
 4    & Compaq (mhd)      & 2.76 &  $64^3$ & magn/noentro &        & (30-may-02/AB)\\
 4    & Linux (Kabul)     & 1.5  & $128^3$ & magn/noentro &  47 Mb & (20-jun-02/WD)\\
 8    & Origin3000 (ukaff)& 1.24 &  $64^3$ & magn/noentro &        & (20-may-02/AB)\\
 8    & Linux (Kabul)     & 0.83 & $128^3$ & magn/noentro &  28 Mb & (20-jun-02/WD)\\
 8    & Linux (Kabul)     & 0.87 & $256^3$ & magn/noentro & 160 Mb & (20-jun-02/WD)\\
16    & Compaq (mhd)      & 0.64 & $256^3$ & magn/noentro &241/4 Mb& (22-may-02/AB)\\
16    & Origin3000 (ukaff)& 0.61 & $128^3$ & magn/noentro &        & (22-may-02/AB)\\
16    & Origin3000 (ukaff)& 0.64 & $256^3$ & magn/noentro &        & (20-may-02/AB)\\
16    & Linux (Kabul)     & 0.80 & $128^3$ & magn/noentro &  16 Mb & (20-jun-02/WD)\\
16    & Linux (Kabul)     & 0.51 & $256^3$ & magn/noentro &   9 Mb & (20-jun-02/WD)\\
32    & Origin3000 (ukaff)& 0.34 & $256^3$ & magn/noentro &        & (20-may-02/AB)\\
32    & Origin3000 (ukaff)& 0.32 & $512^3$ & magn/noentro &        & (20-may-02/AB)\\
64    & Origin3000 (ukaff)& 0.17 & $512^3$ & magn/noentro &        & (21-may-02/AB)\\
      \end{tabular}
    \end{small}
  \end{center}
\end{table}

Below we quote the wall clock time per mesh point (including the ghost zones)
and per full 3-stage time step.

Linux 500 MHz: 22 $\mu$s/pt/step in reference implementation (21-Mar-02/AB)
%CVS:  run.f90               version 1.18          of 2002/03/05 17:43:13 
%CVS:  register.f90          version 1.15          of 2002/03/08 15:43:19 
%CVS:  entropy.f90           version 1.33          of 2002/03/09 20:18:55 
%CVS:  magnetic.f90          version 1.6           of 2002/01/30 16:56:30 
%CVS:  grav_z.f90            version 1.5           of 2002/01/23 19:56:13 

Memory usage: 7.3 MB for $32\times32\times64$ MHD simulation.
%7288 with 32x32x64 (single processor, linux)
%print,38*38*71.*8.*2.*4./1e6



% ====================================================================== %

\section{Frequently Asked Questions}

\begin{description}

\item[Compilation stops with the cryptic error message]{\bfseries \ 

    \begin{Verbatim}
f95  -O3 -u -c .f90.f90
Error : Could not open sourcefile .f90.f90
compilation aborted for .f90.f90 (code 1)
make[1]: *** [.f90.o] Error 1
    \end{Verbatim}
  
    What is the problem?}
  \medskip

  {\em
  One of the variables for the \file{makefile} has not been set, so
  \cmd{make} expands it to the empty string.
  Most probably you forgot to specify a module in
  \file{src/Makefile.local}. One possibility is that you have upgraded
  from an older version of the code that did not have some of the modules
  the new version has.
  
  Compare your \file{src/Makefile.local} to one of the examples that
  work.
  }

\item[start.pro doesn't work:]{\bfseries \

    \begin{Verbatim}
Reading grid.dat..
Reading param.nml..
% Expression must be a structure in this context: PAR.
% Execution halted at:  $MAIN$            104
/home/brandenb/pencil/runs/forced/hel1/../../../idl/start.pro
    \end{Verbatim}
    }
    \medskip

    {\em
    You don't have the subdirectory \file{tmp} in your IDL \var{!path}
    variable. Make sure you source \file{sourceme.csh}/\file{sourceme.sh}
    or set a sufficient IDL path otherwise.
    }

\item[run.csh doesn't work:]{\bfseries \

    \begin{Verbatim}
Invalid character ''' in NAMELIST input
Program terminated by fatal I/O error
Abort
    \end{Verbatim}
    }
    \medskip

    {\em
    The string array for the boundary condition, e.g.\ \var{bcx} or
    \var{bcz} is too long. Make sure it has exactly as many elements
    as nvar is big.
    }

\item[It doesn't compile--something with MVAR:]{\bfseries \

    \begin{Verbatim}
brandenb@nl3:/home/brandenb/pencil/runs/gravz/conv0/src> make
make start.x run.x
make[1]: Entering directory `/home/brandenb/pencil/runs/gravz/conv0/src'
f95 -O4 -u -Wc,-malign-double    -c cparam.f90
f95 -O4 -u -Wc,-malign-double    -c cdata.f90
Error: cdata.f90, line 71: Implicit type for MVAR
       detected at MVAR@)
[f95 terminated - errors found by pass 1]
make[1]: *** [cdata.o] Error 2
make[1]: Leaving directory `/home/brandenb/pencil/runs/gravz/conv0/src'
make: *** [code] Error 2
    \end{Verbatim}
    }
    \medskip

    {\em
Check and make sure that \file{mkcparam} is in your path.
It this doesn't help, there may be an {\it empty} \file{cparam.inc}
file in your \file{src} directory. Remove \file{cparam.inc} and try again.
(Note that \file{cparam.inc} is automatically generated.)\footnote{Wolfgang,
I just added \file{\rm *.inc} to the \file{Makefile}.}
    }

\end{description}


% ====================================================================== %

\begin{thebibliography}{9}

\bibitem{2Nstorage} Williamson, J. H., J. Comp. Phys. 35, 48 (1980)
\bibitem{Lele92} Lele, S. K., J. Comp. Phys. 103, 16 (1992)
\bibitem{NS90} Nordlund, \AA., Stein, R. F., Comput. Phys. Commun. 59, 119 (1990)
\bibitem{Ref-3} Brandenburg, A., et al., J. Fluid Mech. 306, 325 (1996)
\bibitem{BNST95} Brandenburg, A., et al., Astrophys. J., 446, 741 (1995)
\bibitem{Ref-1} Brandenburg, A., in Advances in non-linear dynamos,
ed. A. Ferriz-Mas \& M. N\'u\~nez Jim\'enez (2001);
\url{http://arXiv.org/abs/astro-ph/0109497}
\bibitem{Ref-4} Brandenburg, A., Dobler, W., Astron. Astrophys. 369, 329 (2001)
\bibitem{SH88} Stanescu, D., Habashi, W. G., J. Comp. Phys. 143, 674 (1988)
\bibitem{KR80} Krause, F., R\"adler, K.-H., Mean-Field
Magneto\-hy- dro\-dy\-na\-mics and Dynamo Theory,
Akademie-Verlag, Berlin; also Pergamon Press, Oxford (1980)
\bibitem{Ref-2} Brandenburg, A., Astrophys. J. 550, 824 (2001)

\end{thebibliography}


% ====================================================================== %

%\section*{Experimenting with the \LaTeX{} macros}


%\bs{}code:    \code{call remove\_file()}

%\bs{}kbd:     \kbd{M-x comment-region}

%\bs{}key:     \key{F1}

%\bs{}samp:    \samp{a}, \samp{e}, \samp{i}, \samp{o}, \samp{u}

%\bs{}var:     \var{ivisc}

%\bs{}env:     \env{CVSROOT}

%\bs{}file:    \file{~/tmp/var.dat}

%\bs{}command: \command{rm -f *}

%\bs{}option:  \option{-l}, \option{--long-listing}

%\bs{}dfn:     A \dfn{definition} is a specification sufficiently obfuscated
%          to be misunderstood 

%\bs{}cite:    See \cite{Abramowitz & Stegun}

%\bs{}acronym: \acronym{MNRAS}

%\bs{}url:     \url{http://www.nowhere.net/second_page.html}

%\bs{}email:   \email{nobody@nowhere.nil}




% ====================================================================== %
\appendix

\section {To Do}
\begin{itemize}
\item \var{ialive}
\end{itemize}


\section{Some specific initial conditions}

\subsection{Random magnetic fields: \var{initaa=0}}

The $\Av$-vector is set to normally distributed, uncorrelated(?) random
numbers in all meshpoints for all three components.
The power spectrum of
$\Av$ increases then quadratically with wavenumber $k$ (without cutoff)
and the power spectrum of $\Bv$ increases like $k^4$.

% ---------------------------------------------------------------------- %

\subsection{Beltrami fields: \var{initaa=1}}

\begin{equation}
%\Av=\pmatrix{\cos z\cr\sin z\cr0}
\Av=(\cos z,\;\sin z,\;0)
\label{Beltrami}
\end{equation}

% ---------------------------------------------------------------------- %

\subsection{Magnetic flux rings}

This initial condition sets up two interlocked thin magnetic tori
(i.\,e.~thin, torus-shaped magnetic flux tubes).
One torus of radius $R$ lying in the plane $z=0$ can be described in
cylindrical coordinates by the
vector potential
\begin{equation} \label{Av-flux-ring-cyl}
  \Av = 
  \Phi_{\rm m}
  \begin{pmatrix}
    0\\ 0\\ -\Heavi(r{-}R) \delta(z)
  \end{pmatrix} \; ,
\end{equation}
resulting in a magnetic field
\begin{equation}
  \Bv = 
  \Phi_{\rm m}
  \begin{pmatrix}
    0\\ \delta(r{-}R) \delta(z)\\ 0
  \end{pmatrix} \; .
\end{equation}
Here $\Phi_{\rm m}$ is the magnetic flux through the tube,
$\Heavi(x)$ denotes the Heaviside function, and
\begin{equation} \label{Heavi-Dirac}
 \delta(x) = \Heavi'(x)
\end{equation}
is Dirac's delta function.

Any smoothed versions of $\Heavi(x)$ and $\delta(x)$ will do, as long as
the consistency condition (\ref{Heavi-Dirac}) is satisfied.
E.\,g.~the pairs
\begin{equation}
  \delta_\varepsilon(x)
  = \frac{1}{\sqrt{2\pi\varepsilon^2}} e^{-\frac{x^2}{2\varepsilon^2}} \; ,
  \quad
  \Heavi_\varepsilon(x)
  = \frac{1}{2} \left( 1 + \erf\frac{x}{\sqrt{2}\varepsilon} \right)
\end{equation}
or
\begin{equation}
  \delta_\varepsilon(x)
  = \frac{1}{2\varepsilon}\frac{1}{\cosh^2\frac{x}{\varepsilon}} \; ,
  \quad
  \Heavi_\varepsilon(x)
  = \frac{1}{2} \left( 1 + \tanh\frac{x}{\varepsilon} \right)
\end{equation}
are quite popular.

In Cartesian coordinates, the vector potential (\ref{Av-flux-ring-cyl})
takes the form
\begin{equation} \label{Av-flux-ring-cart}
  \Av =
  \Phi_{\rm m}
  \begin{pmatrix}
    0\\ 0\\ -\Heavi \left( \sqrt{x^2{+}y^2}{-}R \right) \delta(z)
  \end{pmatrix} \; .
\end{equation}

\subsection{Vertical stratification}

Gravity, $\bf{g}=-\nab\Phi$, is specified in terms of a potential
$\Phi$. In slab geometry, $\Phi=\Phi(z)$, so ${\bf g}=(0,0,g_z)$ and
$g_z=-\dd\Phi/\dd z$.

Use \var{grav_profile='const'} (which is already the default)
together with \var{gravz}$=-1$ to get
\begin{equation} \label{constgrav-gravz-init}
\Phi=(z-z_\infty)|g_z|,\quad g_z=-1.
\end{equation}
Use \var{grav_profile='linear'} to get
\begin{equation} \label{disc-gravz-init}
\Phi={\textstyle{1\over2}}(z^2-z_\infty^2)\Omega^2,\quad g_z=-\Omega^2z
\end{equation}
where (currently) the parameter \var{gravz} is used in place of $-\Omega^2$.

The value of $z_\infty$ is determined such that $\rho=\rho_0$ and
$c_{\rm s}^2=c_{\rm s0}^2$ at $z=z_{\rm ref}$. This depends on the
values of $\gamma$ and the polytropic index $m$ (see below).

\subsubsection{Isothermal atmosphere}

Here we want $c_{\rm s}=c_{\rm s0}=\mbox{const}$.
Using \var{initlnrho='isothermal'} means
\begin{equation} \label{constgrav-lnrho-init}
\ln\rho/\rho_0=-\gamma\Phi/c_{\rm s0}^2.
\end{equation}
The entropy is then initialized to
\begin{equation} \label{constgrav-ss-init}
s/c_{\rm p}=(\gamma-1)\Phi/c_{\rm s0}^2.
\end{equation}
In order that $\rho=\rho_0$ and $c_{\rm s}^2=c_{\rm s0}^2$ at
$z=z_{\rm ref}$, we have to choose $z_\infty=z_{\rm ref}$.

\subsubsection{Polytropic atmosphere}

For polytropes with $p=K\rho^\Gamma$, where $\Gamma\neq\gamma$ in general,
we can write
\begin{equation}
-\nab h+T\nab s=-{1\over\rho}\nab p
=-\nab\left({\Gamma K\over\Gamma-1}\rho^{\Gamma-1}\right)
\equiv-\nab\tilde{h},
\end{equation}
where we have introduced the pseudo enthalpy $\tilde{h}$ as
\begin{equation}
\tilde{h}={\Gamma K\over\Gamma-1}\rho^{\Gamma-1}
=\left[\left(1-{1\over\gamma}\right)
\left/\left(1-{1\over\Gamma}\right)\right]\,h\right..
\end{equation}
Instead of specifying $\Gamma$, one usually defines the polytopic
index $m=1/(\Gamma-1)$. Thus, $\Gamma=1+1/m$, and
\begin{equation}\label{hhtilde}
\tilde{h}=(m+1)\left(1-{1\over\gamma}\right)\,h
\end{equation}

This is consistent with a fixed entropy dependence,
where $s$ only depends on $\rho$ like
\begin{equation}
s/c_{\rm p}=(\Gamma/\gamma-1)\ln\rho/\rho_0,
\end{equation}
and implies that
\begin{equation}
\ln c_{\rm s}^2/c_{\rm s0}^2=(\Gamma-1)\ln\rho/\rho_0.
\end{equation}

For hydrostatic equilibrium we require $\tilde{h}+\Phi=\tilde{h}_{\rm ext}$.
For gravity potentials that vanish at infinity, we can have
$\tilde{h}_{\rm ext}\neq0$, i.e.\ a finite pseudo enthalpy at infinity.
For $g_z=-1$ or $g_z=-{1\over2}z^2$, this is not the case, so we put
$\tilde{h}_{\rm ext}=0$, and therefore $\tilde{h}=-\Phi$.
Using $c_{\rm s}^2=(\gamma-1)h$ together with (\ref{hhtilde}) we find
\begin{equation}
c_{\rm s}^2=-{\gamma\over m+1}\,\Phi.
\end{equation}
In order that $\rho=\rho_0$ and $c_{\rm s}^2=c_{\rm s0}^2$ at
$z=z_{\rm ref}$, we have to choose
\begin{equation}\label{zinfty}
z_\infty=z_{\rm ref}+(m+1)c_{\rm s0}^2/(\gamma g_z).
\end{equation}

Thus, when using \var{initlnrho='polytropic\_simple'} we calculate
\begin{equation}
\ln c_{\rm s}^2/c_{\rm s0}^2
=\ln\left[-{\gamma\Phi\over(m+1)c_{\rm s0}^2}\right]
\end{equation}
and so the stratification is given by
\begin{equation}
\ln\rho/\rho_0=m
\ln c_{\rm s}^2/c_{\rm s0}^2,\quad
s/c_{\rm p}=\left({\Gamma\over\gamma}-1\right)
m\ln c_{\rm s}^2/c_{\rm s0}^2.
\end{equation}

\subsubsection{Changing the stratification}

Natural: measure length in units of $c_{\rm s0}^2/g_z$.
Can increase stratification by moving $z_{\rm top}$ close to $z_\infty$.
Disadvantage: in the limit of weak stratification, the box size will
be very small (in nondimensional units).

Box units: measure length in units of $d$.
Can increase stratification by increasing $g_z$ to
$g_{\max}$, which can be obtained by putting $z_{\rm top}=z_\infty$
in (\ref{zinfty}), so
\begin{equation}\label{zinfty}
g_{\max}={m+1\over\gamma}\,{c_{\rm s0}^2\over z_{\rm top}-z_{\rm ref}}.
\end{equation}
For $m=1$, $\gamma=5/3$, $z_{\rm top}=1$, and $z_{\rm ref}=0$, for
example, we have $g_{\max}=6/5=1.2$.

Gravitational box units: measure speed in units of $g_z/d$.
The limit of vanishing stratification corresponds to
$c_{\rm s0}\rightarrow\infty$. This seems optimal if we want
to approach the Boussinesq case.

% ====================================================================== %

\printindex
\

\vfill\bigskip\noindent{\footnotesize\it
$ $Id: manual.tex,v 1.44 2002-07-10 15:57:39 dobler Exp $ $}


\end{document}

%%% Please leave this for Emacs [wd]:

%% Local Variables:
%% ispell-check-comments: t
%% Local IspellDict: american
%% End:
% LocalWords:  SPH CVS tex wd MHD makeindex pdflatex MPI Dobler nonperiodic src
% LocalWords:  nonmagnetic nomagnetic IDL DX OpenDX csh Perl Perl Cygwin tgz mv
% LocalWords:  tarball unix somewhere cd gunzip xf mhd passwd CVSROOT cshrc sh
% LocalWords:  setenv cvs cvspass code's dP sourceme lnsrc mkdir tmp tmp struct
% LocalWords:  isotrop keepaspectratio spher gravz README cparam idl dx nograv
% LocalWords:  nohydro nodensity noentropy rhs noforcing rr noglobal fft FFT io
% LocalWords:  nofft dist mpicomm nompicomm DFUNDERSCORE nodebug mkfile var dat
% LocalWords:  interoperability rall bb aa jj Pvwave param nml param nml param
% LocalWords:  stdout oum zaver bxmz bymz nl timestr lp ip ip iper iperx ztop
% LocalWords:  hcond whcond mpoly isothtop ampl init urand cs nt dt cdt CFL bc
% LocalWords:  cdtv Alfv isave isave iorder iorder Kutta dsnap dsnap dvid dtmin
% LocalWords:  tinit tdamp dampu dampuext rdamp wdamp ivisc cdiffrho Fheat tvid
% LocalWords:  wcool iforce relhel tsnap hystrostatic isothermality initaa jbm
% LocalWords:  meshpoints jb mn rprint xy Compaq Mb resol linux magn noentro nq
% LocalWords:  ukaff jun sourcefile kbd env rm dfn MNRAS url html dobler Exp
