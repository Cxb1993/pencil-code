%%%%%%%%%%%%%%%%%%%%%%%%%            -*-LaTeX-*-
%%%   multigrid.tex   %%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Date:   21-Jun-2007
%% Author: wd (Wolfgang.Dobler@ucalgary.ca)
%% Description: 
%%   

%% Choose appropriate driver:
\RequirePackage{ifpdf}
\ifpdf
  \def\mydriver{pdftex}         % writing PDF
\else
  \def\mydriver{dvips}          % writing DVI
\fi

\documentclass[\mydriver,12pt,twoside,notitlepage]{article}

%\usepackage{german,a4}
%\usepackage[german,british]{babel}
\usepackage[utf8]{inputenc}
%\usepackage[T1]{fontenc}\usepackage{lmodern}
\usepackage[scaled]{helvet}
\renewcommand{\familydefault}{phv}

\usepackage{amsmath,amssymb,bm,wasysym}
%\usepackage{latexsym,exscale}%\usepackage{newcent,helvet}%\usepackage{pxfonts}%\usepackage{txfonts}
%\usepackage[it,footnotesize]{caption2}
%\setlength{\abovecaptionskip}{5pt} % Space before caption
%\setlength{\belowcaptionskip}{5pt} % Space after caption

%% Load titlesec before hyperref or \section links will be off with dvipdfm
\usepackage[bf,sf,small,nonindentfirst]{titlesec}
\newcommand{\sectionbreak}{\clearpage}
\newcommand{\subsectionbreak}{\clearpage}
%\titleformat{\subsubsection}{\normalfont\itshape}{\thesubsubsection}{.5em}{}
%\titlespacing{\subsubsection}{0pt}{*1}{*-1}

\usepackage{units}

\usepackage{booktabs}

\usepackage{graphicx,color}
\usepackage{multicol}
\usepackage{parskip}
\usepackage[paperwidth=20cm,paperheight=15cm,hmargin=20mm,top=15mm,bottom=15mm,twosideshift=5mm]{geometry}

\usepackage{fancyvrb}

\usepackage{makeidx}
\usepackage[bookmarksopen=true,bookmarksopenlevel=2]{hyperref} % should come late/last

\usepackage{natbib}
\bibpunct{(}{)}{;}{a}{,}{,}
\gdef\harvardand{\&}
%\usepackage[dcucite,abbr,round]{myharvard}
%% Supposed to be called *after* natbib:

\ifpdf
  \usepackage{pdfpages}
\else
  \newcommand{\includepdf}[2][]{%
%     \fbox{%
%       \vfill\\%
%       \centerline{#2}%
%       \vfill\\%
%       }%
    \centerline{%
      \fbox{%
        \parbox[c][0.5\textheight]{0.5\textwidth}{%
          \vspace*{\stretch{1}}%
          \hfill Include file \path{#2}\hfill\mbox{}%
          \vspace*{\stretch{2}}%
        }%
      }%
    }%
  }%
  \fi

%% Fancyvrb customizations
% \DefineShortVerb{\|}
\newcommand{\BoxLabel}[1]{\fbox{\rmfamily\emph{#1}}}
%% A customized verbatim environment
\DefineVerbatimEnvironment%
  {CodeVerbatim}%
  {Verbatim}%
  {frame=single,%
   framesep=10pt,%
   xleftmargin=4ex,%
   xrightmargin=4ex,%   
   commandchars=\\\{\},%
   gobble=2%
  }


\frenchspacing
\sloppy


%% Markup
\definecolor{DarkBlue}{rgb}{0,0,0.7}
\definecolor{DarkishRed}{rgb}{0.9,0,0}
\definecolor{DarkishBlue}{rgb}{0,0,0.9}
\definecolor{DarkishMagenta}{rgb}{0.8,0,0.8}
\definecolor{math}{rgb}{0,0.55,0}

\everymath{\color{math}}        % all math in green

\newcommand{\mathcol}[1]{\textcolor{math}{#1}}
\newcommand{\name}[1]   {\textcolor{name}{#1}}

\newcommand{\ColEmph}[1]{{\color{DarkishRed}#1}}
\newcommand{\colEmph}[1]{{\color{DarkishBlue}#1}}
\newcommand{\RedArrow}{\ensuremath{\ColEmph{\rightarrow}}}
\newcommand{\Code}[1]{{\color{DarkishMagenta}\texttt{#1}}}

%% Matrices and tensors
\newcommand{\matx}[1]{\mbox{\boldmath${\cal #1}$\unboldmath}}
\newcommand{\tensor}[1]{\matx{#1}}

%% Math macros
\newcommand{\Av}      {\mathbf{A}}

\newcommand{\bv}      {\mathbf{b}}
\newcommand{\Bv}      {\mathbf{B}}

\newcommand{\Courant} {\mathcal{C}}
\newcommand{\cv}      {\mathbf{c}}

\newcommand{\etav}    {\bm{\eta}}
\newcommand{\Ev}      {\mathbf{E}}

\newcommand{\fv}      {\mathbf{f}}

\newcommand{\gv}      {\mathbf{g}}

\newcommand{\jv}      {\mathbf{j}}

\newcommand{\kv}      {\mathbf{k}}

\newcommand{\Laplace} { \mathop{\Delta}\nolimits}

\newcommand{\mtildei} {\widetilde{m}_{\rm i}}

\newcommand{\uv}      {\mathbf{u}}
\newcommand{\uve}     {\uv_{\rm e}}
\newcommand{\uvi}     {\uv_{\rm i}}

\newcommand{\vv}      {\mathbf{v}}
\newcommand{\vve}     {\vv_{\rm e}}

\newcommand{\xv}{\mathbf{x}}

\newcommand{\yv}{\mathbf{y}}

% ---------------------------------------------------------------------- %

\title{Long Time Steps for the \textsc{Pencil Code}\\[1.5ex]
  {\large Implementing and testing Runge--Kutta--Chebyshev schemes\\
    for highly diffusive problems}
}
\author{Wolfgang Dobler}

% ---------------------------------------------------------------------- %

\begin{document}
\thispagestyle{empty}

\maketitle

\clearpage
\tableofcontents
\clearpage

%%%%%%%%
\section{Introduction: Runge--Kutta Schemes}
%%%%%%%%

%%%
\subsection{Classical explicit schemes}
Explicit $s$-stage Runge--Kutta scheme:
\begin{align}
  \tau_1 &= t_0 \; ,
            & \etav_1 &= \yv_0 \; ,
                         & \kv_1 &= h\fv(\tau_1, \etav_1) \; ,\\
  \tau_2 &= t_0 + c_2 h \; ,
            & \etav_2 &= \yv_0 + a_{21} \kv_1 \; ,
                         & \kv_2 &= h\fv(\tau_2, \etav_2) \; ,\\
  \tau_3 &= t_0 + c_3 h \; ,
            & \etav_3 &= \yv_0 + a_{31} \kv_1 + a_{32} \kv_2 \; ,
                         & \kv_3 &= h\fv(\tau_3, \etav_3) \; ,\\
  & \vdots &  & \vdots  &  &\vdots \nonumber \\
  \tau_s &= t_0 + c_s h \; ,
            & \etav_s &= \yv_0 + a_{s1} \kv_1 + a_{s2} \kv_2
             + \ldots + a_{s,s-1} \kv_{s-1} \; ,
                              & \kv_s &= h\fv(\tau_s, \etav_s) \; ,\\
  t_1 &= t_0 + h \; ,
            & \yv_1   &= \yv_0 + b_1 \kv_1 + b_2 \kv_2
                         + \ldots + b_{s-1} \kv_{s-1} + b_{s} \kv_{s} \; .
\end{align}


Butcher tableau:
\begin{equation}
  \begin{array}{c|c}
    \cv & \Av \\
    \hline
        & \bv^{\mathsf T}
  \end{array}
  \quad=\quad
  \begin{array}{c|ccccc}
    0                                                 \\
    c_2    & a_{21}                                   \\
    c_3    & a_{31} & a_{32}                          \\
    \vdots & \vdots &        & \ddots &               \\
    c_s    & a_{s1} & a_{s2} & \cdots & a_{s,s-1}     \\
    \hline
    (1)    & b_1    & b_2    & \cdots & b_{s-1} & b_s
  \end{array}
\end{equation}


\emph{Implicit} $s$-stage Runge--Kutta scheme:
\begin{equation}
  \begin{array}{c|ccccc}
    c_1    & a_{11} & a_{12} & a_{13} & \cdots & a_{1s} \\
    c_2    & a_{21} & a_{22} & a_{23} & \cdots & a_{2s} \\
    c_3    & a_{31} & a_{32} & a_{33} & \cdots & a_{3s} \\
    \vdots & \vdots &        &        & \ddots &        \\
    c_s    & a_{s1} & a_{s2} & a_{s3} & \cdots & a_{ss} \\
    \hline
    (1)    & b_1    & b_2    & b_3    & \cdots & b_s
  \end{array}
\end{equation}

Requires solution of nonlinear systems of equations in each substep,
\ColEmph{but}: desirable stability properties.

\clearpage

%%%
\subsection{Order conditions}

%
\paragraph{All schemes} typically satisfy
\begin{equation}
  \sum\limits_{j=1}^{s} a_{ij} = c_i \; .
\end{equation}
%
\paragraph{First-order} accuracy:
\begin{equation}
  \sum\limits_{i=1}^{s} b_{i} = 1 \; .  
\end{equation}

%
\paragraph{Second-order} accuracy additionally requires
\begin{equation}
  \sum\limits_{i=1}^{s} b_{i} c_i = \dfrac{1}{2} \; .  
\end{equation}

%
\paragraph{Third-order} accuracy additionally requires
\begin{equation}
  \sum\limits_{i=1}^{s} b_{i} c_i^2        = \dfrac{1}{3} \; ,
  \qquad
  \sum\limits_{i,j=1}^{s} b_{i} a_{ij} c_j = \dfrac{1}{6} \; .  
\end{equation}

%
\paragraph{Fourth-order} accuracy additionally requires
\begin{eqnarray}
  \sum\limits_{i=1}^{s} b_{i} c_i^3                  =  \dfrac{1}{4}
  \qquad
  \sum\limits_{i,j=1}^{s} b_{i} c_{i} a_{ij} c_j     =  \dfrac{1}{8}
  \qquad
  \sum\limits_{i,j=1}^{s} b_{i} a_{ij} c_j^2         =  \dfrac{1}{12}
  \qquad
  \sum\limits_{i,j,k=1}^{s} b_{i} a_{ij} a_{jk} c_k  =  \dfrac{1}{24} \; .  
\end{eqnarray}

\medskip
etc.
\medskip

Total number of conditions:
\begin{center}
  \begin{tabular}{lllllllllll}
  \toprule
    Order $p$  & 1 & 2 & 3 & 4 &  5 &  6 &  7 &   8 &  9  &   10\\
  \midrule
    Conditions & 1 & 2 & 4 & 8 & 17 & 37 & 85 & 200 & 486 & 1205\\
  \midrule
    Minimum number of stages & 1 & 2 & 3 & 4 & 6 & \\
  \bottomrule
  \end{tabular}
\end{center}


%%%
\subsection{$2N$-schemes}

Cassical schemes: need to store all $\kv_i$.

\medskip

\cite{Williamson:LowStorage}: schemes that only need one $\yv$ and one
$\kv$ array at a time (our \Code{f(:,:,:,1:mvar)} and \Code{df(:,:,:,:)}).

\medskip

\begin{center}
  \begin{tabular}{lllllllllll}
  \toprule
    Order $p$  & 1 & 2 & 3 & 4 & ??? \\
  \midrule
    Minimum number of stages & 1 & 2 & 3 & 5 & ??? & \\
  \bottomrule
  \end{tabular}
\end{center}

In a sense, we trade order for memory-efficiency.

%%%
\subsection{Linear Stability}

Linear stability analysis for diffusion equation
\begin{equation}
  \dfrac{\partial f}{\partial t}
  = \nu \Laplace f
\end{equation}
leads to
\begin{equation}
  \dfrac{df}{dt} = - \nu k^2 \,f
\end{equation}
($k \simeq 1/\delta x$: an effective wave number for most
unstable Fourier mode (normally the Nyquist mode).

Exact solution:
\begin{equation}
  \dfrac{f(t)}{f(0)} = e^{-\nu k^2 t}
\end{equation}

One (full) time step of a time-stepping scheme gives
\begin{equation}
  \dfrac{f(\delta t)}{f(0)} = A
  \quad\text{(amplitude factor)}
\end{equation}

\begin{equation*}
  \text{For} \quad
  \begin{cases}
    |A| < 1 &: \text{scheme is stable} \; , \\
    |A| > 1 &: \text{scheme is unstable} \; . \\
  \end{cases}
\end{equation*}

Courant number: $\Courant \equiv \delta t \, \nu k^2$ (dimensionless time step). 

\clearpage

\begin{tabular}{@{}ll}
  Exact:                           & $A(\Courant) = \exp(-\Courant)$\\[1.5ex]
  Explicit Runge--Kutta:           &  $A(\Courant)$ is a polynomial.\\[1.5ex]
  General (implicit) Runge--Kutta: & $A(\Courant)$ is rational function\\{}
                                     [Pad√© approx. to $\exp(-\Courant)$].
\end{tabular}

\bigskip

[image: stability function]

Higher-order explicit schemes $\RedArrow$ larger stability interval

But: also more substeps, so effort per time step is roughly constant.

% ---------------------------------------------------------------------- %

%%%%%%%%
\section{Runge--Kutta--Chebyshev schemes}
%%%%%%%%

We can do better \ldots{}
Sounds familiar? $\rightarrow$ Chebyshev

$\rightarrow$ RKC-1 stability polynomial
-- but that's no scheme yet.


% ---------------------------------------------------------------------- %

%%%%%%%%
\section{Example}
%%%%%%%%

Kinematic $\alpha^2$-dynamo:

$\alpha=\mathrm{const.}$ in a sphere $r<1$,
\qquad
$\eta = \begin{cases}
    1 & \text{for $r<1$} \; , \\
    8 & \text{for $r>1$}\\
  \end{cases}$

\medskip

{\small\color{DarkBlue}
\begin{CodeVerbatim}[label=\BoxLabel{run.in}]
  &run_pars
    ! For eta_ext=8, stability limits are
    !   itorder=3:  dt_eta=1.69e-5
    !   RKC-40:     dt_eta=7.03e-3
    dt=3.5e-3, tmax=2.0
  /
  &magnetic_run_pars
    iresistivity='shell', wresistivity=0.03,
    eta=1.0, eta_ext=8.0
    ! For eta=1.0, eta_ext=4.0, critical alpha_effect is around 11.3
    lmeanfield_theory=T, alpha_effect=15, alpha_quenching=0.
    alpha_profile='const', lweyl_gauge=T
  /
\end{CodeVerbatim}
}

[Resolution + geometry\ldots]

% ---------------------------------------------------------------------- %

%%%
\subsection{Comparison}
\begin{enumerate}
\item Standard 3rd-order Runge--Kutta scheme (Williamson)\\
  \texttt{dt=7.00e-6}
\item RKC-20\\
  \texttt{dt=4.375e-4}
\item RKC-40\\
  \texttt{dt=3.50e-3}
\end{enumerate}
(each at $\approx 1/2\,\delta t_{\rm max}$).

Speed:
\begin{enumerate}
\item $\unit[71.9]{\mu s}$ per step + grid pt   
  (at 98.7\%)
  \RedArrow $\unit[0.021]{\mu s}$ per step + time unit
\item $\unit[35.0]{\mu s}$ per step + grid pt
  (at 98.7\%)
  \RedArrow $\unit[0.080]{\mu s}$ per step + time unit
\item $\unit[4.77]{\mu s}$ per step + grid pt
  (at 98.2\%)
  \RedArrow $\unit[0.68]{\mu s}$ per step + time unit
\end{enumerate}
\bigskip

{\small\color{DarkBlue}
\begin{CodeVerbatim}[label=\BoxLabel{top}]
   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND           
  3693 wdobler   20   0  818m 196m 1916 R   99 10.4  21:30.87 run.x              
  3741 wdobler   20   0  697m  96m 1900 R   95  5.1  18:22.56 run.x              
\end{CodeVerbatim}
}


[Growth rate changed from 53.62 (RK-40) to 53.74 (RK-20)]


% ---------------------------------------------------------------------- %

\bibliography{numerik}
\bibliographystyle{my-dcu}


\end{document}

% End of file multigrid.tex

%%% Please leave this for Emacs [wd]:

%% Local Variables:
%% ispell-check-comments: t
%% Local IspellDict: canadian
%% End:

% LocalWords:  ifpdf pdftex dvips
